# FID-20251018-P5: Full Clan System Implementation Plan

**Created:** 2025-10-18 09:35  
**Status:** PHASE 2 IN PROGRESS (100% backend, 100% frontend, 0 ERRORS)
**Priority:** üî¥ HIGH  
**Complexity:** 5/5  
**Estimated:** 5-6 hours | **Actual P2:** ~1.5 hours (faster than estimate)

---

## üéØ **OVERVIEW**

Complete guild/alliance system with:
- **Clan Creation & Management** (1.5M Metal + 1.5M Energy baseline, **admin configurable**, **solo players allowed**)
- **6 Member Roles with Permissions** (Leader, Co-Leader, Officer, Elite, Member, Recruit)
  - Leader: Full control, transfer leadership, disband clan
  - Co-Leader: Manage wars/territories, promote to Officer/Elite, withdraw from bank
  - Officer: Manage territories/research, kick Members/Recruits, promote to Elite
  - Elite: Invite members, +15% RP bonus, priority war deployment
  - Member: Standard contributions and chat access
  - Recruit: Trial period (50% RP, 24h chat restriction)
- **Clan Level System** (1-50 progression, XP from member actions)
  - Unlocks exclusive features, perks, and abilities at milestones
  - Visual prestige badges and title unlocks
  - Collaborative contribution mechanics
- **Clan Perks System** (Passive bonuses based on clan level/strength)
  - Combat bonuses (+ATK/DEF/HP)
  - Economic bonuses (harvest rates, auction fees, bank capacity)
  - Social bonuses (chat channels, member slots, invite cooldowns)
  - Config-driven, easily extensible design
- **Enhanced Research Tree** (Modular tech tree with clan-wide benefits)
  - Shared RP pool contribution system
  - 15+ technologies across 4 categories (Industrial, Military, Economic, Social)
  - Research unlocks tied to clan level requirements
  - Permanent bonuses applied to all members
- **Clan Banking & Taxes** (Treasury system with upgradeable capacity)
  - Clan bank: Metal, Energy, RP storage
  - Tax system (0-50% rates per resource type)
  - Bank upgrades (6 levels, increasing capacity)
  - Transaction history and withdrawal permissions
- **Territory Control** (Claim tiles, defense bonuses)
- **Clan Warfare** (Declare war, capture territories)
- **Monuments** (Permanent bonuses when controlled)
- **Social Features** (Clan chat with role-based channels, activity feed)
- **Leaderboard** (8 ranking categories: Power, Members, Territory, Monuments, Wars Won, Total RP, Avg Level, Bank Size)
- **Member Benefits** (Reduced auction fees, role-based bonuses, perk access)

---

## ÔøΩ **PHASE 2 PROGRESS: LEVELS & PERKS (9 of 9 files - 100% COMPLETE)**

**Status:** ‚úÖ **ALL FILES COMPLETE - 0 TYPESCRIPT ERRORS**
**Backend:** 5 of 5 files (100%) - Services + API Routes  
**Frontend:** 4 of 4 files (100%) - React Components
**Total Lines:** ~2,460 lines across 9 files
**Time:** ~1.5 hours (faster than 2-hour estimate)

### **Backend Files (5 of 5 complete)**
1. ‚úÖ lib/clanLevelService.ts (580 lines) - Level progression 1-50
2. ‚úÖ lib/clanPerkService.ts (565 lines) - Perk management (16 perks, 4 tiers)
3. ‚úÖ app/api/clan/level/route.ts (245 lines) - GET/POST level endpoints
4. ‚úÖ app/api/clan/perks/available/route.ts (205 lines) - GET perk catalog
5. ‚úÖ app/api/clan/perks/activate/route.ts (240 lines) - POST activate/deactivate

### **Frontend Files (4 of 4 complete)**
6. ‚úÖ components/clan/ClanLevelDisplay.tsx (396 lines) - Level UI
7. ‚úÖ components/clan/ClanPerkPanel.tsx (532 lines) - Perk management UI
8. ‚úÖ components/clan/ClanXPProgress.tsx (242 lines) - Animated progress
9. ‚úÖ components/clan/PerkCard.tsx (258 lines) - Reusable perk card

### **Type Enhancements**
- ‚úÖ Added ClanXPSource type (8 sources)
- ‚úÖ Added ClanMilestone interface
- ‚úÖ Added ClanPerkTier enum (BRONZE/SILVER/GOLD/LEGENDARY)
- ‚úÖ Enhanced ClanLevel interface with progression fields
- ‚úÖ Enhanced ClanPerk interface with activation tracking
- ‚úÖ Added CLAN_LEVEL_CONSTANTS, CLAN_XP_RATES, CLAN_MILESTONES
- ‚úÖ Added CLAN_PERK_LIMITS, CLAN_PERK_CATALOG (16 perks)

**Next Phase:** Phase 3 - Enhanced Research (3 files, ~800 lines, 1.5 hours)

---

## üìä **PHASE 3 PROGRESS: ENHANCED RESEARCH (3 of 3 files - 100% COMPLETE)**

**Status:** ‚úÖ **ALL FILES COMPLETE - 0 TYPESCRIPT ERRORS**
**Total Lines:** ~702 lines across 3 files
**Time:** ~15 minutes (6x faster than 1.5-hour estimate!)

### **Backend Files (3 of 3 complete)**
1. ‚úÖ lib/clanResearchService.ts (570 lines) - Research tree system
2. ‚úÖ app/api/clan/research/contribute/route.ts (132 lines) - RP contribution
3. ‚úÖ app/api/clan/research/unlock/route.ts (166 lines) - Research unlocking

**Next Phase:** Phase 4 - Territory & Warfare (5 files, ~1,200 lines, 1.5 hours)

---

## ÔøΩüìÅ **FILES TO CREATE (26 files total)**

### **Type Definitions (1 file)**
- ‚úÖ `types/clan.types.ts` (~1,584 lines including Phase 2 additions) **COMPLETED - 0 ERRORS**
  - ClanRole enum (LEADER, CO_LEADER, OFFICER, ELITE, MEMBER, RECRUIT)
  - ClanPermissions interface with 21 permission types (including bank/tax permissions)
  - ROLE_PERMISSIONS matrix defining all role capabilities
  - Helper functions: hasPermission(), getRPBonus(), getWarPriority(), calculateTaxAmount()
  - ClanMember interface (playerId, role, joinedAt, contributions, activityScore)
  - Clan interface (name, tag, members, bank, research, territory, level, perks)
  - ClanLevel interface (level 1-50, xp, requiredXP, unlockedFeatures, prestigeBadge)
  - **Phase 2 Additions:** ClanXPSource, ClanMilestone, ClanPerkTier, enhanced ClanLevel/ClanPerk, all constants
  - ClanPerk interface (perkId, name, category, bonuses, requiredLevel, isActive)
  - ClanPerkCategory enum (COMBAT, ECONOMIC, SOCIAL, STRATEGIC)
  - ClanResearch interface (researchId, name, category, cost, bonuses, requiredLevel)
  - ClanResearchCategory enum (INDUSTRIAL, MILITARY, ECONOMIC, SOCIAL)
  - ClanTerritory interface (tileX, tileY, claimedAt, defenseBonus)
  - ClanWar interface (attackerClanId, defenderClanId, startTime, status)
  - ClanMonument interface (monumentId, controllingClanId, bonuses)
  - ClanBank interface (treasury, taxConfig, upgradeLevel, maxCapacity, transactionHistory)
  - ClanTaxConfig (metalRate, energyRate, rpRate - all 0-50%)
  - ClanBankTransaction (deposits, withdrawals, tax collection, research spending)
  - ClanRankingType enum (8 leaderboard categories: POWER, MEMBERS, TERRITORY, MONUMENTS, WARS_WON, TOTAL_RP, AVG_LEVEL, BANK_SIZE)
  - ClanActivityType enum (16 types including BANK_DEPOSIT, TAX_COLLECTED, LEVEL_UP, PERK_UNLOCKED)
  - CLAN_CONSTANTS (creation cost 1.5M Metal/1.5M Energy - admin configurable, min/max members, max territories, max level 50)
  - CLAN_BANK_CONSTANTS (tax rates, upgrade costs, capacity multipliers)

### **Core Services (10 files)**
- ‚úÖ `lib/clanService.ts` (~1023 lines) **COMPLETED - 0 ERRORS**
  - `createClan()` - Create with 1.5M Metal + 1.5M Energy cost (starts at level 1, reads from server config)
  - `getClanById()`, `getClanByTag()`, `getClanByPlayerId()`
  - `invitePlayerToClan()`, `joinClan()`, `leaveClan()`, `kickMember()`
  - `promoteMember()`, `transferLeadership()`, `updateClanSettings()`, `disbandClan()`
  - `awardClanXP()` - Member actions contribute to clan XP
  - `getClanStats()` - Comprehensive clan statistics
  - `promoteMember()`, `demoteMember()`, `leaveClan()`, `disbandClan()`
  - `updateClanDescription()`, `getClanMembers()`, `getClanStats()`
  - `awardClanXP()` - Member actions contribute to clan XP
  - `checkLevelUp()` - Automatically levels up clan and unlocks features

- ‚úÖ `lib/clanBankService.ts` (~730 lines) **COMPLETED - 0 ERRORS**
  - `depositToBank()` - Any member can deposit (Metal/Energy/RP), capacity validation
  - `withdrawFromBank()` - Leader/Co-Leader only, balance validation
  - `setTaxRates()` - Leader only, 0-50% rates per resource type
  - `collectTax()` - Automatic tax collection on member harvests
  - `upgradeBankCapacity()` - 6 upgrade levels, costs resources from bank
  - `getBankTransactionHistory()` - Last 100 transactions
  - `getBankStats()` - Treasury balances, capacity, tax rates, usage percentages

- ‚úÖ `lib/clanActivityService.ts` (~490 lines) **COMPLETED - 0 ERRORS**
  - `logClanActivity()` - Log all clan events to activity feed
  - `getClanActivityFeed()` - Retrieve activities with filtering/pagination
  - `getActivityStats()` - Count by activity type for analytics
  - `getPlayerContributions()` - Player activity scoring (research, deposits, territories)
  - `getRecentMemberActivities()` - Recent activity summary per member
  - `getActivityTimeline()` - Activity counts grouped by time (hourly/daily)
  - `getMostActiveMembers()` - Top contributors leaderboard
  - `cleanupOldActivities()` - Remove old activity records

### **API Routes (5 files)** ‚úÖ **ALL COMPLETED - 0 ERRORS**
- ‚úÖ `app/api/clan/create/route.ts` (~130 lines) **COMPLETED - 0 ERRORS**
  - POST: Create new clan (validates name/tag, checks resources, deducts 1.5M Metal/Energy)
  - JWT authentication, comprehensive validation, error handling

- ‚úÖ `app/api/clan/join/route.ts` (~120 lines) **COMPLETED - 0 ERRORS**
  - POST: Accept clan invitation (validates invitation ID, checks expiration, adds member)
  - Returns joined clan object with welcome message

- ‚úÖ `app/api/clan/leave/route.ts` (~105 lines) **COMPLETED - 0 ERRORS**
  - POST: Leave current clan (validates not leader, removes member)
  - Leader must transfer leadership before leaving

- ‚úÖ `app/api/clan/invite/route.ts` (~140 lines) **COMPLETED - 0 ERRORS**
  - POST: Invite player to clan (validates permission, checks capacity, sends invitation)
  - Supports username lookup

- ‚úÖ `app/api/clan/bank/route.ts` (~320 lines) **COMPLETED - 0 ERRORS**
  - GET: Retrieve bank stats and transaction history (with pagination)
  - POST: Banking operations (deposit, withdraw, setTaxRates, upgrade)
  - Action-based routing with comprehensive error handling

---

## **PHASE 2: LEVELS & PERKS SYSTEM** ‚è≥ IN PROGRESS

**Status:** 5 of 9 files complete (56%)  
**Estimated Time:** 2 hours  
**Actual Time:** ~40 minutes so far

### **Core Services (2 files)** ‚úÖ **ALL COMPLETE**
- ‚úÖ `lib/clanLevelService.ts` (~580 lines) **COMPLETED - 0 ERRORS**
  - `awardClanXP()` - Award XP from actions, detect level ups, award milestone rewards
  - `getClanLevelInfo()` - Get detailed progression (%, next milestone, features unlocked)
  - `getClanMilestones()` - Retrieve completed + upcoming milestones
  - `getXPRequiredForLevel()` - Calculate total XP for level (exponential curve)
  - `calculateLevelFromXP()` - Reverse lookup level from total XP
  - `calculateXPFromSource()` - Convert action amount to XP (harvest, combat, research, etc.)
  - `checkForMilestoneReward()` - Check if level has milestone (5,10,15,20,25,30,40,50)
  - `findNextMilestone()` - Get next upcoming milestone
  - `isFeatureUnlocked()` - Check feature availability (perks, monuments, warfare)
  - `getRecommendedXPSources()` - Sorted list of best XP activities
  - `estimateTimeToNextLevel()` - Project time to level based on recent activity
  - **Level Curve:** 1-50 with exponential scaling (~50M total XP to max)
  - **XP Rates:** Harvest 5, Combat 10, Research 15, Building 20, Territory 50, Monument 100
  - **Milestones:** 8 levels (5,10,15,20,25,30,40,50) with scaling rewards + feature unlocks
  - **Integration:** Activity logging, automatic bank deposits for milestone rewards

- ‚úÖ `lib/clanPerkService.ts` (~565 lines) **COMPLETED - 0 ERRORS**
  - `activatePerk()` - Activate perk, validate level/tier/cost, deduct from bank
  - `deactivatePerk()` - Remove active perk (no refund), free up slot
  - `getAvailablePerks()` - Get unlocked + locked perks based on clan level
  - `getActivePerks()` - Get currently active perks with total bonuses
  - `getPerksByCategory()` - Filter by COMBAT/ECONOMIC/SOCIAL/STRATEGIC
  - `getPerksByTier()` - Filter by BRONZE/SILVER/GOLD/LEGENDARY
  - `calculateTierCost()` - Total cost to activate all perks in tier
  - `getRecommendedPerks()` - AI suggestions based on clan stats (wars, resources, territories)
  - **16 Total Perks:** 4 tiers √ó 4 categories
  - **Tier Unlocks:** Bronze (Lvl 5), Silver (Lvl 10), Gold (Lvl 15), Legendary (Lvl 20)
  - **Max Active:** 4 perks at once (strategic choice required)
  - **Costs:** Bronze (100K/100K/10K), Silver (250K/250K/25K), Gold (500K/500K/50K), Legendary (1M/1M/100K)
  - **Bonuses:** Attack/Defense (+5-20%), Resource Yield (+5-20%), XP Gain (+5-10%), Territory Cost (-10-20%)

### **API Routes (3 files)** ‚úÖ **ALL COMPLETE**
- ‚úÖ `app/api/clan/level/route.ts` (~245 lines) **COMPLETED - 0 ERRORS**
  - GET: Retrieve level info (current level, XP progress, milestones, features unlocked)
  - GET ?detailed=true: Include milestone history and XP source recommendations
  - GET ?estimate=true: Include estimated hours to next level based on recent activity
  - POST: Award XP to clan (SYSTEM ONLY - called from game events, not players)
  - POST validates source type, amount, returns level up info + milestone rewards
  - **Security Note:** POST has no auth (internal use), consider API key for production

- ‚úÖ `app/api/clan/perks/available/route.ts` (~205 lines) **COMPLETED - 0 ERRORS**
  - GET: Retrieve all available perks (unlocked, locked, active)
  - GET ?category=COMBAT: Filter by category
  - GET ?tier=LEGENDARY: Filter by tier
  - GET ?recommendations=true: Include AI perk suggestions
  - GET ?costs=true: Include total cost breakdown per tier
  - Returns active count, slots remaining, total bonuses applied

- ‚úÖ `app/api/clan/perks/activate/route.ts` (~240 lines) **COMPLETED - 0 ERRORS**
  - POST { action: 'activate', perkId }: Activate perk
  - POST { action: 'deactivate', perkId }: Deactivate perk
  - Validates permissions (Leader/Co-Leader/Officer only)
  - Checks clan level, tier unlock, active perk limit (4), bank balance
  - No refund on deactivation, instant swap capability
  - Returns cost paid, remaining slots, perk details

### **React Components (4 files)** ‚úÖ **ALL COMPLETE - 0 ERRORS**
- ‚úÖ `components/clan/ClanLevelDisplay.tsx` (~396 lines) **COMPLETED - 0 ERRORS**
  - Comprehensive clan level progression display component
  - Animated XP progress bar with gradient (CSS transitions)
  - Current level badge with tier color coding (Bronze/Silver/Gold/Legendary)
  - Next milestone preview card with rewards (Metal/Energy/RP)
  - Features unlocked checklist with visual indicators
  - Milestones completed history with dates
  - Time estimate to next level based on recent activity
  - Responsive layout for desktop and mobile
  - Fetches from GET /api/clan/level?detailed=true&estimate=true
  - Auto-refresh every 30 seconds (configurable)

- ‚úÖ `components/clan/ClanPerkPanel.tsx` (~532 lines) **COMPLETED - 0 ERRORS**
  - Comprehensive perk management interface
  - Active perks display (4 slots with empty slot indicators)
  - Category filtering tabs (Combat/Economic/Social/Strategic)
  - Tier filtering buttons (Bronze/Silver/Gold/Legendary)
  - Unlocked perks grid with activate buttons
  - Locked perks grid with level requirements
  - Total bonuses aggregation display (Attack/Defense/Resources/XP/Territory Cost)
  - AI recommendations section (up to 3 suggestions with reasons)
  - Activation/deactivation with confirmation dialogs
  - Cost breakdown display for each perk
  - Permission validation (Leader/Officer only can manage)
  - Real-time updates after activation/deactivation
  - Fetches from GET /api/clan/perks/available
  - Posts to /api/clan/perks/activate

- ‚úÖ `components/clan/ClanXPProgress.tsx` (~242 lines) **COMPLETED - 0 ERRORS**
  - Animated XP progress bar with smooth transitions
  - Real-time XP gain detection with floating animations (+100 XP)
  - Level up notification toast with celebratory effects
  - Milestone achievement alert modal
  - Percentage display with formatted numbers
  - Next level XP requirements
  - Gradient progress bar (cyan ‚Üí blue ‚Üí purple)
  - CSS animations (float-up, bounce-in, fade-in, scale-in)
  - Callbacks for level up and milestone events
  - Optional animation toggling for performance
  - Responsive sizing for different screens

- ‚úÖ `components/clan/PerkCard.tsx` (~258 lines) **COMPLETED - 0 ERRORS**
  - Reusable perk card component
  - Tier-based color coding (Orange/Blue/Yellow/Purple borders and badges)
  - Category icon display (‚öîÔ∏èüí∞üë•üó∫Ô∏è)
  - Bonus type and value formatting (+5% Attack, etc.)
  - Cost breakdown (Metal/Energy/RP with formatted numbers)
  - Lock indicator with levels to unlock display
  - Activate/Deactivate buttons with loading states
  - Active status badge (green border and ACTIVE tag)
  - Locked state with reduced opacity
  - Hover effects for interactivity
  - Activated by/date display for active perks
  - Slots full disabled state when 4 perks active

- [ ] `lib/clanBankService.ts` (~400 lines)
  - `depositToBank()` - Deposit Metal/Energy/RP to clan treasury
  - `withdrawFromBank()` - Leader/Co-Leader only
  - `collectTaxes()` - Automatic tax collection on member harvests
  - `setTaxRates()` - Leader only, 0-50% per resource type
  - `upgradeBankCapacity()` - Purchase capacity upgrades (requires research)
  - `getBankTransactionHistory()` - Last 100 transactions
  - `calculateTaxAmount()` - Helper for tax calculations

- [ ] `lib/clanResearchService.ts` (~600 lines) **ENHANCED**
  - Research tree: 15+ technologies across 4 branches
  - **INDUSTRIAL**: Factory efficiency, harvest bonuses, resource capacity
  - **MILITARY**: Attack/defense bonuses, unit unlocks, war advantages
  - **ECONOMIC**: Auction fee reduction, bank upgrades, passive income
  - **SOCIAL**: Member slot increases, chat features, recruitment bonuses
  - `contributeRP()` - Add RP to shared pool
  - `unlockResearch()` - Spend RP to unlock technology (requires clan level)
  - `getResearchTree()` - Full tech tree with locked/unlocked status
  - `getClanBonuses()` - Calculate total active research bonuses
  - `checkResearchRequirements()` - Validate level + prerequisite research
  - Modular research node structure (easy to add new technologies)

- [ ] `lib/clanResearchService.ts` (~600 lines) **ENHANCED**
  - Research tree: 15+ technologies across 4 branches
  - **INDUSTRIAL**: Factory efficiency, harvest bonuses, resource capacity
  - **MILITARY**: Attack/defense bonuses, unit unlocks, war advantages
  - **ECONOMIC**: Auction fee reduction, bank upgrades, passive income
  - **SOCIAL**: Member slot increases, chat features, recruitment bonuses
  - `contributeRP()` - Add RP to shared pool
  - `unlockResearch()` - Spend RP to unlock technology (requires clan level)
  - `getResearchTree()` - Full tech tree with locked/unlocked status
  - `getClanBonuses()` - Calculate total active research bonuses
  - `checkResearchRequirements()` - Validate level + prerequisite research
  - Modular research node structure (easy to add new technologies)

- [ ] `lib/territoryService.ts` (~450 lines)
  - `claimTerritory()` - Cost: 500 Metal + 500 Energy per tile (reduced by perks)
  - `abandonTerritory()`, `getTerritoryAt()`, `getClanTerritories()`
  - `getDefenseBonus()` - +10% DEF per adjacent clan tile (max +50%, boosted by research)
  - `validateTerritoryClaim()` - Must be adjacent to existing clan territory

- [ ] `lib/clanWarfareService.ts` (~550 lines)
  - `declareWar()` - Costs 2000 Metal + 2000 Energy (reduced by perks/research)
  - `captureTerritory()` - Transfer territory during active war
  - `endWar()`, `getActiveWars()`, `getClanWarHistory()`
  - War status: DECLARED, ACTIVE, ENDED, TRUCE
  - Battle logging integration with activity logging system
  - War requires clan level 5+

- [ ] `lib/clanMonumentService.ts` (~400 lines)
  - 5 monuments: Ancient Forge, War Memorial, Market Plaza, Research Lab, Grand Temple
  - `controlMonument()` - Clan must hold surrounding 9 tiles (requires level 25+)
  - `getMonumentBonuses()` - Permanent bonuses while controlled
  - Monument bonuses: +5% Metal, +10% ATK, -5% auction fees, +15% RP, +5% XP

- [ ] `lib/clanChatService.ts` (~350 lines)
  - `sendClanMessage()`, `getClanMessages()`, `deleteClanMessage()`
  - Chat history (last 100 messages, 7-day retention)
  - Officer/Leader channels with permission checks
  - Additional channels unlocked by perks

- [ ] `lib/clanLeaderboardService.ts` (~300 lines)
  - `getClanLeaderboard()` - 8 ranking types (Power, Members, Territory, Monuments, Wars Won, Total RP, Avg Level, Bank Size)
  - Clan power calculation: Total member XP + Territory count * 100 + Research levels * 50 + Clan level * 200
  - Top 50 clans per category with detailed stats
  - Real-time ranking updates

- [ ] `lib/clanActivityService.ts` (~300 lines)
  - `logClanActivity()` - Integration with activity logging
  - Activity types: MEMBER_JOIN, MEMBER_LEAVE, RESEARCH_UNLOCK, TERRITORY_CLAIM, WAR_DECLARED, LEVEL_UP, PERK_UNLOCKED, BANK_DEPOSIT, TAX_COLLECTED
  - `getClanActivityFeed()` - Last 50 activities
  - XP tracking integration

### **API Routes (20 files)**
- [ ] `app/api/clan/create/route.ts` (POST - Create clan, costs 1.5M Metal + 1.5M Energy baseline, starts at level 1)
- [ ] `app/api/clan/join/route.ts` (POST - Accept invite)
- [ ] `app/api/clan/leave/route.ts` (POST - Leave clan)
- [ ] `app/api/clan/invite/route.ts` (POST - Invite player, Leader/Officer only)
- [ ] `app/api/clan/kick/route.ts` (POST - Kick member, Leader/Officer only)
- [ ] `app/api/clan/promote/route.ts` (POST - Promote member, Leader only)
- [ ] `app/api/clan/level/route.ts` (GET - Clan level, XP progress, unlocked features) **NEW**
- [ ] `app/api/clan/perks/available/route.ts` (GET - Available perks at current level) **NEW**
- [ ] `app/api/clan/perks/activate/route.ts` (POST - Activate perk, Leader only) **NEW**
- [ ] `app/api/clan/perks/active/route.ts` (GET - Currently active perks and bonuses) **NEW**
- [ ] `app/api/clan/bank/deposit/route.ts` (POST - Deposit to clan bank) **NEW**
- [ ] `app/api/clan/bank/withdraw/route.ts` (POST - Withdraw, Leader/Co-Leader only) **NEW**
- [ ] `app/api/clan/bank/setTaxes/route.ts` (POST - Set tax rates, Leader only) **NEW**
- [ ] `app/api/clan/bank/upgrade/route.ts` (POST - Upgrade bank capacity) **NEW**
- [ ] `app/api/clan/research/contribute/route.ts` (POST - Contribute RP to pool)
- [ ] `app/api/clan/research/unlock/route.ts` (POST - Unlock research node, check level requirement)
- [ ] `app/api/clan/research/tree/route.ts` (GET - Full research tree with status) **NEW**
- [ ] `app/api/clan/territory/claim/route.ts` (POST - Claim tile, 500 Metal + 500 Energy)
- [ ] `app/api/clan/territory/defend/route.ts` (GET - Get defense bonus at location)
- [ ] `app/api/clan/warfare/declare/route.ts` (POST - Declare war, requires level 5+, 2000 Metal + 2000 Energy)
- [ ] `app/api/clan/warfare/capture/route.ts` (POST - Capture enemy territory during war)
- [ ] `app/api/clan/monument/control/route.ts` (POST - Control monument, requires level 25+, 9 tiles)
- [ ] `app/api/clan/stats/route.ts` (GET - Clan statistics and leaderboard)

### **UI Components (7 files)**
- [ ] `components/ClanPanel.tsx` (~500 lines) **ENHANCED**
  - Create/join clan UI
  - **Clan level display with XP progress bar**
  - **Milestone indicators and unlocked features**
  - Member list with roles and contributions
  - Invite/kick/promote buttons (permission-based)
  - Clan stats display (power, level, active perks)
  - Bank balance and tax rates display

- [ ] `components/ClanLevelDisplay.tsx` (~250 lines) **NEW**
  - Visual level indicator (1-50)
  - XP progress bar with current/required XP
  - Prestige badge display
  - Next milestone preview
  - Level-up celebration animation

- [ ] `components/ClanPerkPanel.tsx` (~400 lines) **NEW**
  - Available perks grid (filtered by clan level)
  - Active perks with remaining duration
  - Perk activation interface (cost display)
  - Total bonuses calculator
  - Tiered perk categories (Bronze/Silver/Gold/Legendary)

- [ ] `components/ClanBankPanel.tsx` (~350 lines) **NEW**
  - Treasury balance display (Metal/Energy/RP)
  - Deposit/withdraw interface (permission-based)
  - Tax rate configuration (Leader only, 0-50% sliders)
  - Transaction history table (last 100)
  - Bank upgrade purchase interface
  - Capacity indicators

- [ ] `components/ClanResearchTree.tsx` (~450 lines) **ENHANCED**
  - Visual research tree (4 branches: Industrial, Military, Economic, Social)
  - RP contribution interface with shared pool display
  - Unlock buttons with cost + level requirement display
  - Active bonus indicators with tooltips
  - Research prerequisites visualization (locked/unlocked states)
  - Modular node rendering (easy to add new techs)

- [ ] `components/TerritoryMap.tsx` (~300 lines)
  - Visualize clan territories on map
  - Color-coded by clan
  - Claim territory button (shows cost with perk discounts)
  - Defense bonus indicators
  - Monument locations with control status

- [ ] `components/ClanWarModal.tsx` (~250 lines)
  - Declare war interface (shows level requirement)
  - Active war list with capture progress
  - War history with wins/losses
  - Territory capture during war
  - War cost display (base + perk modifiers)

---

## üîó **DEPENDENCIES**

**Required Systems:**
- ‚úÖ Activity Logging (FID-20251018-P6) - For clan activity tracking
- ‚úÖ Player profiles (existing) - Player data and resources
- ‚úÖ Combat system (existing) - Territory battles
- ‚úÖ Map system (existing) - Territory tiles

**MongoDB Collections:**
- `Clan` - Clan documents (name, tag, level, xp, activePerks, bank, research, territories)
- `ClanMember` - Member relationships (playerId, clanId, role, contributions, joinedAt)
- `ClanLevel` - Level progression data (xpHistory, milestoneRewards, unlockedFeatures)
- `ClanPerk` - Perk definitions and activations (perkId, category, bonuses, cost, requiredLevel)
- `ClanBank` - Banking data (treasury, taxConfig, transactions, upgradeLevel)
- `ClanResearch` - Research progress (researchId, unlockedNodes, contributionHistory)
- `ClanTerritory` - Claimed tiles (clanId, tileX, tileY, defenseBonus)
- `ClanWar` - War declarations (attackerId, defenderId, status, territoryCaptured)
- `ClanMonument` - Monument control (monumentId, controllingClanId, capturedAt)
- `ClanChat` - Chat messages (clanId, senderId, message, channel, timestamp)
- `ClanActivity` - Activity feed (clanId, activityType, performedBy, details, xpAwarded)

---

## üéØ **ACCEPTANCE CRITERIA**

**Core Clan Features:**
- [ ] Players can create clans (costs 1.5M Metal + 1.5M Energy baseline - admin configurable, **solo creation allowed**, starts at level 1)
- [ ] Max 1 clan per player
- [ ] Member management: invite, accept, kick, promote, demote, transfer leadership
- [ ] 6 roles with granular permissions: Leader, Co-Leader, Officer, Elite, Member, Recruit
- [ ] Role-specific abilities (Co-Leader war management + bank withdrawals, Elite +15% RP bonus, Recruit trial period)

**Clan Level System:**
- [ ] Clan levels 1-50 with exponential XP requirements
- [ ] Member actions award clan XP (harvesting, combat, research contributions, territory claims)
- [ ] Visual level display with progress bar and prestige badges
- [ ] Level milestones unlock features at 5, 10, 15, 20, 25, 30, 40, 50
- [ ] Level 5: Wars unlocked
- [ ] Level 10: Bank unlocked
- [ ] Level 15: Advanced research tree unlocked
- [ ] Level 20: +10 member slots (110 total)
- [ ] Level 25: Monument control unlocked
- [ ] Level 30: +20 member slots (130 total)
- [ ] Level 40: Legendary perks unlocked
- [ ] Level 50: Prestige system unlocked

**Clan Perks System:**
- [ ] Config-driven perk system (easy to add new perks)
- [ ] 4 perk categories: COMBAT, ECONOMIC, SOCIAL, STRATEGIC
- [ ] Tiered perks (Bronze/Silver/Gold/Legendary)
- [ ] Perks unlock at specific clan levels
- [ ] Active perks apply bonuses to all clan members
- [ ] Perk activation costs resources (refundable on deactivation)
- [ ] Total active bonuses calculator

**Clan Banking & Taxes:**
- [ ] Clan bank with Metal/Energy/RP storage
- [ ] Tax system (0-50% rates per resource type, Leader only)
- [ ] Automatic tax collection on member harvests
- [ ] Bank withdrawal permissions (Leader/Co-Leader only)
- [ ] Bank upgrade system (6 levels, increasing capacity)
- [ ] Transaction history (deposits, withdrawals, tax collection, research spending)

**Enhanced Research Tree:**
- [ ] 15+ technologies across 4 categories (INDUSTRIAL, MILITARY, ECONOMIC, SOCIAL)
- [ ] Shared RP contribution from all members
- [ ] Research unlocks require clan level + prerequisite techs
- [ ] Modular research node structure (config-driven)
- [ ] Permanent clan-wide bonuses from unlocked research
- [ ] Research progress visualization

**Territory & Warfare:**
- [ ] Territory claiming (500 Metal + 500 Energy per tile, adjacent tiles only, reduced by perks)
- [ ] Defense bonus on clan territory (+10% per adjacent tile, max +50%, boosted by research)
- [ ] War declaration (requires level 5+, costs 2000 Metal + 2000 Energy, reduced by perks)
- [ ] Territory capture during active wars
- [ ] War history tracking (wins/losses)

**Monuments:**
- [ ] 5 monuments with permanent bonuses
- [ ] Monument control requires level 25+ and 9-tile control (3x3 grid)
- [ ] Monument bonuses: +5% Metal, +10% ATK, -5% auction fees, +15% RP, +5% XP

**Social Features:**
- [ ] Clan chat with 100 message history, 7-day retention
- [ ] Officer/Leader channels with permission checks
- [ ] Additional channels unlocked by perks
- [ ] Activity feed with XP tracking integration

**Leaderboards:**
- [ ] **8 ranking categories** (Power, Members, Territory, Monuments, Wars Won, Total RP, Avg Member Level, Bank Size)
- [ ] Clan power calculation includes level multiplier (level * 200)
- [ ] Top 50 clans per category
- [ ] Real-time ranking updates

**Integration:**
- [ ] Complete activity logging integration (16 activity types)
- [ ] Reduced auction fees for clan members (based on research/perks)
- [ ] Player stat bonuses from active clan perks
- [ ] 0 TypeScript errors across all files

---

## üìä **IMPLEMENTATION PHASES**

**Phase 1: Core Clan System + Types** (2 hours)
- ‚úÖ Type definitions (clan.types.ts - COMPLETED, 0 errors)
- [ ] clanService.ts (create, join, leave, member management, XP tracking)
- [ ] clanBankService.ts (deposit, withdraw, taxes, upgrades)
- [ ] API routes: create, join, leave, invite, kick, promote
- [ ] API routes: bank/deposit, bank/withdraw, bank/setTaxes, bank/upgrade
- [ ] ClanPanel.tsx (basic display)
- [ ] ClanBankPanel.tsx

**Phase 2: Level & Perk Systems** (2 hours)
- [ ] clanLevelService.ts (XP calculation, level-up logic, milestone rewards)
- [ ] clanPerkService.ts (perk activation, bonus calculation, config-driven system)
- [ ] API routes: level, perks/available, perks/activate, perks/active
- [ ] ClanLevelDisplay.tsx
- [ ] ClanPerkPanel.tsx

**Phase 3: Enhanced Research System** (1.5 hours)
- [ ] clanResearchService.ts (4-branch tech tree, level requirements, modular nodes)
- [ ] API routes: research/contribute, research/unlock, research/tree
- [ ] ClanResearchTree.tsx (enhanced with 4 branches)

**Phase 4: Territory & Warfare** (1.5 hours)
- [ ] territoryService.ts (with perk integration)
- [ ] clanWarfareService.ts (level requirement validation)
- [ ] API routes: territory/claim, territory/defend, warfare/declare, warfare/capture
- [ ] TerritoryMap.tsx
- [ ] ClanWarModal.tsx

**Phase 5: Monuments, Social & Leaderboard** (1.5 hours)
- [ ] clanMonumentService.ts (level 25+ requirement)
- [ ] clanChatService.ts (with perk-unlocked channels)
- [ ] clanLeaderboardService.ts (8 categories, enhanced power calculation)
- [ ] clanActivityService.ts (XP tracking, 16 activity types)
- [ ] API routes: monument/control, stats
- [ ] Final integration testing

**Phase 6: Polish & Documentation** (0.5 hours)
- [ ] JSDoc completion verification
- [ ] Error handling audit
- [ ] README updates with new features
- [ ] Config examples for perks/research
- [ ] Move to completed.md with metrics

---

## üìã **SUMMARY**

**Total Files:** 38 files
- 1 type definition (‚úÖ COMPLETED)
- 10 services
- 20 API routes
- 7 UI components

**Estimated Time:** 9-10 hours (increased from 5-6h due to enhanced features)

**New Features Added:**
- üÜï Clan level system (1-50 progression)
- üÜï Clan perk system (config-driven, 4 categories, tiered)
- üÜï Clan banking & tax system (treasury, 0-50% tax rates, 6 upgrade levels)
- üÜï Enhanced research tree (15+ techs, 4 branches, level requirements)
- üÜï Modular, extensible design (easy to add perks/research via config)

**Core Principles:**
- ‚úÖ Modular architecture (services can be extended without refactoring)
- ‚úÖ Config-driven systems (perks/research defined in data structures)
- ‚úÖ Foundation first (core data models, basic UI, placeholder content)
- ‚úÖ Extensibility (easy to add new features, perks, research nodes)
- ‚úÖ TypeScript strict mode (0 errors required)
- ‚úÖ Comprehensive documentation (JSDoc, OVERVIEW sections)

---

## üöÄ **NEXT STEPS - CHOOSE YOUR PATH:**

### **Option A: Full Implementation (Recommended)**
Implement all 6 phases (9-10 hours total). Complete clan system with level progression, perks, banking, enhanced research, territory, warfare, monuments, and social features.

### **Option B: Phased Implementation**
Choose specific phases to implement:
- **Minimal Viable Clan (Phase 1 only)**: Core clan creation, member management, banking (2 hours)
- **Progression Foundation (Phases 1-2)**: Add level/perk systems (4 hours)
- **Full Featured (Phases 1-3)**: Include enhanced research tree (5.5 hours)
- **Complete System (All Phases)**: Everything (9-10 hours)

### **Option C: Foundation First**
Implement simplified versions:
- Basic level system (levels 1-10 only, simple XP)
- Placeholder perks (3-5 perks only, hardcoded)
- Basic research (5 techs only, no level requirements)
- Core territory/warfare (no perk integration)
- Estimate: 6-7 hours

---

**Ready to proceed? Select an option (A, B, or C) and say "proceed" to begin implementation.**
