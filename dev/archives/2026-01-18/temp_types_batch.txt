@@@FILE:types/activityLog.types.ts@@@
/**
 * Activity Log Type Definitions
 * 
 * Created: 2025-10-18
 * 
 * OVERVIEW:
 * Comprehensive type definitions for the DarkFrame activity logging system.
 * Tracks all player actions across 9 categories with 30+ distinct action types.
 * Supports security auditing, analytics, and admin oversight with detailed metadata.
 * 
 * Features:
 * - 30+ action types across Auth, Movement, Resource, Combat, Factory, Unit, Shrine, Admin, System
 * - Security metadata (IP, User-Agent, execution time)
 * - Success/failure tracking with error details
 * - Query filtering by player, action type, date range
 * - Battle-specific logging for combat analytics
 */

// ============================================================================
// ENUMS - Action Categories and Types
// ============================================================================

/**
 * Primary categories for organizing action types
 */
export enum ActionCategory {
  AUTH = 'auth',
  MOVEMENT = 'movement',
  RESOURCE = 'resource',
  COMBAT = 'combat',
  FACTORY = 'factory',
  UNIT = 'unit',
  SHRINE = 'shrine',
  ADMIN = 'admin',
  SYSTEM = 'system',
  CLAN = 'clan',
  DISCOVERY = 'discovery',
  ACHIEVEMENT = 'achievement',
  AUCTION = 'auction',
  BANK = 'bank',
  SPECIALIZATION = 'specialization'
}

/**
 * Comprehensive action types covering all player activities
 * Organized by category for easy filtering and analytics
 */
export enum ActionType {
  // AUTH (5 types)
  LOGIN = 'login',
  LOGOUT = 'logout',
  REGISTER = 'register',
  PASSWORD_CHANGE = 'password_change',
  SESSION_REFRESH = 'session_refresh',
  
  // MOVEMENT (2 types)
  MOVE = 'move',
  TELEPORT = 'teleport',
  
  // RESOURCE (4 types)
  HARVEST_METAL = 'harvest_metal',
  HARVEST_ENERGY = 'harvest_energy',
  FORAGE_CAVE = 'forage_cave',
  FORAGE_FOREST = 'forage_forest',
  
  // COMBAT (6 types)
  ATTACK_PLAYER = 'attack_player',
  ATTACK_FACTORY = 'attack_factory',
  DEFEND_ATTACK = 'defend_attack',
  BATTLE_WIN = 'battle_win',
  BATTLE_LOSS = 'battle_loss',
  UNIT_DEATH = 'unit_death',
  
  // FACTORY (5 types)
  FACTORY_CLAIM = 'factory_claim',
  FACTORY_UPGRADE = 'factory_upgrade',
  FACTORY_PRODUCE = 'factory_produce',
  FACTORY_COLLECT = 'factory_collect',
  FACTORY_LOST = 'factory_lost',
  
  // UNIT (3 types)
  UNIT_BUILD = 'unit_build',
  UNIT_DISBAND = 'unit_disband',
  UNIT_UPGRADE = 'unit_upgrade',
  
  // SHRINE (3 types)
  SHRINE_VISIT = 'shrine_visit',
  SHRINE_BOOST = 'shrine_boost',
  SHRINE_COMPLETE = 'shrine_complete',
  
  // DISCOVERY (2 types)
  DISCOVERY_FOUND = 'discovery_found',
  DISCOVERY_VIEW = 'discovery_view',
  
  // ACHIEVEMENT (2 types)
  ACHIEVEMENT_UNLOCK = 'achievement_unlock',
  ACHIEVEMENT_VIEW = 'achievement_view',
  
  // AUCTION (5 types)
  AUCTION_CREATE = 'auction_create',
  AUCTION_BID = 'auction_bid',
  AUCTION_BUYOUT = 'auction_buyout',
  AUCTION_CANCEL = 'auction_cancel',
  AUCTION_COLLECT = 'auction_collect',
  
  // BANK (2 types)
  BANK_DEPOSIT = 'bank_deposit',
  BANK_WITHDRAW = 'bank_withdraw',
  
  // SPECIALIZATION (3 types)
  SPECIALIZATION_SELECT = 'specialization_select',
  SPECIALIZATION_RESPEC = 'specialization_respec',
  MASTERY_GAIN = 'mastery_gain',
  
  // CLAN (10 types)
  CLAN_CREATE = 'clan_create',
  CLAN_JOIN = 'clan_join',
  CLAN_LEAVE = 'clan_leave',
  CLAN_INVITE = 'clan_invite',
  CLAN_KICK = 'clan_kick',
  CLAN_PROMOTE = 'clan_promote',
  CLAN_RESEARCH = 'clan_research',
  CLAN_TERRITORY_CLAIM = 'clan_territory_claim',
  CLAN_WAR_DECLARE = 'clan_war_declare',
  CLAN_MONUMENT_CONTROL = 'clan_monument_control',
  
  // ADMIN (5 types)
  ADMIN_BAN = 'admin_ban',
  ADMIN_UNBAN = 'admin_unban',
  ADMIN_RESOURCE_MODIFY = 'admin_resource_modify',
  ADMIN_VIEW_LOGS = 'admin_view_logs',
  ADMIN_EXPORT_DATA = 'admin_export_data',
  
  // SYSTEM (3 types)
  ERROR = 'error',
  RATE_LIMIT = 'rate_limit',
  SECURITY_ALERT = 'security_alert'
}

/**
 * Battle outcome types for combat logging
 */
export enum BattleOutcome {
  ATTACKER_WIN = 'attacker_win',
  DEFENDER_WIN = 'defender_win',
  DRAW = 'draw'
}

/**
 * Battle types for categorizing combat
 */
export enum BattleType {
  PLAYER_VS_PLAYER = 'pvp',
  PLAYER_VS_FACTORY = 'pve_factory',
  CLAN_WAR = 'clan_war'
}

// ============================================================================
// INTERFACES - Core Data Structures
// ============================================================================

/**
 * Main activity log entry structure
 * Stored in MongoDB ActionLog collection
 */
export interface ActivityLog {
  _id?: string;
  
  // Player identification
  playerId: string;
  username: string;
  
  // Action details
  actionType: ActionType;
  category: ActionCategory;
  timestamp: Date;
  
  // Action-specific data (flexible object for various action types)
  details: Record<string, any>;
  
  // Outcome tracking
  success: boolean;
  errorMessage?: string;
  errorCode?: string;
  
  // Performance metrics
  executionTimeMs: number;
  
  // Security metadata
  ipAddress: string;
  userAgent: string;
  
  // Session tracking
  sessionId?: string;
  
  // Admin tracking (for admin actions)
  adminId?: string;
  adminUsername?: string;
}

/**
 * Battle log entry structure for detailed combat tracking
 * Stored in MongoDB BattleLog collection (enhances existing)
 */
export interface BattleLog {
  _id?: string;
  
  // Battle identification
  battleId: string;
  battleType: BattleType;
  timestamp: Date;
  
  // Participants
  attackerId: string;
  attackerUsername: string;
  defenderId: string;
  defenderUsername: string;
  
  // Location
  tileX: number;
  tileY: number;
  
  // Battle outcome
  outcome: BattleOutcome;
  winner: string;
  loser: string;
  
  // Combat details
  attackerUnits: UnitSnapshot[];
  defenderUnits: UnitSnapshot[];
  attackerSurvivors: UnitSnapshot[];
  defenderSurvivors: UnitSnapshot[];
  
  // Statistics
  attackerDamageDealt: number;
  defenderDamageDealt: number;
  attackerUnitsLost: number;
  defenderUnitsLost: number;
  totalDamage: number;
  battleDurationMs: number;
  
  // Resources
  resourcesLooted?: {
    metal: number;
    energy: number;
  };
  
  // Special conditions
  factoryId?: string; // If factory battle
  clanWarId?: string; // If clan war battle
  territoryId?: string; // If territory battle
  
  // Metadata
  attackerLevel: number;
  defenderLevel: number;
  attackerSpecialization?: string;
  defenderSpecialization?: string;
}

/**
 * Unit snapshot for battle logging
 * Captures unit state at time of battle
 */
export interface UnitSnapshot {
  unitType: string;
  quantity: number;
  strength: number;
  defense: number;
  health: number;
  tier: number;
}

/**
 * Activity log query parameters
 */
export interface ActivityLogQuery {
  playerId?: string;
  username?: string;
  actionType?: ActionType | ActionType[];
  category?: ActionCategory | ActionCategory[];
  startDate?: Date;
  endDate?: Date;
  success?: boolean;
  limit?: number;
  offset?: number;
  sortBy?: 'timestamp' | 'executionTimeMs';
  sortOrder?: 'asc' | 'desc';
}

/**
 * Battle log query parameters
 */
export interface BattleLogQuery {
  playerId?: string; // Matches attacker or defender
  battleType?: BattleType;
  outcome?: BattleOutcome;
  startDate?: Date;
  endDate?: Date;
  tileX?: number;
  tileY?: number;
  limit?: number;
  offset?: number;
}

/**
 * Activity log statistics response
 */
export interface ActivityLogStats {
  totalActions: number;
  actionsByCategory: Record<ActionCategory, number>;
  actionsByType: Record<ActionType, number>;
  successRate: number;
  averageExecutionTimeMs: number;
  uniquePlayers: number;
  dateRange: {
    earliest: Date;
    latest: Date;
  };
  topPlayers: Array<{
    playerId: string;
    username: string;
    actionCount: number;
  }>;
  errorRate: number;
  errorsByType: Record<string, number>;
}

/**
 * Battle log statistics response
 */
export interface BattleLogStats {
  totalBattles: number;
  battlesByType: Record<BattleType, number>;
  winRate: {
    attacker: number;
    defender: number;
    draw: number;
  };
  averageDamage: number;
  totalUnitsLost: number;
  mostActivePlayers: Array<{
    playerId: string;
    username: string;
    battlesParticipated: number;
    wins: number;
    losses: number;
  }>;
  deadliestUnits: Array<{
    unitType: string;
    totalDamageDealt: number;
    battlesUsed: number;
  }>;
}

/**
 * Log retention configuration
 */
export interface LogRetentionPolicy {
  activityLogDays: number; // Default: 90 days
  battleLogDays: number; // Default: 180 days
  adminLogDays: number; // Default: 365 days
  archiveEnabled: boolean;
  archiveLocation?: string;
}

/**
 * Middleware logging context
 */
export interface LoggingContext {
  startTime: number;
  playerId?: string;
  username?: string;
  sessionId?: string;
  ipAddress: string;
  userAgent: string;
  actionType?: ActionType;
  category?: ActionCategory;
  details?: Record<string, any>;
}

// ============================================================================
// TYPE GUARDS
// ============================================================================

/**
 * Type guard to check if action type belongs to combat category
 */
export function isCombatAction(actionType: ActionType): boolean {
  return [
    ActionType.ATTACK_PLAYER,
    ActionType.ATTACK_FACTORY,
    ActionType.DEFEND_ATTACK,
    ActionType.BATTLE_WIN,
    ActionType.BATTLE_LOSS,
    ActionType.UNIT_DEATH
  ].includes(actionType);
}

/**
 * Type guard to check if action type requires admin privileges
 */
export function isAdminAction(actionType: ActionType): boolean {
  return [
    ActionType.ADMIN_BAN,
    ActionType.ADMIN_UNBAN,
    ActionType.ADMIN_RESOURCE_MODIFY,
    ActionType.ADMIN_VIEW_LOGS,
    ActionType.ADMIN_EXPORT_DATA
  ].includes(actionType);
}

/**
 * Get category for action type
 */
export function getActionCategory(actionType: ActionType): ActionCategory {
  if (actionType.startsWith('login') || actionType.startsWith('register') || 
      actionType.startsWith('logout') || actionType.startsWith('password') || 
      actionType.startsWith('session')) {
    return ActionCategory.AUTH;
  }
  if (actionType.startsWith('move') || actionType.startsWith('teleport')) {
    return ActionCategory.MOVEMENT;
  }
  if (actionType.startsWith('harvest') || actionType.startsWith('forage')) {
    return ActionCategory.RESOURCE;
  }
  if (actionType.startsWith('attack') || actionType.startsWith('battle') || 
      actionType.startsWith('defend') || actionType.startsWith('unit_death')) {
    return ActionCategory.COMBAT;
  }
  if (actionType.startsWith('factory')) {
    return ActionCategory.FACTORY;
  }
  if (actionType.startsWith('unit_')) {
    return ActionCategory.UNIT;
  }
  if (actionType.startsWith('shrine')) {
    return ActionCategory.SHRINE;
  }
  if (actionType.startsWith('discovery')) {
    return ActionCategory.DISCOVERY;
  }
  if (actionType.startsWith('achievement')) {
    return ActionCategory.ACHIEVEMENT;
  }
  if (actionType.startsWith('auction')) {
    return ActionCategory.AUCTION;
  }
  if (actionType.startsWith('bank')) {
    return ActionCategory.BANK;
  }
  if (actionType.startsWith('specialization') || actionType.startsWith('mastery')) {
    return ActionCategory.SPECIALIZATION;
  }
  if (actionType.startsWith('clan')) {
    return ActionCategory.CLAN;
  }
  if (actionType.startsWith('admin')) {
    return ActionCategory.ADMIN;
  }
  return ActionCategory.SYSTEM;
}

/**
 * FOOTER:
 * 
 * Implementation Notes:
 * - 30+ action types provide comprehensive coverage of all player activities
 * - Flexible details object supports varying data structures per action type
 * - Security metadata enables audit trails and abuse detection
 * - Battle logs provide detailed combat analytics for balancing
 * - Type guards enable safe runtime type checking
 * 
 * Known Limitations:
 * - Details object is untyped (Record<string, any>) for flexibility
 * - Large volume logging requires careful index management
 * 
 * Future Enhancements:
 * - Add typed details interfaces per action type
 * - Implement log aggregation for analytics dashboard
 * - Add real-time log streaming via WebSocket
 * - Implement anomaly detection for security alerts
 */

@@@END@@@
@@@FILE:types/auction.types.ts@@@
/**
 * @file types/auction.types.ts
 * @created 2025-01-17
 * @overview Auction House type definitions for P2P trading system
 */

import { UnitType } from './game.types';

/**
 * Types of items that can be auctioned
 */
export enum AuctionItemType {
  Unit = 'unit',
  Resource = 'resource',
  TradeableItem = 'tradeable_item'
}

/**
 * Auction listing status
 */
export enum AuctionStatus {
  Active = 'active',           // Currently accepting bids
  Sold = 'sold',               // Successfully sold
  Cancelled = 'cancelled',     // Cancelled by seller
  Expired = 'expired'          // Expired with no bids
}

/**
 * Resource types for trading
 */
export enum ResourceType {
  Metal = 'metal',
  Energy = 'energy'
}

/**
 * Item being auctioned
 */
export interface AuctionItem {
  itemType: AuctionItemType;
  
  // For units
  unitType?: UnitType;
  unitId?: string;
  unitStrength?: number;
  unitDefense?: number;
  
  // For resources
  resourceType?: ResourceType;
  resourceAmount?: number;
  
  // For tradeable items
  tradeableItemQuantity?: number;
}

/**
 * Bid placed on an auction
 */
export interface AuctionBid {
  bidId: string;
  auctionId: string;
  bidderUsername: string;
  bidAmount: number;
  bidTime: Date;
  isWinning: boolean; // Current highest bid
}

/**
 * Auction listing
 */
export interface AuctionListing {
  auctionId: string;
  sellerUsername: string;
  sellerClan?: string; // For clan-only auctions (0% fee)
  
  item: AuctionItem;
  
  // Pricing
  startingBid: number;
  currentBid: number;
  buyoutPrice?: number; // Optional instant buy price
  reservePrice?: number; // Minimum price to sell (hidden from buyers)
  
  // Bidding
  bids: AuctionBid[];
  highestBidder?: string;
  
  // Timing
  createdAt: Date;
  expiresAt: Date;
  duration: number; // Duration in hours (12, 24, 48)
  
  // Status
  status: AuctionStatus;
  closedAt?: Date;
  
  // Fees
  listingFee: number; // Paid upfront when creating listing
  saleFee: number; // 5% of final price (0% for clan-only)
  clanOnly: boolean; // Only clan members can bid
  
  // Settlement
  settled: boolean;
  settledAt?: Date;
  finalPrice?: number;
  winnerUsername?: string;
}

/**
 * Trade history record
 */
export interface TradeHistory {
  tradeId: string;
  auctionId: string;
  
  sellerUsername: string;
  buyerUsername: string;
  
  item: AuctionItem;
  
  finalPrice: number;
  saleFee: number;
  sellerReceived: number; // finalPrice - saleFee
  
  tradeType: 'auction' | 'buyout';
  
  completedAt: Date;
}

/**
 * Market statistics for an item type
 */
export interface MarketStats {
  itemType: AuctionItemType;
  unitType?: UnitType;
  resourceType?: ResourceType;
  
  // Price statistics
  averagePrice: number;
  medianPrice: number;
  lowestPrice: number;
  highestPrice: number;
  
  // Volume statistics
  totalSales: number;
  totalVolume: number; // Total resources/units/items traded
  
  // Recent activity
  last24Hours: {
    sales: number;
    averagePrice: number;
  };
  
  lastUpdated: Date;
}

/**
 * Auction notification for users
 */
export interface AuctionNotification {
  notificationId: string;
  username: string;
  auctionId: string;
  
  type: 'outbid' | 'won' | 'sold' | 'expired' | 'cancelled';
  
  message: string;
  createdAt: Date;
  read: boolean;
}

/**
 * Auction search filters
 */
export interface AuctionSearchFilters {
  itemType?: AuctionItemType;
  unitType?: UnitType;
  resourceType?: ResourceType;
  
  minPrice?: number;
  maxPrice?: number;
  
  hasBuyout?: boolean;
  clanOnly?: boolean;
  
  sellerUsername?: string;
  
  sortBy?: 'price_asc' | 'price_desc' | 'ending_soon' | 'newly_listed';
  
  page?: number;
  limit?: number;
}

/**
 * Auction creation request
 */
export interface CreateAuctionRequest {
  item: AuctionItem;
  startingBid: number;
  buyoutPrice?: number;
  reservePrice?: number;
  duration: 12 | 24 | 48; // Hours
  clanOnly?: boolean;
}

/**
 * Auction bid request
 */
export interface PlaceBidRequest {
  auctionId: string;
  bidAmount: number;
}

/**
 * Auction buyout request
 */
export interface BuyoutAuctionRequest {
  auctionId: string;
}

/**
 * Auction listing fees configuration
 */
export const AUCTION_CONFIG = {
  // Listing fees (paid upfront, non-refundable)
  LISTING_FEE_12H: 100,
  LISTING_FEE_24H: 150,
  LISTING_FEE_48H: 200,
  
  // Sale fees (% of final price)
  PUBLIC_SALE_FEE: 0.05, // 5% for public auctions
  CLAN_SALE_FEE: 0.00,   // 0% for clan-only auctions
  
  // Bid increment (minimum increase over current bid)
  MIN_BID_INCREMENT: 100,
  
  // Price limits
  MIN_STARTING_BID: 100,
  MAX_STARTING_BID: 1000000,
  
  // Duration options (hours)
  DURATIONS: [12, 24, 48] as const,
  
  // Maximum active listings per player
  MAX_ACTIVE_LISTINGS: 10,
  
  // Maximum bids per player per auction
  MAX_BIDS_PER_AUCTION: 1, // Only one active bid per player (can be outbid)
  
  // Settlement grace period (minutes after auction ends)
  SETTLEMENT_GRACE_PERIOD: 60
};

// ============================================================
// IMPLEMENTATION NOTES:
// ============================================================
// - Listing fees are paid upfront and non-refundable
// - Sale fees are deducted from final price when auction closes
// - Clan-only auctions have 0% sale fee to encourage internal trading
// - Buyout allows instant purchase at fixed price
// - Reserve price is hidden minimum; auction fails if not met
// - Bids are binding; winner must complete purchase
// - Auto-settlement after grace period if winner doesn't claim
// ============================================================
// END OF FILE
// ============================================================

@@@END@@@
@@@FILE:types/autoFarm.types.ts@@@
/**
 * autoFarm.types.ts
 * Created: 2025-10-19
 * 
 * OVERVIEW:
 * TypeScript type definitions for the Auto-Farm monetization system.
 * Defines configuration options, state management, and statistics tracking
 * for automated map traversal and resource collection.
 */

/**
 * Rank filter options for combat targeting
 */
export enum RankFilter {
  ALL = 'all',           // Attack any player
  LOWER = 'lower',       // Only attack lower-ranked players
  HIGHER = 'higher'      // Only attack higher-ranked players
}

/**
 * Resource target for base attacks
 */
export enum ResourceTarget {
  METAL = 'metal',       // Steal metal from bases
  ENERGY = 'energy',     // Steal energy from bases
  LOWEST = 'lowest'      // Auto-detect and steal lowest resource
}

/**
 * Auto-farm operational status
 */
export enum AutoFarmStatus {
  STOPPED = 'stopped',   // Not running
  ACTIVE = 'active',     // Currently running
  PAUSED = 'paused'      // Temporarily paused, can resume
}

/**
 * Auto-farm configuration settings
 */
export interface AutoFarmConfig {
  // Combat settings
  attackPlayers: boolean;              // Whether to attack player bases
  rankFilter: RankFilter;              // Which ranks to target
  resourceTarget: ResourceTarget;      // Which resource to steal
  
  // Premium settings
  isVIP: boolean;                      // VIP status (determines speed tier)
  
  // Note: Harvest settings are always ALL by default
  // (metal, energy, caves, forests) - no toggles needed
}

/**
 * Current auto-farm state (runtime)
 */
export interface AutoFarmState {
  status: AutoFarmStatus;              // Current operational status
  currentPosition: {                   // Current tile coordinates
    x: number;
    y: number;
  };
  startPosition: {                     // Where auto-farm started
    x: number;
    y: number;
  };
  currentRow: number;                  // Current row (1-150)
  direction: 'forward' | 'backward';   // Current row direction
  tilesCompleted: number;              // Total tiles processed
  startTime: number | null;            // Session start timestamp
  pausedTime: number | null;           // When paused (for elapsed calc)
  lastHarvestTime: number | null;      // Last harvest timestamp (for cooldown tracking)
}

/**
 * Per-session statistics (reset on Stop)
 */
export interface AutoFarmSessionStats {
  timeElapsed: number;                 // Milliseconds elapsed
  metalCollected: number;              // Metal harvested this session
  energyCollected: number;             // Energy harvested this session
  tilesVisited: number;                // Tiles processed
  caveItemsFound: number;              // Cave items discovered
  forestItemsFound: number;            // Forest items discovered
  attacksLaunched: number;             // Base attacks attempted
  attacksWon: number;                  // Successful attacks
  attacksLost: number;                 // Failed attacks
  errorsEncountered: number;           // Tiles skipped due to errors
}

/**
 * All-time cumulative statistics (persisted)
 */
export interface AutoFarmAllTimeStats {
  totalTimeElapsed: number;            // Total milliseconds across all sessions
  totalMetalCollected: number;         // All-time metal
  totalEnergyCollected: number;        // All-time energy
  totalTilesVisited: number;           // All-time tiles
  totalCaveItemsFound: number;         // All-time cave items
  totalForestItemsFound: number;       // All-time forest items
  totalAttacksLaunched: number;        // All-time attacks
  totalAttacksWon: number;             // All-time victories
  totalAttacksLost: number;            // All-time defeats
  totalSessionsCompleted: number;      // Number of complete sessions
  lastUpdated: number;                 // Timestamp of last update
}

/**
 * Combined statistics for display
 */
export interface AutoFarmStats {
  session: AutoFarmSessionStats;
  allTime: AutoFarmAllTimeStats;
}

/**
 * Auto-farm event for logging/callbacks
 */
export interface AutoFarmEvent {
  type: 'move' | 'harvest' | 'combat' | 'error' | 'complete';
  timestamp: number;
  position: { x: number; y: number };
  data?: any;                          // Event-specific data
  message?: string;                    // Human-readable message
}

/**
 * Tile processing result
 */
export interface TileProcessResult {
  success: boolean;
  position: { x: number; y: number };
  action: 'moved' | 'harvested' | 'attacked' | 'skipped';
  resourcesGained?: {
    metal?: number;
    energy?: number;
    items?: number;
  };
  combatResult?: {
    won: boolean;
    resourceStolen?: number;
  };
  error?: string;
}

/**
 * Default configuration values
 */
export const DEFAULT_AUTO_FARM_CONFIG: AutoFarmConfig = {
  attackPlayers: false,
  rankFilter: RankFilter.ALL,
  resourceTarget: ResourceTarget.LOWEST,
  isVIP: false // Default to basic tier
};

/**
 * Default session statistics
 */
export const DEFAULT_SESSION_STATS: AutoFarmSessionStats = {
  timeElapsed: 0,
  metalCollected: 0,
  energyCollected: 0,
  tilesVisited: 0,
  caveItemsFound: 0,
  forestItemsFound: 0,
  attacksLaunched: 0,
  attacksWon: 0,
  attacksLost: 0,
  errorsEncountered: 0
};

/**
 * Default all-time statistics
 */
export const DEFAULT_ALL_TIME_STATS: AutoFarmAllTimeStats = {
  totalTimeElapsed: 0,
  totalMetalCollected: 0,
  totalEnergyCollected: 0,
  totalTilesVisited: 0,
  totalCaveItemsFound: 0,
  totalForestItemsFound: 0,
  totalAttacksLaunched: 0,
  totalAttacksWon: 0,
  totalAttacksLost: 0,
  totalSessionsCompleted: 0,
  lastUpdated: Date.now()
};

@@@END@@@
@@@FILE:types/botConfig.types.ts@@@
/**
 * @file types/botConfig.types.ts
 * @created 2025-10-18
 * @overview Bot system configuration types for admin panel
 * 
 * OVERVIEW:
 * Defines all configurable parameters for the bot ecosystem.
 * Admin panel can adjust these values in real-time to tune game balance.
 */

/**
 * Global bot system configuration
 * All parameters adjustable via admin panel
 */
export interface BotSystemConfig {
  // Population Control
  enabled: boolean;                    // Master enable/disable for entire bot system
  totalBotCap: number;                 // Maximum total bots (default: 1000)
  dailySpawnCount: number;             // Bots to spawn per day (default: 50-100)
  initialSpawnCount: number;           // Starting bots (default: 100)
  
  // Resource Regeneration (Full Permanence Model)
  regenEnabled: boolean;               // Enable hourly resource regeneration
  hoarderRegenRate: number;            // Hoarder regen % per hour (default: 0.05 = 5%)
  fortressRegenRate: number;           // Fortress regen % per hour (default: 0.10)
  raiderRegenRate: number;             // Raider regen % per hour (default: 0.15)
  ghostRegenRate: number;              // Ghost regen % per hour (default: 0.20)
  balancedRegenRate: number;           // Balanced regen % per hour (default: 0.10)
  
  // Beer Base System
  beerBaseEnabled: boolean;            // Enable Beer Bases
  beerBasePercentage: number;          // % of bots that are Beer Bases (default: 0.07 = 7%)
  beerBaseResourceMultiplier: number;  // Resource multiplier for Beer Bases (default: 3.0)
  beerBaseRespawnDay: number;          // Day of week to respawn (0=Sunday, default: 0)
  beerBaseRespawnHour: number;         // Hour to respawn Beer Bases (default: 4)
  
  // Bot Scanner Tech
  scannerBaseRadius: number;           // Base scan radius in tiles (default: 50)
  scannerUpgradedRadius: number;       // Upgraded scan radius (default: 100)
  scannerBaseCooldown: number;         // Base cooldown in minutes (default: 60)
  scannerUpgradedCooldown: number;     // Upgraded cooldown in minutes (default: 30)
  
  // Bot Magnet Tech
  magnetEnabled: boolean;              // Enable Bot Magnet feature
  magnetCost: number;                  // Metal cost to deploy (default: 10000)
  magnetRadius: number;                // Attraction radius in tiles (default: 75)
  magnetDuration: number;              // Duration in hours (default: 168 = 7 days)
  magnetMigrationTime: number;         // Hours for bots to migrate (default: 48)
  magnetMinBots: number;               // Min bots attracted (default: 20)
  magnetMaxBots: number;               // Max bots attracted (default: 50)
  magnetCooldown: number;              // Cooldown in hours (default: 336 = 14 days)
  
  // Bot Concentration Zones Tech
  concentrationEnabled: boolean;       // Enable Concentration Zones
  concentrationMaxZones: number;       // Max zones player can set (default: 3)
  concentrationZoneSize: number;       // Zone size in tiles (default: 30Ã—30)
  concentrationSpawnPercentage: number; // % of new spawns in zones (default: 0.70 = 70%)
  concentrationRelocateInterval: number; // Days between relocations (default: 7)
  
  // Bot Summoning Circle Tech
  summoningEnabled: boolean;           // Enable Bot Summoning
  summoningCostMetal: number;          // Metal cost (default: 25000)
  summoningCostEnergy: number;         // Energy cost (default: 25000)
  summoningBotCount: number;           // Bots spawned per summon (default: 5)
  summoningRadius: number;             // Spawn radius in tiles (default: 20)
  summoningCooldown: number;           // Cooldown in hours (default: 168 = 7 days)
  
  // Fast Travel Network Tech
  travelEnabled: boolean;              // Enable Fast Travel
  travelMaxWaypoints: number;          // Max waypoints (default: 5)
  travelCostMetal: number;             // Metal cost per trip (default: 5000)
  travelCostEnergy: number;            // Energy cost per trip (default: 5000)
  travelWaypointCooldown: number;      // Cooldown per waypoint in hours (default: 12)
  
  // Bot Bounty Board
  bountyEnabled: boolean;              // Enable daily bounties
  bountyDailyCount: number;            // Bounties per day (default: 5)
  bountyMinReward: number;             // Min reward (default: 25000)
  bountyMaxReward: number;             // Max reward (default: 100000)
  bountyRefreshHour: number;           // Hour to refresh bounties (default: 0 = midnight)
  
  // Reputation System
  reputationNotoriousThreshold: number;  // Defeats for Notorious (default: 6)
  reputationInfamousThreshold: number;   // Defeats for Infamous (default: 16)
  reputationLegendaryThreshold: number;  // Defeats for Legendary (default: 31)
  reputationNotoriousBonus: number;      // Loot bonus % (default: 0.25 = +25%)
  reputationInfamousBonus: number;       // Loot bonus % (default: 0.50 = +50%)
  reputationLegendaryBonus: number;      // Loot bonus % (default: 1.00 = +100%)
  
  // Weekly Migration
  migrationEnabled: boolean;           // Enable weekly migrations
  migrationPercentage: number;         // % of bots that migrate (default: 0.30 = 30%)
  migrationDay: number;                // Day of week (0=Sunday, default: 0)
  migrationHour: number;               // Hour to trigger (default: 12)
  
  // Phase-Out System
  phaseOutEnabled: boolean;            // Enable gradual bot removal
  phaseOutRatio: number;               // 1 bot per X real players (default: 10)
  phaseOutPriority: 'weakest' | 'oldest' | 'random'; // Which bots to remove (default: 'weakest')
  phaseOutPreserveNests: boolean;      // Keep nest bots (default: true)
  
  // Bot Nests
  nestCount: number;                   // Number of nests (default: 8)
  nestMinBots: number;                 // Min bots per nest (default: 15)
  nestMaxBots: number;                 // Max bots per nest (default: 20)
}

/**
 * Bot nest location configuration
 */
export interface BotNestLocation {
  id: number;                          // Nest ID (0-7)
  position: { x: number; y: number };  // Map coordinates
  name: string;                        // Display name (e.g., "North Bank Nest")
  theme: string;                       // Thematic description
  active: boolean;                     // Is nest active
  currentBotCount: number;             // Current bots at this nest
}

/**
 * Bot spawn event for admin logging
 */
export interface BotSpawnEvent {
  timestamp: Date;
  count: number;
  zones: number[];                     // Zones where bots spawned
  specializations: Record<string, number>; // Count by type
  reason: 'initial' | 'daily' | 'manual' | 'beer_base_respawn';
}

/**
 * Default bot system configuration
 */
export const DEFAULT_BOT_CONFIG: BotSystemConfig = {
  // Population
  enabled: true,
  totalBotCap: 1000,
  dailySpawnCount: 75,
  initialSpawnCount: 100,
  
  // Regeneration
  regenEnabled: true,
  hoarderRegenRate: 0.05,
  fortressRegenRate: 0.10,
  raiderRegenRate: 0.15,
  ghostRegenRate: 0.20,
  balancedRegenRate: 0.10,
  
  // Beer Bases
  beerBaseEnabled: true,
  beerBasePercentage: 0.07,
  beerBaseResourceMultiplier: 3.0,
  beerBaseRespawnDay: 0,
  beerBaseRespawnHour: 4,
  
  // Scanner
  scannerBaseRadius: 50,
  scannerUpgradedRadius: 100,
  scannerBaseCooldown: 60,
  scannerUpgradedCooldown: 30,
  
  // Magnet
  magnetEnabled: true,
  magnetCost: 10000,
  magnetRadius: 75,
  magnetDuration: 168,
  magnetMigrationTime: 48,
  magnetMinBots: 20,
  magnetMaxBots: 50,
  magnetCooldown: 336,
  
  // Concentration
  concentrationEnabled: true,
  concentrationMaxZones: 3,
  concentrationZoneSize: 30,
  concentrationSpawnPercentage: 0.70,
  concentrationRelocateInterval: 7,
  
  // Summoning
  summoningEnabled: true,
  summoningCostMetal: 25000,
  summoningCostEnergy: 25000,
  summoningBotCount: 5,
  summoningRadius: 20,
  summoningCooldown: 168,
  
  // Travel
  travelEnabled: true,
  travelMaxWaypoints: 5,
  travelCostMetal: 5000,
  travelCostEnergy: 5000,
  travelWaypointCooldown: 12,
  
  // Bounty
  bountyEnabled: true,
  bountyDailyCount: 5,
  bountyMinReward: 25000,
  bountyMaxReward: 100000,
  bountyRefreshHour: 0,
  
  // Reputation
  reputationNotoriousThreshold: 6,
  reputationInfamousThreshold: 16,
  reputationLegendaryThreshold: 31,
  reputationNotoriousBonus: 0.25,
  reputationInfamousBonus: 0.50,
  reputationLegendaryBonus: 1.00,
  
  // Migration
  migrationEnabled: true,
  migrationPercentage: 0.30,
  migrationDay: 0,
  migrationHour: 12,
  
  // Phase-Out
  phaseOutEnabled: false,
  phaseOutRatio: 10,
  phaseOutPriority: 'weakest',
  phaseOutPreserveNests: true,
  
  // Nests
  nestCount: 8,
  nestMinBots: 15,
  nestMaxBots: 20,
};

// ============================================================
// IMPLEMENTATION NOTES:
// ============================================================
// - All parameters stored in MongoDB 'botConfig' collection
// - Admin panel provides UI to adjust any parameter
// - Changes take effect immediately (no restart required)
// - Historical configuration changes logged for audit
// - Default values provide balanced gameplay out-of-the-box
// ============================================================

@@@END@@@
@@@FILE:types/clan.types.ts@@@
/**
 * Clan System Type Definitions
 * Created: 2025-10-18 09:40
 * 
 * OVERVIEW:
 * Complete type system for DarkFrame clan/guild functionality.
 * Supports clan creation, member management with roles, research progression,
 * territory control, warfare mechanics, monument bonuses, and social features.
 * 
 * Core Components:
 * - Clan structure with membership and resources
 * - Role-based permissions (Leader, Officer, Member)
 * - Research tree with permanent bonuses
 * - Territory claiming and defense bonuses
 * - Clan warfare and territory capture
 * - Monument control for passive bonuses
 * - Chat and activity tracking
 * 
 * Dependencies:
 * - MongoDB for data persistence
 * - Activity logging for clan events
 */

import { ObjectId } from 'mongodb';

// ============================================================================
// ENUMS
// ============================================================================

/**
 * Clan member roles with hierarchical permissions
 */
export enum ClanRole {
  LEADER = 'LEADER',           // Full control: disband, transfer leadership, promote to any role
  CO_LEADER = 'CO_LEADER',     // Second-in-command: promote to Officer, manage wars, territories
  OFFICER = 'OFFICER',         // Management: kick Members, invite, manage research
  ELITE = 'ELITE',             // Veteran: priority war deployment, bonus RP contribution
  MEMBER = 'MEMBER',           // Standard: contribute, view, chat
  RECRUIT = 'RECRUIT'          // Trial: limited contributions, view-only for 24 hours
}

/**
 * Clan research branches
 */
export enum ResearchBranch {
  STRENGTH = 'STRENGTH',         // Attack bonuses
  DEFENSE = 'DEFENSE',           // Defense bonuses
  ECONOMIC = 'ECONOMIC'          // Resource and efficiency bonuses
}

/**
 * Clan war status
 */
export enum WarStatus {
  DECLARED = 'DECLARED',   // War declared, not yet active
  ACTIVE = 'ACTIVE',       // War in progress, territory can be captured
  ENDED = 'ENDED',         // War concluded
  TRUCE = 'TRUCE'          // Temporary peace agreement
}

/**
 * Clan activity types for activity feed (enhanced)
 */
export enum ClanActivityType {
  CLAN_CREATED = 'CLAN_CREATED',
  MEMBER_JOINED = 'MEMBER_JOINED',
  MEMBER_LEFT = 'MEMBER_LEFT',
  MEMBER_KICKED = 'MEMBER_KICKED',
  MEMBER_PROMOTED = 'MEMBER_PROMOTED',
  MEMBER_DEMOTED = 'MEMBER_DEMOTED',
  LEADERSHIP_TRANSFERRED = 'LEADERSHIP_TRANSFERRED',
  SETTINGS_CHANGED = 'SETTINGS_CHANGED',
  LEVEL_UP = 'LEVEL_UP',
  PERK_ACTIVATED = 'PERK_ACTIVATED',
  PERK_DEACTIVATED = 'PERK_DEACTIVATED',
  RESEARCH_UNLOCKED = 'RESEARCH_UNLOCKED',
  RESEARCH_CONTRIBUTED = 'RESEARCH_CONTRIBUTED',
  TERRITORY_CLAIMED = 'TERRITORY_CLAIMED',
  TERRITORY_LOST = 'TERRITORY_LOST',
  TERRITORY_INCOME_COLLECTED = 'TERRITORY_INCOME_COLLECTED',
  WAR_DECLARED = 'WAR_DECLARED',
  WAR_ENDED = 'WAR_ENDED',
  MONUMENT_CAPTURED = 'MONUMENT_CAPTURED',
  MONUMENT_LOST = 'MONUMENT_LOST',
  BANK_DEPOSIT = 'BANK_DEPOSIT',
  BANK_WITHDRAWAL = 'BANK_WITHDRAWAL',
  TAX_COLLECTED = 'TAX_COLLECTED',
  TAX_RATE_CHANGED = 'TAX_RATE_CHANGED',
  BANK_UPGRADED = 'BANK_UPGRADED',
  FUND_DISTRIBUTION = 'FUND_DISTRIBUTION',
  ALLIANCE_PROPOSED = 'ALLIANCE_PROPOSED',
  ALLIANCE_RECEIVED = 'ALLIANCE_RECEIVED',
  ALLIANCE_ACCEPTED = 'ALLIANCE_ACCEPTED',
  ALLIANCE_FORMED = 'ALLIANCE_FORMED',
  ALLIANCE_BROKEN = 'ALLIANCE_BROKEN',
  CONTRACT_ADDED = 'CONTRACT_ADDED',
  CONTRACT_REMOVED = 'CONTRACT_REMOVED',
}

/**
 * Fund distribution methods
 */
export enum DistributionMethod {
  EQUAL_SPLIT = 'EQUAL_SPLIT',         // Divide equally among all members
  PERCENTAGE = 'PERCENTAGE',           // Custom percentage per role or player
  MERIT = 'MERIT',                     // Based on contribution metrics
  DIRECT_GRANT = 'DIRECT_GRANT',       // Direct transfer to specific players
}

/**
 * Alliance types with cost progression
 */
export enum AllianceType {
  NAP = 'NAP',                         // Non-Aggression Pact (free)
  TRADE = 'TRADE',                     // Trade Alliance (10K M/E)
  MILITARY = 'MILITARY',               // Military Alliance (50K M/E)
  FEDERATION = 'FEDERATION',           // Federation (200K M/E)
}

/**
 * Alliance status
 */
export enum AllianceStatus {
  PROPOSED = 'PROPOSED',               // Proposed, awaiting acceptance
  ACTIVE = 'ACTIVE',                   // Active alliance
  BROKEN = 'BROKEN',                   // Alliance broken
  EXPIRED = 'EXPIRED',                 // Expired (if time-limited)
}

/**
 * Alliance contract types
 */
export enum ContractType {
  RESOURCE_SHARING = 'RESOURCE_SHARING',         // Share passive income
  DEFENSE_PACT = 'DEFENSE_PACT',                 // Auto-join defensive wars
  WAR_SUPPORT = 'WAR_SUPPORT',                   // Provide resources during wars
  JOINT_RESEARCH = 'JOINT_RESEARCH',             // Share research contributions
}

/**
 * Monument types with unique bonuses
 */
export enum MonumentType {
  ANCIENT_FORGE = 'ANCIENT_FORGE',           // +5% Metal yield
  WAR_MEMORIAL = 'WAR_MEMORIAL',             // +10% Attack
  MARKET_PLAZA = 'MARKET_PLAZA',             // -5% auction fees
  RESEARCH_LAB = 'RESEARCH_LAB',             // +15% RP gain
  GRAND_TEMPLE = 'GRAND_TEMPLE'              // +5% XP gain
}

/**
 * Clan role permissions matrix
 */
export interface ClanPermissions {
  canDisband: boolean;              // Disband entire clan
  canTransferLeadership: boolean;   // Transfer leadership to another member
  canPromoteToCoLeader: boolean;    // Promote members to Co-Leader
  canPromoteToOfficer: boolean;     // Promote members to Officer
  canPromoteToElite: boolean;       // Promote members to Elite
  canDemote: boolean;               // Demote members to lower ranks
  canKick: boolean;                 // Kick members from clan
  canInvite: boolean;               // Invite new members
  canManageWars: boolean;           // Declare wars, negotiate truces
  canManageTerritories: boolean;    // Claim and abandon territories
  canManageResearch: boolean;       // Unlock research nodes
  canContributeRP: boolean;         // Contribute to research pool
  canContributeResources: boolean;  // Donate to clan treasury
  canViewTreasury: boolean;         // View clan resources
  canWithdrawFromBank: boolean;     // Withdraw resources from clan bank
  canManageTaxes: boolean;          // Set tax rates and policies
  canUpgradeBank: boolean;          // Upgrade clan bank capacity/features
  canUseChat: boolean;              // Send messages in clan chat
  canViewOfficerChat: boolean;      // Access officer-only channel
  canViewLeaderChat: boolean;       // Access leader-only channel
  canEditDescription: boolean;      // Edit clan description
  bonusRPContribution: number;      // Bonus RP multiplier (1.0 = normal, 1.15 = +15%)
  warDeploymentPriority: number;    // Priority in war deployments (1-6, 1 = highest)
}

/**
 * Role permission definitions
 */
export const ROLE_PERMISSIONS: Record<ClanRole, ClanPermissions> = {
  [ClanRole.LEADER]: {
    canDisband: true,
    canTransferLeadership: true,
    canPromoteToCoLeader: true,
    canPromoteToOfficer: true,
    canPromoteToElite: true,
    canDemote: true,
    canKick: true,
    canInvite: true,
    canManageWars: true,
    canManageTerritories: true,
    canManageResearch: true,
    canContributeRP: true,
    canContributeResources: true,
    canViewTreasury: true,
    canWithdrawFromBank: true,
    canManageTaxes: true,
    canUpgradeBank: true,
    canUseChat: true,
    canViewOfficerChat: true,
    canViewLeaderChat: true,
    canEditDescription: true,
    bonusRPContribution: 1.0,
    warDeploymentPriority: 1,
  },
  [ClanRole.CO_LEADER]: {
    canDisband: false,
    canTransferLeadership: false,
    canPromoteToCoLeader: false,
    canPromoteToOfficer: true,
    canPromoteToElite: true,
    canDemote: true, // Can demote Officers and below
    canKick: true,
    canInvite: true,
    canManageWars: true,
    canManageTerritories: true,
    canManageResearch: true,
    canContributeRP: true,
    canContributeResources: true,
    canViewTreasury: true,
    canWithdrawFromBank: true,
    canManageTaxes: false,
    canUpgradeBank: false,
    canUseChat: true,
    canViewOfficerChat: true,
    canViewLeaderChat: true,
    canEditDescription: true,
    bonusRPContribution: 1.0,
    warDeploymentPriority: 2,
  },
  [ClanRole.OFFICER]: {
    canDisband: false,
    canTransferLeadership: false,
    canPromoteToCoLeader: false,
    canPromoteToOfficer: false,
    canPromoteToElite: true, // Can promote Members to Elite
    canDemote: false,
    canKick: true, // Can kick Members and Recruits only
    canInvite: true,
    canManageWars: false,
    canManageTerritories: true,
    canManageResearch: true,
    canContributeRP: true,
    canContributeResources: true,
    canViewTreasury: true,
    canWithdrawFromBank: false,
    canManageTaxes: false,
    canUpgradeBank: false,
    canUseChat: true,
    canViewOfficerChat: true,
    canViewLeaderChat: false,
    canEditDescription: false,
    bonusRPContribution: 1.0,
    warDeploymentPriority: 3,
  },
  [ClanRole.ELITE]: {
    canDisband: false,
    canTransferLeadership: false,
    canPromoteToCoLeader: false,
    canPromoteToOfficer: false,
    canPromoteToElite: false,
    canDemote: false,
    canKick: false,
    canInvite: true, // Elite members can invite
    canManageWars: false,
    canManageTerritories: false,
    canManageResearch: false,
    canContributeRP: true,
    canContributeResources: true,
    canViewTreasury: true,
    canWithdrawFromBank: false,
    canManageTaxes: false,
    canUpgradeBank: false,
    canUseChat: true,
    canViewOfficerChat: false,
    canViewLeaderChat: false,
    canEditDescription: false,
    bonusRPContribution: 1.15, // +15% RP contribution bonus
    warDeploymentPriority: 4,
  },
  [ClanRole.MEMBER]: {
    canDisband: false,
    canTransferLeadership: false,
    canPromoteToCoLeader: false,
    canPromoteToOfficer: false,
    canPromoteToElite: false,
    canDemote: false,
    canKick: false,
    canInvite: false,
    canManageWars: false,
    canManageTerritories: false,
    canManageResearch: false,
    canContributeRP: true,
    canContributeResources: true,
    canViewTreasury: false,
    canWithdrawFromBank: false,
    canManageTaxes: false,
    canUpgradeBank: false,
    canUseChat: true,
    canViewOfficerChat: false,
    canViewLeaderChat: false,
    canEditDescription: false,
    bonusRPContribution: 1.0,
    warDeploymentPriority: 5,
  },
  [ClanRole.RECRUIT]: {
    canDisband: false,
    canTransferLeadership: false,
    canPromoteToCoLeader: false,
    canPromoteToOfficer: false,
    canPromoteToElite: false,
    canDemote: false,
    canKick: false,
    canInvite: false,
    canManageWars: false,
    canManageTerritories: false,
    canManageResearch: false,
    canContributeRP: true,
    canContributeResources: true,
    canViewTreasury: false,
    canWithdrawFromBank: false,
    canManageTaxes: false,
    canUpgradeBank: false,
    canUseChat: true, // Can chat after 24 hours
    canViewOfficerChat: false,
    canViewLeaderChat: false,
    canEditDescription: false,
    bonusRPContribution: 0.5, // -50% RP contribution (trial period)
    warDeploymentPriority: 6,
  },
};

/**
 * Check if a role has specific permission
 * 
 * @param role - Clan member role
 * @param permission - Permission to check
 * @returns Whether the role has the permission
 * 
 * @example
 * if (hasPermission(ClanRole.OFFICER, 'canKick')) {
 *   // Officer can kick members
 * }
 */
export function hasPermission(
  role: ClanRole,
  permission: keyof Omit<ClanPermissions, 'bonusRPContribution' | 'warDeploymentPriority'>
): boolean {
  return ROLE_PERMISSIONS[role][permission];
}

/**
 * Get bonus RP contribution multiplier for role
 * 
 * @param role - Clan member role
 * @returns RP contribution multiplier (1.0 = normal, 1.15 = +15%, 0.5 = -50%)
 * 
 * @example
 * const rpContributed = baseRP * getRPBonus(ClanRole.ELITE); // 1.15x for Elite
 */
export function getRPBonus(role: ClanRole): number {
  return ROLE_PERMISSIONS[role].bonusRPContribution;
}

/**
 * Get war deployment priority for role
 * 
 * @param role - Clan member role
 * @returns Priority level (1 = highest, 6 = lowest)
 * 
 * @example
 * const priority = getWarPriority(ClanRole.CO_LEADER); // Returns 2
 */
export function getWarPriority(role: ClanRole): number {
  return ROLE_PERMISSIONS[role].warDeploymentPriority;
}

/**
 * Clan bank tax configuration
 */
export interface ClanTaxConfig {
  metal: number;            // Tax rate 0-50% on metal harvests
  energy: number;           // Tax rate 0-50% on energy harvests
  researchPoints: number;   // Tax rate 0-50% on RP gains
}

/**
 * Clan bank transaction types
 */
export enum BankTransactionType {
  DEPOSIT = 'DEPOSIT',
  WITHDRAWAL = 'WITHDRAWAL',
  TAX_COLLECTION = 'TAX_COLLECTION',
  RESEARCH_SPENDING = 'RESEARCH_SPENDING',
  PERK_ACTIVATION = 'PERK_ACTIVATION',
  BANK_UPGRADE = 'BANK_UPGRADE',
}

/**
 * Clan bank transaction record
 */
export interface ClanBankTransaction {
  transactionId: string;
  type: BankTransactionType;
  playerId?: string;
  username?: string;
  amount: {
    metal?: number;
    energy?: number;
    researchPoints?: number;
  };
  timestamp: Date;
  description: string;
}

/**
 * Clan bank structure
 */
export interface ClanBank {
  treasury: {
    metal: number;
    energy: number;
    researchPoints: number;
  };
  taxRates: ClanTaxConfig;
  upgradeLevel: number;      // 1-6 upgrade levels
  capacity: number;          // Maximum storage per resource
  transactions: ClanBankTransaction[];  // Last 100 transactions
}

/**
 * Clan perk categories
 */
export enum ClanPerkCategory {
  COMBAT = 'COMBAT',
  ECONOMIC = 'ECONOMIC',
  SOCIAL = 'SOCIAL',
  STRATEGIC = 'STRATEGIC',
}

/**
 * Clan perk tier types
 */
export enum ClanPerkTier {
  BRONZE = 'BRONZE',
  SILVER = 'SILVER',
  GOLD = 'GOLD',
  LEGENDARY = 'LEGENDARY',
}

/**
 * Clan perk definition (enhanced for Phase 2)
 */
export interface ClanPerk {
  id: string;                     // Unique perk ID
  name: string;                   // Display name
  description: string;            // Perk effect description
  category: ClanPerkCategory;     // Perk category
  tier: ClanPerkTier;             // Tier (Bronze, Silver, Gold, Legendary)
  requiredLevel: number;          // Minimum clan level
  cost: {                         // Activation cost
    metal: number;
    energy: number;
    researchPoints: number;
  };
  bonus: {                        // Bonus provided
    type: 'attack' | 'defense' | 'resource_yield' | 'xp_gain' | 'territory_cost' | 'max_members';
    value: number;                // Percentage or flat value
  };
  activatedAt?: Date;             // When perk was activated
  activatedBy?: string;           // Player ID who activated
}

/**
 * Clan level progression (enhanced for Phase 2)
 */
export interface ClanLevel {
  currentLevel: number;           // Current level (1-50)
  totalXP: number;                // Total XP accumulated since level 1
  currentLevelXP: number;         // XP progress in current level
  xpToNextLevel: number;          // XP remaining to reach next level
  featuresUnlocked: string[];     // Features unlocked (perks, monuments, warfare)
  milestonesCompleted: Array<{
    level: number;
    completedAt: Date;
    rewards: { metal: number; energy: number; researchPoints: number };
  }>;
  lastLevelUp?: Date;             // When clan last leveled up
  lastXPGain?: Date;              // When clan last gained XP
  prestigeBadge?: string;         // Visual badge/title for max level
}

/**
 * Clan research categories (enhanced 4-branch system)
 */
export enum ClanResearchCategory {
  INDUSTRIAL = 'INDUSTRIAL',
  MILITARY = 'MILITARY',
  ECONOMIC = 'ECONOMIC',
  SOCIAL = 'SOCIAL',
}

/**
 * Clan war status types
 */
export enum ClanWarStatus {
  DECLARED = 'DECLARED',
  ACTIVE = 'ACTIVE',
  ENDED = 'ENDED',
  TRUCE = 'TRUCE',
}

/**
 * Clan territory tile types
 */
export enum ClanTerritoryType {
  STANDARD = 'STANDARD',
  MONUMENT = 'MONUMENT',
  STRONGHOLD = 'STRONGHOLD',
}

/**
 * Clan member relationship
 */
export interface ClanMember {
  playerId: string;         // Player username
  username: string;         // Display name
  role: ClanRole;           // Member role (Leader, Officer, Member)
  joinedAt: Date;           // When member joined clan
  lastActive: Date;         // Last activity timestamp
}

/**
 * Main clan document (enhanced with levels, perks, banking)
 */
export interface Clan {
  _id?: ObjectId;
  name: string;             // Full clan name
  tag: string;              // 2-6 character clan tag (e.g., [DARK])
  description: string;      // Clan description/motto
  leaderId: string;         // Username of clan leader
  
  // Membership (enhanced)
  members: ClanMember[];    // Array of clan members
  maxMembers: number;       // Maximum members (upgradeable)
  
  // Clan progression (ENHANCED for Phase 2)
  level: ClanLevel;         // Full level progression object
  
  // Creation timestamp
  createdAt: Date;
  
  // Settings (NEW)
  settings: {
    messageOfTheDay: string;
    isRecruiting: boolean;
    minLevelToJoin: number;
    requiresApproval: boolean;
    allowTerritoryControl: boolean;
    allowWarDeclarations: boolean;
  };
  
  // Statistics (enhanced)
  stats: {
    totalPower: number;     // Calculated power rating
    totalTerritories: number; // Territory count
    totalMonuments: number; // Monument count
    warsWon: number;
    warsLost: number;
    totalRP: number;        // Total RP contributed (NEW)
  };
  
  // Research progress (enhanced structure)
  research: {
    researchPoints: number; // Shared RP pool
    unlockedTechs: string[]; // Array of unlocked research IDs
    activeResearch: string | null; // Currently researching tech ID
  };
  
  // Clan bank (NEW)
  bank: ClanBank;
  
  // Active perks (NEW)
  activePerks: ClanPerk[];
  
  // Territory
  territories: ClanTerritory[];
  
  // Monuments
  monuments: MonumentType[];
  
  // Wars
  wars: {
    active: ClanWar[];
    history: ClanWar[];
  };
}

/**
 * Clan research node definition
 */
export interface ClanResearch {
  researchId: string;       // Unique identifier
  name: string;             // Display name
  description: string;      // What it does
  branch: ResearchBranch;   // Research tree branch
  level: number;            // Current level (0-5)
  maxLevel: number;         // Maximum level
  
  // Cost per level
  cost: {
    rp: number;             // Research Points required
    metal?: number;         // Optional resource cost
    energy?: number;
  };
  
  // Prerequisites
  requires?: string[];      // Required research IDs
  
  // Bonuses granted
  bonuses: {
    type: 'attack' | 'defense' | 'metal_yield' | 'energy_yield' | 'member_capacity' | 'territory_cost_reduction';
    value: number;          // Bonus percentage or flat value
  }[];
}

/**
 * Clan territory tile
 */
export interface ClanTerritory {
  _id?: ObjectId;
  clanId: string;           // Owning clan
  tileX: number;            // X coordinate
  tileY: number;            // Y coordinate
  claimedAt: Date;          // When claimed
  claimedBy: string;        // Player who claimed it
  defenseBonus: number;     // Defense bonus percentage (+10% per adjacent tile)
}

/**
 * Clan war declaration (enhanced)
/**
 * Clan war declaration (enhanced)
 */
export interface ClanWar {
  _id?: ObjectId;
  warId: string;            // Unique war identifier
  attackerClanId: string;   // Attacking clan
  defenderClanId: string;   // Defending clan
  
  status: ClanWarStatus;    // Current war status
  
  // War timeline
  declaredAt: Date;         // When declared
  startedAt?: Date;         // When became active
  endedAt?: Date;           // When concluded
  
  // Costs
  declarationCost: {
    metal: number;          // 2000 Metal
    energy: number;         // 2000 Energy
  };
  
  // War statistics
  stats: {
    attackerTerritoryGained: number;
    defenderTerritoryGained: number;
    attackerBattlesWon: number;
    defenderBattlesWon: number;
  };
  
  // Outcome
  winner?: string;          // Winning clan ID
}

/**
 * Monument instance
 */
export interface ClanMonument {
  _id?: ObjectId;
  monumentId: string;       // Unique monument identifier
  type: MonumentType;       // Monument type
  name: string;             // Display name
  location: {
    centerX: number;        // Center tile X
    centerY: number;        // Center tile Y
    requiredTiles: Array<{ x: number; y: number }>;  // 3x3 grid
  };
  
  // Control
  controllingClanId?: string;  // Current controlling clan (null if unclaimed)
  controlledSince?: Date;      // When control began
  
  // Bonuses granted to controlling clan
  bonuses: {
    type: string;           // Bonus type
    value: number;          // Bonus value
    description: string;    // Human-readable description
  }[];
}

/**
 * Clan chat message
 */
export interface ClanChatMessage {
  _id?: ObjectId;
  clanId: string;           // Clan identifier
  senderId: string;         // Player username
  senderRole: ClanRole;     // Role at time of message
  message: string;          // Message content (max 500 characters)
  channel: 'general' | 'officer' | 'leader';  // Chat channel
  timestamp: Date;          // When sent
  deleted?: boolean;        // Soft delete flag
}

/**
 * Clan activity log entry
 */
export interface ClanActivity {
  _id?: ObjectId;
  clanId: string;           // Clan identifier
  activityType: ClanActivityType;  // Type of activity
  playerId?: string;        // Player involved (if applicable)
  username?: string;        // Player username
  details: {                // Activity-specific details
    [key: string]: any;
  };
  timestamp: Date;          // When activity occurred
}

// ============================================================================
// QUERY & UTILITY INTERFACES
// ============================================================================

/**
 * Clan creation parameters
 */
export interface CreateClanParams {
  name: string;             // Clan name (3-30 characters)
  tag: string;              // Clan tag (2-4 characters, uppercase)
  description?: string;     // Optional description
  leaderId: string;         // Creating player username
}

/**
 * Clan member invitation
 */
export interface ClanInvitation {
  _id?: ObjectId;
  clanId: string;           // Inviting clan
  clanName: string;         // Clan name for display
  invitedBy: string;        // Inviting player
  invitedPlayer: string;    // Invited player username
  invitedAt: Date;          // Invitation timestamp
  expiresAt: Date;          // Expiration (24 hours)
  status: 'pending' | 'accepted' | 'declined' | 'expired';
}

/**
 * Clan statistics for leaderboard
 */
export interface ClanLeaderboardEntry {
  rank: number;             // Leaderboard position
  clanId: string;           // Clan identifier
  clanName: string;         // Clan name
  tag: string;              // Clan tag
  memberCount: number;      // Number of members
  territoryCount: number;   // Tiles controlled
  monumentsControlled: number;  // Monuments held
  totalPower: number;       // Overall power rating
  researchLevel: number;    // Total research levels
  warsWon: number;          // Total wars won
  warsLost: number;         // Total wars lost
  totalRP: number;          // Total RP contributed
  avgMemberLevel: number;   // Average member XP level
}

/**
 * Clan ranking categories for leaderboard
 */
export enum ClanRankingType {
  TOTAL_POWER = 'TOTAL_POWER',           // Overall power rating
  MEMBER_COUNT = 'MEMBER_COUNT',         // Most members
  TERRITORY = 'TERRITORY',               // Most territory controlled
  MONUMENTS = 'MONUMENTS',               // Most monuments controlled
  RESEARCH = 'RESEARCH',                 // Highest research level
  WARS_WON = 'WARS_WON',                 // Most wars won
  RP_CONTRIBUTED = 'RP_CONTRIBUTED',     // Total RP contributed
  AVG_MEMBER_LEVEL = 'AVG_MEMBER_LEVEL'  // Highest average member level
}

/**
 * Clan bonuses calculation result
 */
export interface ClanBonuses {
  attack: number;           // Attack bonus percentage
  defense: number;          // Defense bonus percentage
  metalYield: number;       // Metal harvest bonus percentage
  energyYield: number;      // Energy harvest bonus percentage
  auctionFeeReduction: number;  // Auction fee reduction percentage
  rpGain: number;           // RP gain bonus percentage
  xpGain: number;           // XP gain bonus percentage
}

// ============================================================================
// VALIDATION & HELPERS
// ============================================================================

/**
 * Clan naming rules
 */
export const CLAN_NAMING_RULES = {
  NAME_MIN_LENGTH: 3,
  NAME_MAX_LENGTH: 30,
  TAG_MIN_LENGTH: 2,
  TAG_MAX_LENGTH: 4,
  TAG_PATTERN: /^[A-Z0-9]+$/,  // Uppercase alphanumeric only
};

/**
 * Clan costs and limits
 */
export const CLAN_CONSTANTS = {
  CREATION_COST: {
    metal: 1500000,    // 1.5M Metal (admin configurable via server settings)
    energy: 1500000,   // 1.5M Energy (admin configurable via server settings)
  },
  MINIMUM_MEMBERS_TO_CREATE: 1,  // Solo players can create clans
  DEFAULT_MAX_MEMBERS: 20,        // Initial member cap
  TERRITORY_CLAIM_COST: {
    metal: 500,
    energy: 500,
  },
  WAR_DECLARATION_COST: {
    metal: 2000,
    energy: 2000,
  },
  DEFENSE_BONUS_PER_TILE: 10,     // +10% DEF per adjacent clan tile
  MAX_DEFENSE_BONUS: 50,          // Cap at +50% DEF
  MONUMENT_REQUIRED_TILES: 9,     // 3x3 grid
  CHAT_MESSAGE_MAX_LENGTH: 500,
  CHAT_HISTORY_LIMIT: 100,        // Last 100 messages
  CHAT_RETENTION_DAYS: 7,         // Keep messages for 7 days
  MAX_CLAN_LEVEL: 50,             // Maximum clan level
  BANK_BASE_CAPACITY: 1000000,    // 1M base capacity per resource
};

/**
 * Clan bank constants
 */
export const CLAN_BANK_CONSTANTS = {
  MIN_TAX_RATE: 0,
  MAX_TAX_RATE: 50,
  UPGRADE_COSTS: [
    { level: 2, metal: 50000, energy: 50000, rp: 100 },
    { level: 3, metal: 100000, energy: 100000, rp: 250 },
    { level: 4, metal: 200000, energy: 200000, rp: 500 },
    { level: 5, metal: 400000, energy: 400000, rp: 1000 },
    { level: 6, metal: 800000, energy: 800000, rp: 2000 },
  ],
  CAPACITY_MULTIPLIERS: [1, 1.5, 2, 3, 4, 6],  // Capacity multiplier per upgrade level
  TRANSACTION_HISTORY_LIMIT: 100,
};

/**
 * Helper function to calculate tax amount
 * 
 * @param amount - Amount to tax
 * @param taxRate - Tax rate (0-50)
 * @returns Tax amount
 * 
 * @example
 * const tax = calculateTaxAmount(1000, 10); // Returns 100 (10% of 1000)
 */
export function calculateTaxAmount(amount: number, taxRate: number): number {
  if (taxRate < CLAN_BANK_CONSTANTS.MIN_TAX_RATE || taxRate > CLAN_BANK_CONSTANTS.MAX_TAX_RATE) {
    throw new Error(`Tax rate must be between ${CLAN_BANK_CONSTANTS.MIN_TAX_RATE}% and ${CLAN_BANK_CONSTANTS.MAX_TAX_RATE}%`);
  }
  return Math.floor((amount * taxRate) / 100);
}

/**
 * Research tree definitions
 */
export const RESEARCH_TREE: Record<string, ClanResearch> = {
  // STRENGTH Branch
  strength_1: {
    researchId: 'strength_1',
    name: 'Basic Combat Training',
    description: '+2% Attack for all clan members',
    branch: ResearchBranch.STRENGTH,
    level: 0,
    maxLevel: 1,
    cost: { rp: 100 },
    bonuses: [{ type: 'attack', value: 2 }],
  },
  strength_2: {
    researchId: 'strength_2',
    name: 'Advanced Tactics',
    description: '+4% Attack for all clan members',
    branch: ResearchBranch.STRENGTH,
    level: 0,
    maxLevel: 1,
    cost: { rp: 250 },
    requires: ['strength_1'],
    bonuses: [{ type: 'attack', value: 4 }],
  },
  strength_3: {
    researchId: 'strength_3',
    name: 'Master Warfare',
    description: '+6% Attack for all clan members',
    branch: ResearchBranch.STRENGTH,
    level: 0,
    maxLevel: 1,
    cost: { rp: 500 },
    requires: ['strength_2'],
    bonuses: [{ type: 'attack', value: 6 }],
  },
  
  // DEFENSE Branch
  defense_1: {
    researchId: 'defense_1',
    name: 'Fortification Basics',
    description: '+2% Defense for all clan members',
    branch: ResearchBranch.DEFENSE,
    level: 0,
    maxLevel: 1,
    cost: { rp: 100 },
    bonuses: [{ type: 'defense', value: 2 }],
  },
  defense_2: {
    researchId: 'defense_2',
    name: 'Reinforced Positions',
    description: '+4% Defense for all clan members',
    branch: ResearchBranch.DEFENSE,
    level: 0,
    maxLevel: 1,
    cost: { rp: 250 },
    requires: ['defense_1'],
    bonuses: [{ type: 'defense', value: 4 }],
  },
  defense_3: {
    researchId: 'defense_3',
    name: 'Impenetrable Walls',
    description: '+6% Defense for all clan members',
    branch: ResearchBranch.DEFENSE,
    level: 0,
    maxLevel: 1,
    cost: { rp: 500 },
    requires: ['defense_2'],
    bonuses: [{ type: 'defense', value: 6 }],
  },
  
  // ECONOMIC Branch
  economic_1: {
    researchId: 'economic_1',
    name: 'Resource Efficiency',
    description: '+10% Metal and Energy yield for all clan members',
    branch: ResearchBranch.ECONOMIC,
    level: 0,
    maxLevel: 1,
    cost: { rp: 200 },
    bonuses: [
      { type: 'metal_yield', value: 10 },
      { type: 'energy_yield', value: 10 },
    ],
  },
  economic_2: {
    researchId: 'economic_2',
    name: 'Territory Expansion',
    description: '-20% cost for territory claims',
    branch: ResearchBranch.ECONOMIC,
    level: 0,
    maxLevel: 1,
    cost: { rp: 400 },
    requires: ['economic_1'],
    bonuses: [{ type: 'territory_cost_reduction', value: 20 }],
  },
  economic_3: {
    researchId: 'economic_3',
    name: 'Growing Empire',
    description: '+10 maximum clan members',
    branch: ResearchBranch.ECONOMIC,
    level: 0,
    maxLevel: 1,
    cost: { rp: 600 },
    requires: ['economic_2'],
    bonuses: [{ type: 'member_capacity', value: 10 }],
  },
};

/**
 * Monument definitions with bonuses
 */
export const MONUMENTS: Record<MonumentType, Omit<ClanMonument, '_id' | 'controllingClanId' | 'controlledSince'>> = {
  [MonumentType.ANCIENT_FORGE]: {
    monumentId: 'monument_forge',
    type: MonumentType.ANCIENT_FORGE,
    name: 'Ancient Forge',
    location: {
      centerX: 50,
      centerY: 50,
      requiredTiles: [
        { x: 49, y: 49 }, { x: 50, y: 49 }, { x: 51, y: 49 },
        { x: 49, y: 50 }, { x: 50, y: 50 }, { x: 51, y: 50 },
        { x: 49, y: 51 }, { x: 50, y: 51 }, { x: 51, y: 51 },
      ],
    },
    bonuses: [
      { type: 'metal_yield', value: 5, description: '+5% Metal harvest for all clan members' },
    ],
  },
  [MonumentType.WAR_MEMORIAL]: {
    monumentId: 'monument_memorial',
    type: MonumentType.WAR_MEMORIAL,
    name: 'War Memorial',
    location: {
      centerX: 75,
      centerY: 75,
      requiredTiles: [
        { x: 74, y: 74 }, { x: 75, y: 74 }, { x: 76, y: 74 },
        { x: 74, y: 75 }, { x: 75, y: 75 }, { x: 76, y: 75 },
        { x: 74, y: 76 }, { x: 75, y: 76 }, { x: 76, y: 76 },
      ],
    },
    bonuses: [
      { type: 'attack', value: 10, description: '+10% Attack for all clan members' },
    ],
  },
  [MonumentType.MARKET_PLAZA]: {
    monumentId: 'monument_market',
    type: MonumentType.MARKET_PLAZA,
    name: 'Market Plaza',
    location: {
      centerX: 25,
      centerY: 75,
      requiredTiles: [
        { x: 24, y: 74 }, { x: 25, y: 74 }, { x: 26, y: 74 },
        { x: 24, y: 75 }, { x: 25, y: 75 }, { x: 26, y: 75 },
        { x: 24, y: 76 }, { x: 25, y: 76 }, { x: 26, y: 76 },
      ],
    },
    bonuses: [
      { type: 'auction_fee_reduction', value: 5, description: '-5% auction fees (stacks with member benefit)' },
    ],
  },
  [MonumentType.RESEARCH_LAB]: {
    monumentId: 'monument_lab',
    type: MonumentType.RESEARCH_LAB,
    name: 'Research Laboratory',
    location: {
      centerX: 75,
      centerY: 25,
      requiredTiles: [
        { x: 74, y: 24 }, { x: 75, y: 24 }, { x: 76, y: 24 },
        { x: 74, y: 25 }, { x: 75, y: 25 }, { x: 76, y: 25 },
        { x: 74, y: 26 }, { x: 75, y: 26 }, { x: 76, y: 26 },
      ],
    },
    bonuses: [
      { type: 'rp_gain', value: 15, description: '+15% RP gain for all clan members' },
    ],
  },
  [MonumentType.GRAND_TEMPLE]: {
    monumentId: 'monument_temple',
    type: MonumentType.GRAND_TEMPLE,
    name: 'Grand Temple',
    location: {
      centerX: 25,
      centerY: 25,
      requiredTiles: [
        { x: 24, y: 24 }, { x: 25, y: 24 }, { x: 26, y: 24 },
        { x: 24, y: 25 }, { x: 25, y: 25 }, { x: 26, y: 25 },
        { x: 24, y: 26 }, { x: 25, y: 26 }, { x: 26, y: 26 },
      ],
    },
    bonuses: [
      { type: 'xp_gain', value: 5, description: '+5% XP gain for all clan members' },
    ],
  },
};

// ============================================================================
// XP AND LEVEL PROGRESSION TYPES
// ============================================================================

/**
 * Clan XP source types (for tracking where XP comes from)
 */
export type ClanXPSource =
  | 'harvest'
  | 'combat'
  | 'research'
  | 'building'
  | 'territory_claim'
  | 'monument_control'
  | 'member_join'
  | 'clan_created';

/**
 * Clan milestone rewards at specific levels
 */
export interface ClanMilestone {
  level: number;
  rewards: {
    metal: number;
    energy: number;
    researchPoints: number;
  };
  unlocksFeature?: string;
  description: string;
}

/**
 * Clan level constants
 */
export const CLAN_LEVEL_CONSTANTS = {
  MAX_LEVEL: 50,
  BASE_XP_REQUIREMENT: 1000,   // Base XP for level 2
  XP_EXPONENT: 1.8,             // Exponential curve exponent
} as const;

/**
 * XP rates for different actions (XP per unit)
 */
export const CLAN_XP_RATES: Record<ClanXPSource, number> = {
  harvest: 0.005,              // 5 XP per 1000 resources
  combat: 10,                  // 10 XP per enemy defeated
  research: 0.015,             // 15 XP per 1000 RP contributed
  building: 20,                // 20 XP per building completed
  territory_claim: 50,         // 50 XP per territory claimed
  monument_control: 100,       // 100 XP per monument controlled
  member_join: 25,             // 25 XP when member joins
  clan_created: 100,           // 100 XP for creating clan
};

/**
 * Milestone rewards at key levels
 */
export const CLAN_MILESTONES: ClanMilestone[] = [
  {
    level: 5,
    rewards: { metal: 50000, energy: 50000, researchPoints: 5000 },
    unlocksFeature: 'bronze_perks',
    description: 'Unlocks Bronze tier perks and rewards',
  },
  {
    level: 10,
    rewards: { metal: 100000, energy: 100000, researchPoints: 10000 },
    unlocksFeature: 'silver_perks',
    description: 'Unlocks Silver tier perks and increased rewards',
  },
  {
    level: 15,
    rewards: { metal: 250000, energy: 250000, researchPoints: 25000 },
    unlocksFeature: 'gold_perks',
    description: 'Unlocks Gold tier perks and major rewards',
  },
  {
    level: 20,
    rewards: { metal: 500000, energy: 500000, researchPoints: 50000 },
    unlocksFeature: 'legendary_perks',
    description: 'Unlocks Legendary perks and monument access',
  },
  {
    level: 25,
    rewards: { metal: 1000000, energy: 1000000, researchPoints: 100000 },
    unlocksFeature: 'warfare',
    description: 'Unlocks clan warfare and massive rewards',
  },
  {
    level: 30,
    rewards: { metal: 2000000, energy: 2000000, researchPoints: 200000 },
    unlocksFeature: 'advanced_monuments',
    description: 'Unlocks advanced monument control',
  },
  {
    level: 40,
    rewards: { metal: 5000000, energy: 5000000, researchPoints: 500000 },
    unlocksFeature: 'elite_warfare',
    description: 'Unlocks elite warfare bonuses',
  },
  {
    level: 50,
    rewards: { metal: 10000000, energy: 10000000, researchPoints: 1000000 },
    unlocksFeature: 'prestige_badge',
    description: 'Maximum level! Prestige badge and ultimate rewards',
  },
];

// ============================================================================
// PERK SYSTEM CONSTANTS
// ============================================================================

/**
 * Perk system limits
 */
export const CLAN_PERK_LIMITS = {
  MAX_ACTIVE_PERKS: 4,          // Maximum perks active at once
} as const;

/**
 * Perk catalog - all available perks
 */
export const CLAN_PERK_CATALOG: ClanPerk[] = [
  // ===== BRONZE TIER (Level 5+) =====
  {
    id: 'combat_bronze_berserker',
    name: 'Bronze Berserker',
    description: '+5% attack damage for all clan members',
    category: ClanPerkCategory.COMBAT,
    tier: ClanPerkTier.BRONZE,
    requiredLevel: 5,
    cost: { metal: 100000, energy: 100000, researchPoints: 10000 },
    bonus: { type: 'attack', value: 5 },
  },
  {
    id: 'combat_bronze_fortress',
    name: 'Bronze Fortress',
    description: '+5% defense for all clan members',
    category: ClanPerkCategory.COMBAT,
    tier: ClanPerkTier.BRONZE,
    requiredLevel: 5,
    cost: { metal: 100000, energy: 100000, researchPoints: 10000 },
    bonus: { type: 'defense', value: 5 },
  },
  {
    id: 'economic_bronze_prosperity',
    name: 'Bronze Prosperity',
    description: '+5% resource yield from harvesting',
    category: ClanPerkCategory.ECONOMIC,
    tier: ClanPerkTier.BRONZE,
    requiredLevel: 5,
    cost: { metal: 100000, energy: 100000, researchPoints: 10000 },
    bonus: { type: 'resource_yield', value: 5 },
  },
  {
    id: 'social_bronze_growth',
    name: 'Bronze Growth',
    description: '+5% XP gain for clan leveling',
    category: ClanPerkCategory.SOCIAL,
    tier: ClanPerkTier.BRONZE,
    requiredLevel: 5,
    cost: { metal: 100000, energy: 100000, researchPoints: 10000 },
    bonus: { type: 'xp_gain', value: 5 },
  },
  
  // ===== SILVER TIER (Level 10+) =====
  {
    id: 'combat_silver_conqueror',
    name: 'Silver Conqueror',
    description: '+10% attack damage for all clan members',
    category: ClanPerkCategory.COMBAT,
    tier: ClanPerkTier.SILVER,
    requiredLevel: 10,
    cost: { metal: 250000, energy: 250000, researchPoints: 25000 },
    bonus: { type: 'attack', value: 10 },
  },
  {
    id: 'combat_silver_bulwark',
    name: 'Silver Bulwark',
    description: '+10% defense for all clan members',
    category: ClanPerkCategory.COMBAT,
    tier: ClanPerkTier.SILVER,
    requiredLevel: 10,
    cost: { metal: 250000, energy: 250000, researchPoints: 25000 },
    bonus: { type: 'defense', value: 10 },
  },
  {
    id: 'economic_silver_abundance',
    name: 'Silver Abundance',
    description: '+10% resource yield from harvesting',
    category: ClanPerkCategory.ECONOMIC,
    tier: ClanPerkTier.SILVER,
    requiredLevel: 10,
    cost: { metal: 250000, energy: 250000, researchPoints: 25000 },
    bonus: { type: 'resource_yield', value: 10 },
  },
  {
    id: 'strategic_silver_expansion',
    name: 'Silver Expansion',
    description: '-10% territory claiming costs',
    category: ClanPerkCategory.STRATEGIC,
    tier: ClanPerkTier.SILVER,
    requiredLevel: 10,
    cost: { metal: 250000, energy: 250000, researchPoints: 25000 },
    bonus: { type: 'territory_cost', value: 10 },
  },
  
  // ===== GOLD TIER (Level 15+) =====
  {
    id: 'combat_gold_destroyer',
    name: 'Gold Destroyer',
    description: '+15% attack damage for all clan members',
    category: ClanPerkCategory.COMBAT,
    tier: ClanPerkTier.GOLD,
    requiredLevel: 15,
    cost: { metal: 500000, energy: 500000, researchPoints: 50000 },
    bonus: { type: 'attack', value: 15 },
  },
  {
    id: 'combat_gold_impenetrable',
    name: 'Gold Impenetrable',
    description: '+15% defense for all clan members',
    category: ClanPerkCategory.COMBAT,
    tier: ClanPerkTier.GOLD,
    requiredLevel: 15,
    cost: { metal: 500000, energy: 500000, researchPoints: 50000 },
    bonus: { type: 'defense', value: 15 },
  },
  {
    id: 'economic_gold_wealth',
    name: 'Gold Wealth',
    description: '+15% resource yield from harvesting',
    category: ClanPerkCategory.ECONOMIC,
    tier: ClanPerkTier.GOLD,
    requiredLevel: 15,
    cost: { metal: 500000, energy: 500000, researchPoints: 50000 },
    bonus: { type: 'resource_yield', value: 15 },
  },
  {
    id: 'social_gold_unity',
    name: 'Gold Unity',
    description: '+10% XP gain for clan leveling',
    category: ClanPerkCategory.SOCIAL,
    tier: ClanPerkTier.GOLD,
    requiredLevel: 15,
    cost: { metal: 500000, energy: 500000, researchPoints: 50000 },
    bonus: { type: 'xp_gain', value: 10 },
  },
  
  // ===== LEGENDARY TIER (Level 20+) =====
  {
    id: 'combat_legendary_annihilator',
    name: 'Legendary Annihilator',
    description: '+20% attack damage for all clan members',
    category: ClanPerkCategory.COMBAT,
    tier: ClanPerkTier.LEGENDARY,
    requiredLevel: 20,
    cost: { metal: 1000000, energy: 1000000, researchPoints: 100000 },
    bonus: { type: 'attack', value: 20 },
  },
  {
    id: 'combat_legendary_invincible',
    name: 'Legendary Invincible',
    description: '+20% defense for all clan members',
    category: ClanPerkCategory.COMBAT,
    tier: ClanPerkTier.LEGENDARY,
    requiredLevel: 20,
    cost: { metal: 1000000, energy: 1000000, researchPoints: 100000 },
    bonus: { type: 'defense', value: 20 },
  },
  {
    id: 'economic_legendary_empire',
    name: 'Legendary Empire',
    description: '+20% resource yield from harvesting',
    category: ClanPerkCategory.ECONOMIC,
    tier: ClanPerkTier.LEGENDARY,
    requiredLevel: 20,
    cost: { metal: 1000000, energy: 1000000, researchPoints: 100000 },
    bonus: { type: 'resource_yield', value: 20 },
  },
  {
    id: 'strategic_legendary_dominion',
    name: 'Legendary Dominion',
    description: '-20% territory claiming costs',
    category: ClanPerkCategory.STRATEGIC,
    tier: ClanPerkTier.LEGENDARY,
    requiredLevel: 20,
    cost: { metal: 1000000, energy: 1000000, researchPoints: 100000 },
    bonus: { type: 'territory_cost', value: 20 },
  },
];

/**
 * IMPLEMENTATION NOTES:
 * 
 * 1. Clan Creation Requirements:
 *    - 1000 Metal + 1000 Energy cost
 *    - Unique clan tag (2-4 uppercase alphanumeric characters)
 *    - Unique clan name (3-30 characters)
 *    - Leader automatically assigned LEADER role
 *    - Solo players can create clans (no minimum member requirement)
 * 
 * 2. Member Management:
 *    - LEADER: Full control (disband, transfer leadership, promote to any role, kick anyone)
 *    - CO_LEADER: Second-in-command (promote to Officer/Elite, manage wars/territories, kick Members/Recruits)
 *    - OFFICER: Management (promote Members to Elite, kick Members/Recruits, invite, manage territories/research)
 *    - ELITE: Veteran (invite members, +15% RP contribution bonus, priority war deployment)
 *    - MEMBER: Standard (contribute RP/resources, participate in chat, view clan info)
 *    - RECRUIT: Trial period (50% RP contribution, 24-hour chat restriction, basic access)
 *    - Max 1 clan per player (enforced at join/create)
 * 
 * 3. Research System:
 *    - 9 total research nodes across 3 branches
 *    - Shared RP pool contributed by all members
 *    - Research unlocks apply permanent bonuses to all clan members
 *    - Prerequisites enforce tech tree progression
 * 
 * 4. Territory Mechanics:
 *    - Claiming costs 500 Metal + 500 Energy per tile
 *    - Territory must be adjacent to existing clan tiles (no islands)
 *    - Defense bonus: +10% DEF per adjacent clan tile (max +50%)
 *    - Territory can be captured during active wars
 * 
 * 5. Warfare System:
 *    - War declaration costs 2000 Metal + 2000 Energy
 *    - Wars have DECLARED â†’ ACTIVE â†’ ENDED lifecycle
 *    - Territory capture only allowed during ACTIVE war status
 *    - Battle logs integrated with activity logging system
 * 
 * 6. Monument Control:
 *    - Requires full 3x3 grid (9 tiles) around monument center
 *    - Permanent bonuses while controlled
 *    - Can be contested during clan wars
 *    - Only one clan can control each monument at a time
 * 
 * 7. Social Features:
 *    - Clan chat with 100 message history, 7-day retention
 *    - Officer/Leader channels for leadership discussions
 *    - Activity feed tracking all clan events
 *    - Integration with activity logging for analytics
 * 
 * 8. Member Benefits:
 *    - 0% auction house fees (vs 5% for non-clan)
 *    - Research bonuses apply to all members
 *    - Monument bonuses apply to all members
 *    - Territory defense bonuses when on clan land
 */

@@@END@@@
@@@FILE:types/flag.types.ts@@@
/**
 * @file types/flag.types.ts
 * @created 2025-10-20
 * @overview Flag Bearer tracking system types and interfaces
 * 
 * OVERVIEW:
 * Type definitions for the Flag Bearer tracking mechanic where one player
 * carries the flag and other players hunt them down. Includes position tracking,
 * distance calculations, compass directions, and attack range validation.
 * 
 * Key Concepts:
 * - Flag Bearer: The player currently holding the flag
 * - Tracker: Any player viewing the Flag Tracker Panel
 * - Attack Range: Distance within which a player can attack the bearer
 * - Compass Direction: Cardinal/intercardinal directions (N, NE, E, etc.)
 */

/**
 * Compass direction from tracker to Flag Bearer
 * Uses 8-directional compass rose (cardinal + intercardinal)
 */
export enum CompassDirection {
  North = 'N',
  NorthEast = 'NE',
  East = 'E',
  SouthEast = 'SE',
  South = 'S',
  SouthWest = 'SW',
  West = 'W',
  NorthWest = 'NW'
}

/**
 * Flag Bearer player information
 */
export interface FlagBearer {
  /** Player ID of current flag bearer */
  playerId: string;
  
  /** Player username */
  username: string;
  
  /** Player level */
  level: number;
  
  /** Current position on 150x150 grid (1-indexed) */
  position: {
    x: number;
    y: number;
  };
  
  /** Timestamp when this player claimed the flag */
  claimedAt: Date;
  
  /** How long they've held the flag (in seconds) */
  holdDuration: number;
  
  /** Player's current HP (for attack calculations) */
  currentHP?: number;
  
  /** Player's max HP */
  maxHP?: number;
}

/**
 * Tracker data - calculated relationship between viewer and Flag Bearer
 */
export interface FlagTrackerData {
  /** Current Flag Bearer (null if no one has flag) */
  bearer: FlagBearer | null;
  
  /** Distance in tiles from tracker to bearer */
  distance: number;
  
  /** Compass direction from tracker to bearer */
  direction: CompassDirection;
  
  /** Whether bearer is within attack range */
  inAttackRange: boolean;
  
  /** Tracker's current position (for calculations) */
  trackerPosition: {
    x: number;
    y: number;
  };
}

/**
 * Flag attack request
 */
export interface FlagAttackRequest {
  /** Target player ID (Flag Bearer) */
  targetPlayerId: string;
  
  /** Attacker's current position (for range validation) */
  attackerPosition: {
    x: number;
    y: number;
  };
}

/**
 * Flag attack response
 */
export interface FlagAttackResponse {
  /** Whether attack was successful */
  success: boolean;
  
  /** Error message if attack failed */
  error?: string;
  
  /** Damage dealt (if successful) */
  damage?: number;
  
  /** Whether Flag Bearer was defeated */
  bearerDefeated?: boolean;
  
  /** New Flag Bearer ID (if previous bearer defeated and flag claimed) */
  newBearerId?: string;
}

/**
 * WebSocket event for flag position updates
 */
export interface FlagPositionUpdateEvent {
  /** Event type identifier */
  type: 'flag:position';
  
  /** Updated Flag Bearer data */
  bearer: FlagBearer;
  
  /** Timestamp of update */
  timestamp: Date;
}

/**
 * WebSocket event for flag ownership changes
 */
export interface FlagOwnershipChangeEvent {
  /** Event type identifier */
  type: 'flag:ownership';
  
  /** Previous bearer ID (null if flag was unclaimed) */
  previousBearerId: string | null;
  
  /** New bearer ID (null if flag dropped/lost) */
  newBearerId: string | null;
  
  /** New bearer data */
  newBearer: FlagBearer | null;
  
  /** Reason for ownership change */
  reason: 'claimed' | 'defeated' | 'dropped' | 'expired';
  
  /** Timestamp of change */
  timestamp: Date;
}

/**
 * Flag configuration constants
 */
export const FLAG_CONFIG = {
  /** Attack range in tiles (can attack if within this distance) */
  ATTACK_RANGE: 5,
  
  /** Maximum hold duration before flag auto-drops (seconds) */
  MAX_HOLD_DURATION: 3600, // 1 hour
  
  /** Cooldown between attacks (seconds) */
  ATTACK_COOLDOWN: 60,
  
  /** Base damage for flag attacks */
  BASE_ATTACK_DAMAGE: 100,
  
  /** Flag position update interval (ms) */
  POSITION_UPDATE_INTERVAL: 5000, // 5 seconds
} as const;

/**
 * Helper type for flag-related API responses
 */
export interface FlagAPIResponse<T = unknown> {
  success: boolean;
  data?: T;
  error?: string;
  timestamp: Date;
}

/**
 * IMPLEMENTATION NOTES:
 * 
 * 1. **Flag Bearer System:**
 *    - Only one player can hold flag at a time
 *    - Bearer position updates every 5 seconds via WebSocket
 *    - Flag auto-drops after 1 hour of holding
 *    - Bearer can be attacked within 5-tile range
 * 
 * 2. **Distance Calculation:**
 *    - Uses Euclidean distance: sqrt((x2-x1)^2 + (y2-y1)^2)
 *    - Rounded to nearest integer tile
 *    - Attack range is circular (not square grid)
 * 
 * 3. **Compass Direction:**
 *    - 8 directions (N, NE, E, SE, S, SW, W, NW)
 *    - Calculated from angle between tracker and bearer
 *    - Visual compass rose in UI
 * 
 * 4. **WebSocket Events:**
 *    - flag:position - Bearer moved (every 5s or on significant move)
 *    - flag:ownership - Bearer changed (claimed, defeated, dropped)
 *    - Real-time updates to all connected players
 * 
 * 5. **Attack Mechanics:**
 *    - Must be within 5 tiles to attack
 *    - 60 second cooldown between attacks
 *    - Defeating bearer allows claiming the flag
 *    - Base damage: 100 HP
 */

@@@END@@@
@@@FILE:types/game.types.ts@@@
/**
 * @file game.types.ts
 * @created 2025-10-16
 * @overview Core TypeScript type definitions for DarkFrame game domain model
 * 
 * OVERVIEW:
 * Defines all core game entities including terrain types, tiles, players, positions,
 * movement directions, and resources. These types are used throughout the application
 * for type safety and data validation.
 */

import { type ObjectId } from 'mongodb';

/**
 * Terrain types available in the game world
 * 
 * Distribution across 150Ã—150 map (22,500 total tiles):
 * - Metal: 4,500 tiles (20%)
 * - Energy: 4,500 tiles (20%)
 * - Cave: 1,800 tiles (8%)
 * - Forest: 450 tiles (2%) - Better loot than caves
 * - Factory: 2,250 tiles (10%)
 * - Wasteland: 8,500 tiles (38%)
 * - Bank: 4 fixed locations (Phase 3+)
 * - Shrine: 1 fixed location at (1,1) (Phase 3+)
 */
export enum TerrainType {
  Metal = 'Metal',
  Energy = 'Energy',
  Cave = 'Cave',
  Forest = 'Forest',
  Factory = 'Factory',
  Wasteland = 'Wasteland',
  Bank = 'Bank',
  Shrine = 'Shrine'
}

/**
 * Position coordinates on the game map
 * 
 * @property x - Horizontal coordinate (1-150)
 * @property y - Vertical coordinate (1-150)
 */
export interface Position {
  x: number;
  y: number;
}

/**
 * Bank types for different bank locations
 */
export type BankType = 'metal' | 'energy' | 'exchange';

/**
 * Tile entity representing a single map location
 * 
 * @property x - Horizontal coordinate (1-150)
 * @property y - Vertical coordinate (1-150)
 * @property terrain - Type of terrain for this tile
 * @property occupiedByBase - Optional flag indicating if a player base is present
 * @property baseOwner - Username of the player who owns the base (if occupiedByBase is true)
 * @property lastHarvestedBy - Array tracking which players have harvested this tile in current reset period
 * @property bankType - Bank type if terrain is Bank (Phase 3+)
 */
export interface Tile {
  x: number;
  y: number;
  terrain: TerrainType;
  occupiedByBase?: boolean;
  baseOwner?: string;
  baseGreeting?: string;
  lastHarvestedBy?: HarvestRecord[];
  bankType?: BankType;
}

/**
 * Harvest record tracking per-player harvests with reset period
 * 
 * @property playerId - Player's unique username
 * @property timestamp - When the harvest occurred
 * @property resetPeriod - Reset period identifier (e.g., "2025-10-16-AM" or "2025-10-16-PM")
 */
export interface HarvestRecord {
  playerId: string;
  timestamp: Date;
  resetPeriod: string;
}

/**
 * Resource tracking for player inventory
 * 
 * @property metal - Amount of metal resource
 * @property energy - Amount of energy resource
 */
export interface Resources {
  metal: number;
  energy: number;
}

/**
 * Player entity with all player-related data
 * 
 * @property username - Unique player identifier
 * @property email - Player's email address for login
 * @property password - Hashed password (bcrypt)
 * @property base - Permanent base location (spawn point)
 * @property currentPosition - Current location on the map
 * @property resources - Resource inventory
 * @property bank - Banked resources (safe storage)
 * @property rank - Player rank/level (1-6+) for base visuals
 * @property inventory - Player's collected items from cave exploration
 * @property gatheringBonus - Permanent gathering boost from digger items
 * @property activeBoosts - Temporary boosts from trading items (DEPRECATED: use shrineBoosts)
 * @property shrineBoosts - Active shrine boosts for resource yield
 * @property units - Army units owned by player
 * @property totalStrength - Total offensive power (sum of all unit STR)
 * @property totalDefense - Total defensive power (sum of all unit DEF)
 * @property createdAt - Account creation timestamp
 */
/**
 * Army balance effects and penalties/bonuses
 * Calculated based on STR/DEF ratio to encourage balanced armies
 */
export type BalanceStatus = 'CRITICAL' | 'IMBALANCED' | 'BALANCED' | 'OPTIMAL';

export interface BalanceEffects {
  ratio: number;
  status: BalanceStatus;
  powerMultiplier: number;          // Applied to total power (0.5 to 1.1)
  damageTakenMultiplier: number;    // Multiplier for incoming damage (0.95 to 1.3)
  damageDealtMultiplier: number;    // Multiplier for outgoing damage (0.8 to 1.05)
  gatheringMultiplier: number;      // Applied to resource gathering (0.75 to 1.1)
  slotRegenMultiplier: number;      // Applied to slot regeneration (0.85 to 1.0)
  effectivePower: number;           // Final power after balance multiplier
  warnings: string[];               // Active penalty messages
  bonuses: string[];                // Active bonus messages
  recommendation?: string;          // How to improve balance
}

/**
 * Specialization doctrine types for player progression paths
 */
export enum SpecializationDoctrine {
  None = 'none',
  Offensive = 'offensive',
  Defensive = 'defensive',
  Tactical = 'tactical'
}

/**
 * Discovery category types for ancient technologies
 */
export enum DiscoveryCategory {
  Industrial = 'industrial',
  Combat = 'combat',
  Strategic = 'strategic'
}

/**
 * Ancient technology discovery
 * 
 * @property id - Unique discovery identifier (e.g., 'AUTO_HARVESTER')
 * @property name - Display name of the technology
 * @property category - Category classification
 * @property description - Detailed description of the technology
 * @property bonus - Human-readable bonus description
 * @property discoveredAt - When the technology was discovered
 * @property discoveredInCave - Cave location where it was found
 */
export interface Discovery {
  id: string;
  name: string;
  category: DiscoveryCategory;
  description: string;
  bonus: string;
  discoveredAt: Date;
  discoveredInCave: { x: number; y: number };
}

/**
 * Specialization data structure for player doctrine tracking
 * 
 * @property doctrine - Selected specialization path
 * @property selectedAt - When specialization was chosen
 * @property masteryLevel - Mastery progression (0-100%)
 * @property masteryXP - XP toward next mastery level
 * @property totalUnitsBuilt - Count of specialized units built
 * @property totalBattlesWon - Battles won with specialized units
 * @property respecHistory - History of respec changes
 * @property lastRespecAt - Last respec timestamp (for cooldown)
 */
export interface Specialization {
  doctrine: SpecializationDoctrine;
  selectedAt: Date;
  masteryLevel: number; // 0-100
  masteryXP: number;
  totalUnitsBuilt: number;
  totalBattlesWon: number;
  respecHistory: Array<{
    fromDoctrine: SpecializationDoctrine;
    toDoctrine: SpecializationDoctrine;
    timestamp: Date;
    rpSpent: number;
    resourcesSpent: { metal: number; energy: number };
  }>;
  lastRespecAt: Date | null;
}

/**
 * Achievement category types
 */
export enum AchievementCategory {
  Combat = 'combat',
  Economic = 'economic',
  Exploration = 'exploration',
  Progression = 'progression'
}

/**
 * Achievement rarity/difficulty
 */
export enum AchievementRarity {
  Common = 'common',
  Rare = 'rare',
  Epic = 'epic',
  Legendary = 'legendary'
}

/**
 * Achievement unlock with prestige unit reward
 * 
 * @property id - Unique achievement identifier
 * @property name - Display name
 * @property description - Achievement requirement description
 * @property category - Achievement category
 * @property rarity - Difficulty tier
 * @property reward - Prestige unit unlocked and RP bonus
 * @property unlockedAt - When achievement was earned
 */
export interface Achievement {
  id: string;
  name: string;
  description: string;
  category: AchievementCategory;
  rarity: AchievementRarity;
  requirement: {
    type: string;
    value: number;
  };
  reward: {
    unitUnlock: string;
    rpBonus?: number;
  };
  unlockedAt?: Date;
  progress?: number;
}

/**
 * Player statistics for achievement tracking
 * 
 * @property battlesWon - Total PvP battles won
 * @property totalUnitsBuilt - Total units built across all types
 * @property totalResourcesGathered - Lifetime resources collected
 * @property totalResourcesBanked - Lifetime resources stored in banks
 * @property shrineTradeCount - Number of shrine trades completed
 * @property cavesExplored - Total cave and forest explorations
 */
export interface PlayerStats {
  battlesWon: number;
  totalUnitsBuilt: number;
  totalResourcesGathered: number;
  totalResourcesBanked: number;
  shrineTradeCount: number;
  cavesExplored: number;
}

/**
 * Battle statistics for profile display
 * 
 * @property infantryAttacks - Infantry battle statistics (Player vs Player direct combat)
 * @property baseAttacks - Base attack statistics (future PvP system)
 * @property baseDefenses - Base defense statistics (future PvP system)
 */
export interface BattleStatistics {
  infantryAttacks: { initiated: number; won: number; lost: number };
  baseAttacks: { initiated: number; won: number; lost: number };
  baseDefenses: { total: number; won: number; lost: number };
}

/**
 * Bot specialization types - defines bot behavior and stats
 */
export enum BotSpecialization {
  Hoarder = 'hoarder',        // 25% - High resources, low defense, stationary
  Fortress = 'fortress',      // 20% - High defense, low resources, stationary
  Raider = 'raider',         // 25% - Aggressive, mobile, attacks frequently
  Ghost = 'ghost',           // 15% - Teleports randomly, high resources
  Balanced = 'balanced'      // 15% - Standard stats, moderate movement
}

/**
 * Bot reputation tiers based on defeats
 */
export enum BotReputation {
  Unknown = 'unknown',         // 0-5 defeats
  Notorious = 'notorious',     // 6-15 defeats
  Infamous = 'infamous',       // 16-30 defeats
  Legendary = 'legendary'      // 31+ defeats
}

/**
 * Bot configuration for AI-controlled players
 * Full Permanence Model: Bots stay on map, regenerate resources hourly
 * 
 * @property specialization - Bot behavior type (Hoarder/Fortress/Raider/Ghost/Balanced)
 * @property tier - Resource tier (1-3) determining max resources
 * @property lastGrowth - Last time bot's resources grew
 * @property lastResourceRegen - Last time resources regenerated after defeat
 * @property attackCooldown - When bot can attack again
 * @property revengeTarget - Username of player who last defeated this bot (60% chance retaliation)
 * @property isSpecialBase - Is this a Beer Base (3x resources, despawns when defeated)
 * @property lastDefeated - When bot was last defeated (for scanner display)
 * @property defeatedCount - Total times defeated (for reputation system)
 * @property reputation - Current reputation tier (Unknown/Notorious/Infamous/Legendary)
 * @property movement - Movement pattern (stationary/roam/teleport)
 * @property zone - Map zone assignment (0-8 for 9 zones)
 * @property nestAffinity - Which nest this bot is affiliated with (null if not near nest)
 * @property bountyValue - Current bounty reward if targeted
 * @property permanentBase - True (all bots have permanent bases)
 */
export interface BotConfig {
  specialization: BotSpecialization;
  tier: number; // 1-3
  lastGrowth: Date;
  lastResourceRegen?: Date;
  attackCooldown?: Date;
  revengeTarget?: string;
  isSpecialBase: boolean;
  lastDefeated?: Date;
  defeatedCount: number;
  reputation: BotReputation;
  movement: 'stationary' | 'roam' | 'teleport';
  zone: number; // 0-8
  nestAffinity: number | null; // 0-7 for 8 nests
  bountyValue: number;
  permanentBase: boolean;
  summonedBy?: ObjectId; // Player who summoned this bot (Bot Summoning Circle)
  summonedAt?: Date; // When this bot was summoned
}

export interface Player {
  username: string;
  email: string;
  password: string; // Hashed with bcrypt
  base: Position;
  currentPosition: Position;
  resources: Resources;
  bank: BankStorage;
  rank?: number; // Player rank for base progression (defaults to 1)
  inventory: PlayerInventory;
  gatheringBonus: GatheringBonus;
  activeBoosts: ActiveBoosts; // DEPRECATED: use shrineBoosts instead
  shrineBoosts: ShrineBoost[];
  units: PlayerUnit[]; // Player's army (simplified unit data)
  totalStrength: number; // Total STR from all units
  totalDefense: number; // Total DEF from all units
  balanceEffects?: BalanceEffects; // Army balance status and multipliers (calculated)
  xp: number; // Total experience points earned
  level: number; // Current level (calculated from XP)
  researchPoints: number; // Research points for unlocking features
  unlockedTiers: UnitTier[]; // Unit tiers unlocked via RP spending
  unlockedTechs?: string[]; // Tech tree unlocks (e.g., 'bot-hunter', 'bot-magnet', 'bot-concentration-zones')
  concentrationZones?: Array<{ centerX: number; centerY: number; size: number; name?: string }>; // Bot spawn zones (max 3, 30Ã—30 each)
  lastBotSummon?: Date; // Last time bots were summoned via Bot Summoning Circle (7-day cooldown)
  fastTravelWaypoints?: Array<{ name: string; x: number; y: number; setAt: Date }>; // Fast travel waypoints (max 5)
  lastFastTravel?: Date; // Last time fast travel was used (12-hour cooldown)
  dailyBounties?: {
    bounties: Array<{
      id: string;
      difficulty: 'easy' | 'medium' | 'hard';
      specialization: 'Hoarder' | 'Fortress' | 'Raider' | 'Balanced' | 'Ghost';
      tier: number;
      defeatsRequired: number;
      currentDefeats: number;
      metalReward: number;
      energyReward: number;
      completed: boolean;
      claimed: boolean;
    }>;
    lastRefresh: Date;
    unclaimedRewards: number;
  }; // Daily bot defeat bounties (3 per day)
  specialization?: Specialization; // Player's specialization doctrine (Level 15+)
  discoveries?: Discovery[]; // Ancient technologies discovered (Phase 2+)
  achievements?: Achievement[]; // Unlocked achievements with prestige units (Phase 3+)
  stats?: PlayerStats; // Gameplay statistics for achievement tracking (Phase 3+)
  factoryCount?: number; // Number of factories owned
  lastXPAward?: Date; // Last time XP was awarded
  lastLevelUp?: Date; // Last time player leveled up
  rpHistory?: ResearchPointHistory[]; // History of RP spending
  baseGreeting?: string; // Custom base greeting message (max 500 chars)
  battleStats?: BattleStatistics; // Combat statistics for profile display
  isBot?: boolean; // Bot player flag (excluded from leaderboards)
  botConfig?: BotConfig; // Bot-specific configuration (only present if isBot=true)
  clanId?: string; // ID of clan player belongs to (Phase 5-8)
  clanName?: string; // Name of player's clan (denormalized for quick access)
  clanRole?: string; // Player's role in clan (LEADER, CO_LEADER, OFFICER, MEMBER, etc.)
  clanLevel?: number; // Clan's current level (denormalized for quick access)
  isAdmin?: boolean; // Admin access flag (grants access to /admin panel)
  isVIP?: boolean; // VIP subscription status (premium features: 2x auto-farm speed, etc.)
  vipExpiresAt?: Date; // VIP subscription expiration date
  lastLoginDate?: Date; // Last time player logged in (for daily reward tracking)
  loginStreak?: number; // Consecutive days logged in (for streak bonuses)
  lastStreakReward?: Date; // Last time daily login reward was claimed
  createdAt?: Date;
}

/**
 * Research point spending history
 */
export interface ResearchPointHistory {
  amount: number; // Negative for spending, positive for earning
  reason: string; // What the RP was spent on or earned from
  timestamp: Date;
  balance: number; // RP balance after transaction
}

/**
 * Player inventory system
 * 
 * @property items - Array of collected items
 * @property capacity - Maximum number of items (default: 2000)
 * @property metalDiggerCount - Count of metal diggers collected (for diminishing returns)
 * @property energyDiggerCount - Count of energy diggers collected (for diminishing returns)
 */
export interface PlayerInventory {
  items: InventoryItem[];
  capacity: number;
  metalDiggerCount: number;
  energyDiggerCount: number;
}

/**
 * Permanent gathering bonus from digger items
 * 
 * @property metalBonus - Percentage boost to metal gathering (cumulative from diggers)
 * @property energyBonus - Percentage boost to energy gathering (cumulative from diggers)
 */
export interface GatheringBonus {
  metalBonus: number; // Percentage (e.g., 25 = +25%)
  energyBonus: number; // Percentage (e.g., 30 = +30%)
}

/**
 * Active temporary boosts from trading
 * @deprecated Use shrineBoosts instead for Phase 3+
 * 
 * @property gatheringBoost - Temporary % boost to all gathering
 * @property expiresAt - When the boost expires (null if no boost active)
 */
export interface ActiveBoosts {
  gatheringBoost: number | null; // Percentage (e.g., 50 = +50%)
  expiresAt: Date | null;
}

/**
 * Bank storage for safe resource keeping
 * 
 * @property metal - Banked metal amount
 * @property energy - Banked energy amount
 * @property lastDeposit - Timestamp of last deposit (for audit)
 */
export interface BankStorage {
  metal: number;
  energy: number;
  lastDeposit: Date | null;
}

/**
 * Shrine boost tier types
 */
export type ShrineBoostTier = 'speed' | 'heart' | 'diamond' | 'club';

/**
 * Active shrine boost for resource gathering yield
 * 
 * @property tier - Boost tier (speed/heart/diamond/club)
 * @property expiresAt - When the boost expires
 * @property yieldBonus - Resource yield bonus (0.25 = +25%)
 */
export interface ShrineBoost {
  tier: ShrineBoostTier;
  expiresAt: Date;
  yieldBonus: number; // Always 0.25 (+25% per boost)
}

/**
 * Item types for cave drops
 */
export enum ItemType {
  // Permanent digger items
  MetalDigger = 'METAL_DIGGER',
  EnergyDigger = 'ENERGY_DIGGER',
  UniversalDigger = 'UNIVERSAL_DIGGER',
  
  // Tradeable items for temporary boosts
  TradeableItem = 'TRADEABLE_ITEM'
}

/**
 * Item rarity tiers
 */
export enum ItemRarity {
  Common = 'COMMON',
  Uncommon = 'UNCOMMON',
  Rare = 'RARE',
  Epic = 'EPIC',
  Legendary = 'LEGENDARY'
}

/**
 * Inventory item from cave exploration
 * 
 * @property id - Unique item identifier
 * @property type - Item type (digger or tradeable)
 * @property name - Display name of the item
 * @property description - Item description
 * @property rarity - Rarity tier
 * @property bonusPercent - Permanent bonus percentage (0 for tradeable)
 * @property bonusValue - Display value for bonus
 * @property quantity - Stack quantity for tradeable items
 * @property foundAt - Location where item was found
 * @property foundDate - Timestamp when item was discovered
 */
export interface InventoryItem {
  id: string;
  type: ItemType;
  name: string;
  description?: string;
  rarity: ItemRarity;
  bonusPercent: number; // 0 for tradeable items, 0.1-2% for diggers
  bonusValue?: number; // Display value for UI
  quantity?: number; // For stackable tradeable items
  foundAt: Position;
  foundDate: Date;
}

/**
 * Movement direction enum for 9-directional navigation
  lastActive?: Date; // Timestamp for activity tracking (used for active player metrics)
 * 
 * Multiple keyboard control schemes supported:
 * 
 * QWEASDZXC Layout:
 * Q  W  E  =  [NW] [N]  [NE]
 * A  S  D  =  [W]  [âŸ³]  [E]
 * Z  X  C  =  [SW] [S]  [SE]
 * 
 * Numpad Layout:
 * 7  8  9  =  [NW] [N]  [NE]
 * 4  5  6  =  [W]  [âŸ³]  [E]
 * 1  2  3  =  [SW] [S]  [SE]
 * 
 * Arrow Keys (Cardinal directions only):
 * â†‘ = North, â†“ = South, â† = West, â†’ = East
 */
export enum MovementDirection {
  North = 'N',
  Northeast = 'NE',
  East = 'E',
  Southeast = 'SE',
  South = 'S',
  Southwest = 'SW',
  West = 'W',
  Northwest = 'NW',
  Refresh = 'REFRESH'
}

/**
 * Keyboard key to movement direction mapping
 * Supports three control schemes: QWEASDZXC, Numpad 1-9, and Arrow keys
 * 
 * @example
 * // All three map to North:
 * KeyToDirection['w'] === MovementDirection.North
 * KeyToDirection['8'] === MovementDirection.North
 * KeyToDirection['ArrowUp'] === MovementDirection.North
 */
export const KeyToDirection: Record<string, MovementDirection> = {
  // QWEASDZXC Layout (original)
  'q': MovementDirection.Northwest,
  'Q': MovementDirection.Northwest,
  'w': MovementDirection.North,
  'W': MovementDirection.North,
  'e': MovementDirection.Northeast,
  'E': MovementDirection.Northeast,
  'a': MovementDirection.West,
  'A': MovementDirection.West,
  's': MovementDirection.Refresh,
  'S': MovementDirection.Refresh,
  'd': MovementDirection.East,
  'D': MovementDirection.East,
  'z': MovementDirection.Southwest,
  'Z': MovementDirection.Southwest,
  'x': MovementDirection.South,
  'X': MovementDirection.South,
  'c': MovementDirection.Southeast,
  'C': MovementDirection.Southeast,
  
  // Numpad 1-9 Layout (matches physical numpad grid)
  '7': MovementDirection.Northwest,
  '8': MovementDirection.North,
  '9': MovementDirection.Northeast,
  '4': MovementDirection.West,
  '5': MovementDirection.Refresh,
  '6': MovementDirection.East,
  '1': MovementDirection.Southwest,
  '2': MovementDirection.South,
  '3': MovementDirection.Southeast,
  
  // Arrow Keys (cardinal directions only)
  'ArrowUp': MovementDirection.North,
  'ArrowDown': MovementDirection.South,
  'ArrowLeft': MovementDirection.West,
  'ArrowRight': MovementDirection.East
};

/**
 * Movement delta for each direction
 * Maps direction to x,y coordinate changes
 */
export const DirectionDelta: Record<MovementDirection, Position> = {
  [MovementDirection.North]: { x: 0, y: -1 },
  [MovementDirection.Northeast]: { x: 1, y: -1 },
  [MovementDirection.East]: { x: 1, y: 0 },
  [MovementDirection.Southeast]: { x: 1, y: 1 },
  [MovementDirection.South]: { x: 0, y: 1 },
  [MovementDirection.Southwest]: { x: -1, y: 1 },
  [MovementDirection.West]: { x: -1, y: 0 },
  [MovementDirection.Northwest]: { x: -1, y: -1 },
  [MovementDirection.Refresh]: { x: 0, y: 0 }
};

/**
 * Game constants
 */
export const GAME_CONSTANTS = {
  /** Map dimensions */
  MAP_WIDTH: 150,
  MAP_HEIGHT: 150,
  
  /** Total tiles on the map */
  TOTAL_TILES: 22500,
  
  /** Terrain distribution counts */
  TERRAIN_COUNTS: {
    [TerrainType.Metal]: 4500,
    [TerrainType.Energy]: 4500,
    [TerrainType.Cave]: 1800,
    [TerrainType.Forest]: 450,
    [TerrainType.Factory]: 2250,
    [TerrainType.Wasteland]: 9000
  },
  
  /** Starting resources for new players */
  STARTING_RESOURCES: {
    metal: 0,
    energy: 0
  },
  
  /** Harvest system constants */
  HARVEST: {
    /** Base harvest range for metal/energy tiles */
    MIN_AMOUNT: 800,
    MAX_AMOUNT: 1500,
    
    /** Cave item drop rate */
    CAVE_DROP_RATE: 0.30, // 30% chance
    
    /** Cave item distribution */
    TRADEABLE_ITEM_RATE: 0.80, // 80% of drops are tradeable
    DIGGER_ITEM_RATE: 0.20, // 20% of drops are diggers
    
    /** Reset times (server time) */
    RESET_TIMES: {
      TILES_1_75: '00:00', // Midnight
      TILES_76_150: '12:00' // Noon
    },
    
    /** Inventory limits */
    DEFAULT_INVENTORY_CAPACITY: 2000
  },
  
  /** Digger diminishing returns tiers */
  DIGGER_TIERS: [
    { min: 1, max: 10, bonusPercent: 2.0 },    // First 10: +2% each
    { min: 11, max: 30, bonusPercent: 1.0 },   // Next 20: +1% each
    { min: 31, max: 70, bonusPercent: 0.5 },   // Next 40: +0.5% each
    { min: 71, max: 150, bonusPercent: 0.25 }, // Next 80: +0.25% each
    { min: 151, max: Infinity, bonusPercent: 0.1 } // After 150: +0.1% each
  ]
} as const;

/**
 * API response types
 */

/**
 * Standard API success response
 */
export interface ApiResponse<T = unknown> {
  success: true;
  data: T;
}

/**
 * Standard API error response
 */
export interface ApiError {
  success: false;
  error: string;
  details?: string;
}

/**
 * Player registration request
 */
export interface RegisterRequest {
  username: string;
}

/**
 * Player registration response
 */
export interface RegisterResponse {
  player: Player;
  currentTile: Tile;
}

/**
 * Movement request
 */
export interface MoveRequest {
  username: string;
  direction: MovementDirection;
}

/**
 * Movement response
 */
export interface MoveResponse {
  player: Player;
  currentTile: Tile;
}

/**
 * Get tile request query parameters
 */
export interface GetTileRequest {
  x: number;
  y: number;
}

/**
 * Get player request query parameters
 */
export interface GetPlayerRequest {
  username: string;
}

/**
 * Harvest result data for comprehensive harvest operations
 * Supports both resource gathering (Metal/Energy) and exploration (Cave/Forest)
 * 
 * @property success - Whether harvest was successful
 * @property message - Result message to display
 * @property metalGained - Amount of metal harvested (0 if none)
 * @property energyGained - Amount of energy harvested (0 if none)
 * @property item - Cave/Forest item discovered (null if none)
 * @property bonusApplied - Bonus percentage that was applied (from shrine boosts)
 * @property xpAwarded - XP gained from harvest (optional, for API responses)
 * @property levelUp - Whether player leveled up (optional, for API responses)
 * @property newLevel - New level if levelUp is true (optional, for API responses)
 * @property player - Updated player object (optional, for full API responses)
 * @property tile - Tile that was harvested (optional, for full API responses)
 * @property harvestStatus - Cooldown status (optional, for full API responses)
 */
export interface HarvestResult {
  success: boolean;
  message: string;
  metalGained?: number;
  energyGained?: number;
  item?: InventoryItem | null;
  bonusApplied?: number;
  xpAwarded?: number;
  levelUp?: boolean;
  newLevel?: number;
  player?: Player;
  tile?: Tile;
  harvestStatus?: {
    canHarvest: boolean;
    timeUntilReset: number;
    resetPeriod: string;
  };
}

/**
 * Factory entity with ownership and production data
 * 
 * @property x - Horizontal coordinate
 * @property y - Vertical coordinate
 * @property owner - Username of controlling player (null if unclaimed)
 * @property defense - Defense power for attack calculations
 * @property level - Factory upgrade level (1-10, affects slots and regen rate)
 * @property slots - Current available slots (regenerates based on level)
 * @property usedSlots - Number of slots currently occupied by units
 * @property productionRate - Units produced per hour (display only)
 * @property lastSlotRegen - Timestamp of last slot regeneration check
 * @property lastAttackedBy - Last player to attack (for cooldown)
 * @property lastAttackTime - Timestamp of last attack
 */
export interface Factory {
  x: number;
  y: number;
  owner: string | null;
  defense: number;
  level: number; // Factory upgrade level (1-10, default 1)
  slots: number; // Current available slots (regenerates based on level)
  usedSlots: number; // Slots consumed by built units
  productionRate: number; // Units per hour (display only)
  lastSlotRegen: Date; // Last time slots were regenerated
  lastAttackedBy?: string | null;
  lastAttackTime?: Date | null;
}

/**
 * Unit tier system for progressive unlocks
 */
export enum UnitTier {
  Tier1 = 1,
  Tier2 = 2,
  Tier3 = 3,
  Tier4 = 4,
  Tier5 = 5
}

/**
 * Unit types available for building (40 total: 5 tiers Ã— 8 units per tier)
 * Naming convention: Tier + Role + Variant
 * Each tier has 4 STR units and 4 DEF units
 */
export enum UnitType {
  // ===== TIER 1 (Level 1+, 0 RP) =====
  // STR Units
  T1_Rifleman = 'T1_RIFLEMAN',           // STR: 5
  T1_Scout = 'T1_SCOUT',                 // STR: 8
  T1_Grenadier = 'T1_GRENADIER',         // STR: 12
  T1_Sniper = 'T1_SNIPER',               // STR: 15
  // DEF Units
  T1_Bunker = 'T1_BUNKER',               // DEF: 5
  T1_Barrier = 'T1_BARRIER',             // DEF: 8
  T1_Turret = 'T1_TURRET',               // DEF: 12
  T1_Shield = 'T1_SHIELD',               // DEF: 15

  // ===== TIER 2 (Level 5+, 5 RP) =====
  // STR Units
  T2_Commando = 'T2_COMMANDO',           // STR: 30
  T2_Ranger = 'T2_RANGER',               // STR: 40
  T2_Assassin = 'T2_ASSASSIN',           // STR: 50
  T2_Demolisher = 'T2_DEMOLISHER',       // STR: 60
  // DEF Units
  T2_Fortress = 'T2_FORTRESS',           // DEF: 30
  T2_Barricade = 'T2_BARRICADE',         // DEF: 40
  T2_Cannon = 'T2_CANNON',               // DEF: 50
  T2_Sentinel = 'T2_SENTINEL',           // DEF: 60

  // ===== TIER 3 (Level 10+, 15 RP) =====
  // STR Units
  T3_Striker = 'T3_STRIKER',             // STR: 90
  T3_Raider = 'T3_RAIDER',               // STR: 105
  T3_Enforcer = 'T3_ENFORCER',           // STR: 120
  T3_Warlord = 'T3_WARLORD',             // STR: 135
  // DEF Units
  T3_Citadel = 'T3_CITADEL',             // DEF: 90
  T3_Bulwark = 'T3_BULWARK',             // DEF: 105
  T3_Artillery = 'T3_ARTILLERY',         // DEF: 120
  T3_Guardian = 'T3_GUARDIAN',           // DEF: 135

  // ===== TIER 4 (Level 20+, 30 RP) =====
  // STR Units
  T4_Titan = 'T4_TITAN',                 // STR: 180
  T4_Juggernaut = 'T4_JUGGERNAUT',       // STR: 210
  T4_Destroyer = 'T4_DESTROYER',         // STR: 240
  T4_Annihilator = 'T4_ANNIHILATOR',     // STR: 270
  // DEF Units
  T4_Stronghold = 'T4_STRONGHOLD',       // DEF: 180
  T4_Rampart = 'T4_RAMPART',             // DEF: 210
  T4_Dreadnought = 'T4_DREADNOUGHT',     // DEF: 240
  T4_Colossus = 'T4_COLOSSUS',           // DEF: 270

  // ===== TIER 5 (Level 30+, 50 RP) =====
  // STR Units
  T5_Overlord = 'T5_OVERLORD',           // STR: 360
  T5_Conqueror = 'T5_CONQUEROR',         // STR: 420
  T5_Devastator = 'T5_DEVASTATOR',       // STR: 480
  T5_Apocalypse = 'T5_APOCALYPSE',       // STR: 540
  // DEF Units
  T5_Bastion = 'T5_BASTION',             // DEF: 360
  T5_Monolith = 'T5_MONOLITH',           // DEF: 420
  T5_Leviathan = 'T5_LEVIATHAN',         // DEF: 480
  T5_Immortal = 'T5_IMMORTAL',           // DEF: 540

  // ===== SPECIALIZED UNITS (Offensive Doctrine, Level 15+, 25 RP) =====
  SPEC_OFF_Vanguard = 'SPEC_OFF_VANGUARD',               // STR: 200, Mastery 0%+
  SPEC_OFF_Berserker = 'SPEC_OFF_BERSERKER',             // STR: 280, Mastery 0%+
  SPEC_OFF_Executioner = 'SPEC_OFF_EXECUTIONER',         // STR: 360, Mastery 25%+
  SPEC_OFF_Annihilator = 'SPEC_OFF_ANNIHILATOR',         // STR: 480, Mastery 75%+
  SPEC_OFF_Warmonger = 'SPEC_OFF_WARMONGER',             // STR: 620, Mastery 100%

  // ===== SPECIALIZED UNITS (Defensive Doctrine, Level 15+, 25 RP) =====
  SPEC_DEF_Guardian = 'SPEC_DEF_GUARDIAN',               // DEF: 200, Mastery 0%+
  SPEC_DEF_Fortress = 'SPEC_DEF_FORTRESS',               // DEF: 280, Mastery 0%+
  SPEC_DEF_Citadel = 'SPEC_DEF_CITADEL',                 // DEF: 360, Mastery 25%+
  SPEC_DEF_Bulwark = 'SPEC_DEF_BULWARK',                 // DEF: 480, Mastery 75%+
  SPEC_DEF_Invincible = 'SPEC_DEF_INVINCIBLE',           // DEF: 620, Mastery 100%

  // ===== SPECIALIZED UNITS (Tactical Doctrine, Level 15+, 25 RP) =====
  SPEC_TAC_Striker = 'SPEC_TAC_STRIKER',                 // Balanced: 120/120, Mastery 0%+
  SPEC_TAC_Vanguard = 'SPEC_TAC_VANGUARD',               // Balanced: 160/160, Mastery 0%+
  SPEC_TAC_Elite = 'SPEC_TAC_ELITE',                     // Balanced: 210/210, Mastery 25%+
  SPEC_TAC_Commander = 'SPEC_TAC_COMMANDER',             // Balanced: 280/280, Mastery 75%+
  SPEC_TAC_Supreme = 'SPEC_TAC_SUPREME',                 // Balanced: 360/360, Mastery 100%

  // ===== PRESTIGE UNITS (Achievement Unlocks) =====
  PRESTIGE_TITAN = 'PRESTIGE_TITAN',                     // STR: 700, Achievement: Warlord
  PRESTIGE_FABRICATOR = 'PRESTIGE_FABRICATOR',           // Balanced: 400/400, Achievement: Master Builder
  PRESTIGE_OVERLORD = 'PRESTIGE_OVERLORD',               // STR: 1000, Achievement: Army Supreme
  PRESTIGE_HARVESTER = 'PRESTIGE_HARVESTER',             // Balanced: 450/450, Achievement: Resource Magnate
  PRESTIGE_VAULT_KEEPER = 'PRESTIGE_VAULT_KEEPER',       // DEF: 800, Achievement: The Banker
  PRESTIGE_MYSTIC = 'PRESTIGE_MYSTIC',                   // Balanced: 500/500, Achievement: Shrine Devotee
  PRESTIGE_ANCIENT_SENTINEL = 'PRESTIGE_ANCIENT_SENTINEL', // Balanced: 550/550, Achievement: Archaeologist
  PRESTIGE_SPELUNKER = 'PRESTIGE_SPELUNKER',             // Balanced: 400/400, Achievement: Cave Explorer
  PRESTIGE_CHAMPION = 'PRESTIGE_CHAMPION',               // Balanced: 600/600, Achievement: Legend
  PRESTIGE_APEX_PREDATOR = 'PRESTIGE_APEX_PREDATOR',     // STR: 900, Achievement: Master Specialist
}

/**
 * Unit configuration for building
 * 
 * @property type - Unit type identifier
 * @property name - Display name
 * @property tier - Unit tier (1-5)
 * @property metalCost - Metal resource cost
 * @property energyCost - Energy resource cost
 * @property slotCost - Factory slots consumed
 * @property strength - Offensive power (STR)
 * @property defense - Defensive power (DEF)
 * @property levelRequired - Minimum player level to unlock
 * @property rpRequired - Research Points needed to unlock tier (one-time cost)
 */
export interface UnitConfig {
  type: UnitType;
  name: string;
  tier: UnitTier;
  metalCost: number;
  energyCost: number;
  slotCost: number;
  strength: number; // STR contribution
  defense: number;  // DEF contribution
  levelRequired: number;
  rpRequired: number; // One-time RP cost to unlock entire tier
}

/**
 * Available unit configurations
 */
/**
 * Complete unit configurations for all 40 units (5 tiers Ã— 8 units)
 * 
 * BALANCING PHILOSOPHY:
 * - Tier 1: Entry-level units (Level 1+, 0 RP)
 * - Tier 2: Mid-game units (Level 5+, 5 RP to unlock tier)
 * - Tier 3: Advanced units (Level 10+, 15 RP to unlock tier)
 * - Tier 4: Elite units (Level 20+, 30 RP to unlock tier)
 * - Tier 5: Legendary units (Level 30+, 50 RP to unlock tier)
 * 
 * COST SCALING:
 * - Metal/Energy costs scale exponentially per tier
 * - Higher tiers require more factory slots
 * - STR/DEF values scale progressively within each tier
 */
export const UNIT_CONFIGS: Record<UnitType, UnitConfig> = {
  // ==================== TIER 1: Basic Units ====================
  // STR Units
  [UnitType.T1_Rifleman]: {
    type: UnitType.T1_Rifleman,
    name: 'Rifleman',
    tier: UnitTier.Tier1,
    metalCost: 200,
    energyCost: 100,
    slotCost: 1,
    strength: 5,
    defense: 0,
    levelRequired: 1,
    rpRequired: 0
  },
  [UnitType.T1_Scout]: {
    type: UnitType.T1_Scout,
    name: 'Scout',
    tier: UnitTier.Tier1,
    metalCost: 300,
    energyCost: 150,
    slotCost: 1,
    strength: 8,
    defense: 0,
    levelRequired: 1,
    rpRequired: 0
  },
  [UnitType.T1_Grenadier]: {
    type: UnitType.T1_Grenadier,
    name: 'Grenadier',
    tier: UnitTier.Tier1,
    metalCost: 400,
    energyCost: 200,
    slotCost: 1,
    strength: 12,
    defense: 0,
    levelRequired: 1,
    rpRequired: 0
  },
  [UnitType.T1_Sniper]: {
    type: UnitType.T1_Sniper,
    name: 'Sniper',
    tier: UnitTier.Tier1,
    metalCost: 500,
    energyCost: 250,
    slotCost: 1,
    strength: 15,
    defense: 0,
    levelRequired: 1,
    rpRequired: 0
  },
  
  // DEF Units
  [UnitType.T1_Bunker]: {
    type: UnitType.T1_Bunker,
    name: 'Bunker',
    tier: UnitTier.Tier1,
    metalCost: 200,
    energyCost: 100,
    slotCost: 1,
    strength: 0,
    defense: 5,
    levelRequired: 1,
    rpRequired: 0
  },
  [UnitType.T1_Barrier]: {
    type: UnitType.T1_Barrier,
    name: 'Barrier',
    tier: UnitTier.Tier1,
    metalCost: 300,
    energyCost: 150,
    slotCost: 1,
    strength: 0,
    defense: 8,
    levelRequired: 1,
    rpRequired: 0
  },
  [UnitType.T1_Turret]: {
    type: UnitType.T1_Turret,
    name: 'Turret',
    tier: UnitTier.Tier1,
    metalCost: 400,
    energyCost: 200,
    slotCost: 1,
    strength: 0,
    defense: 12,
    levelRequired: 1,
    rpRequired: 0
  },
  [UnitType.T1_Shield]: {
    type: UnitType.T1_Shield,
    name: 'Shield Generator',
    tier: UnitTier.Tier1,
    metalCost: 500,
    energyCost: 250,
    slotCost: 1,
    strength: 0,
    defense: 15,
    levelRequired: 1,
    rpRequired: 0
  },

  // ==================== TIER 2: Improved Units ====================
  // STR Units
  [UnitType.T2_Commando]: {
    type: UnitType.T2_Commando,
    name: 'Commando',
    tier: UnitTier.Tier2,
    metalCost: 1200,
    energyCost: 600,
    slotCost: 2,
    strength: 30,
    defense: 0,
    levelRequired: 5,
    rpRequired: 5
  },
  [UnitType.T2_Ranger]: {
    type: UnitType.T2_Ranger,
    name: 'Ranger',
    tier: UnitTier.Tier2,
    metalCost: 1600,
    energyCost: 800,
    slotCost: 2,
    strength: 40,
    defense: 0,
    levelRequired: 5,
    rpRequired: 5
  },
  [UnitType.T2_Assassin]: {
    type: UnitType.T2_Assassin,
    name: 'Assassin',
    tier: UnitTier.Tier2,
    metalCost: 2000,
    energyCost: 1000,
    slotCost: 2,
    strength: 50,
    defense: 0,
    levelRequired: 5,
    rpRequired: 5
  },
  [UnitType.T2_Demolisher]: {
    type: UnitType.T2_Demolisher,
    name: 'Demolisher',
    tier: UnitTier.Tier2,
    metalCost: 2400,
    energyCost: 1200,
    slotCost: 2,
    strength: 60,
    defense: 0,
    levelRequired: 5,
    rpRequired: 5
  },
  
  // DEF Units
  [UnitType.T2_Fortress]: {
    type: UnitType.T2_Fortress,
    name: 'Fortress',
    tier: UnitTier.Tier2,
    metalCost: 1200,
    energyCost: 600,
    slotCost: 2,
    strength: 0,
    defense: 30,
    levelRequired: 5,
    rpRequired: 5
  },
  [UnitType.T2_Barricade]: {
    type: UnitType.T2_Barricade,
    name: 'Barricade',
    tier: UnitTier.Tier2,
    metalCost: 1600,
    energyCost: 800,
    slotCost: 2,
    strength: 0,
    defense: 40,
    levelRequired: 5,
    rpRequired: 5
  },
  [UnitType.T2_Cannon]: {
    type: UnitType.T2_Cannon,
    name: 'Cannon',
    tier: UnitTier.Tier2,
    metalCost: 2000,
    energyCost: 1000,
    slotCost: 2,
    strength: 0,
    defense: 50,
    levelRequired: 5,
    rpRequired: 5
  },
  [UnitType.T2_Sentinel]: {
    type: UnitType.T2_Sentinel,
    name: 'Sentinel',
    tier: UnitTier.Tier2,
    metalCost: 2400,
    energyCost: 1200,
    slotCost: 2,
    strength: 0,
    defense: 60,
    levelRequired: 5,
    rpRequired: 5
  },

  // ==================== TIER 3: Advanced Units ====================
  // STR Units
  [UnitType.T3_Striker]: {
    type: UnitType.T3_Striker,
    name: 'Striker',
    tier: UnitTier.Tier3,
    metalCost: 3600,
    energyCost: 1800,
    slotCost: 3,
    strength: 90,
    defense: 0,
    levelRequired: 10,
    rpRequired: 15
  },
  [UnitType.T3_Raider]: {
    type: UnitType.T3_Raider,
    name: 'Raider',
    tier: UnitTier.Tier3,
    metalCost: 4200,
    energyCost: 2100,
    slotCost: 3,
    strength: 105,
    defense: 0,
    levelRequired: 10,
    rpRequired: 15
  },
  [UnitType.T3_Enforcer]: {
    type: UnitType.T3_Enforcer,
    name: 'Enforcer',
    tier: UnitTier.Tier3,
    metalCost: 4800,
    energyCost: 2400,
    slotCost: 3,
    strength: 120,
    defense: 0,
    levelRequired: 10,
    rpRequired: 15
  },
  [UnitType.T3_Warlord]: {
    type: UnitType.T3_Warlord,
    name: 'Warlord',
    tier: UnitTier.Tier3,
    metalCost: 5400,
    energyCost: 2700,
    slotCost: 3,
    strength: 135,
    defense: 0,
    levelRequired: 10,
    rpRequired: 15
  },
  
  // DEF Units
  [UnitType.T3_Citadel]: {
    type: UnitType.T3_Citadel,
    name: 'Citadel',
    tier: UnitTier.Tier3,
    metalCost: 3600,
    energyCost: 1800,
    slotCost: 3,
    strength: 0,
    defense: 90,
    levelRequired: 10,
    rpRequired: 15
  },
  [UnitType.T3_Bulwark]: {
    type: UnitType.T3_Bulwark,
    name: 'Bulwark',
    tier: UnitTier.Tier3,
    metalCost: 4200,
    energyCost: 2100,
    slotCost: 3,
    strength: 0,
    defense: 105,
    levelRequired: 10,
    rpRequired: 15
  },
  [UnitType.T3_Artillery]: {
    type: UnitType.T3_Artillery,
    name: 'Artillery',
    tier: UnitTier.Tier3,
    metalCost: 4800,
    energyCost: 2400,
    slotCost: 3,
    strength: 0,
    defense: 120,
    levelRequired: 10,
    rpRequired: 15
  },
  [UnitType.T3_Guardian]: {
    type: UnitType.T3_Guardian,
    name: 'Guardian',
    tier: UnitTier.Tier3,
    metalCost: 5400,
    energyCost: 2700,
    slotCost: 3,
    strength: 0,
    defense: 135,
    levelRequired: 10,
    rpRequired: 15
  },

  // ==================== TIER 4: Elite Units ====================
  // STR Units
  [UnitType.T4_Titan]: {
    type: UnitType.T4_Titan,
    name: 'Titan',
    tier: UnitTier.Tier4,
    metalCost: 7200,
    energyCost: 3600,
    slotCost: 4,
    strength: 180,
    defense: 0,
    levelRequired: 20,
    rpRequired: 30
  },
  [UnitType.T4_Juggernaut]: {
    type: UnitType.T4_Juggernaut,
    name: 'Juggernaut',
    tier: UnitTier.Tier4,
    metalCost: 8400,
    energyCost: 4200,
    slotCost: 4,
    strength: 210,
    defense: 0,
    levelRequired: 20,
    rpRequired: 30
  },
  [UnitType.T4_Destroyer]: {
    type: UnitType.T4_Destroyer,
    name: 'Destroyer',
    tier: UnitTier.Tier4,
    metalCost: 9600,
    energyCost: 4800,
    slotCost: 4,
    strength: 240,
    defense: 0,
    levelRequired: 20,
    rpRequired: 30
  },
  [UnitType.T4_Annihilator]: {
    type: UnitType.T4_Annihilator,
    name: 'Annihilator',
    tier: UnitTier.Tier4,
    metalCost: 10800,
    energyCost: 5400,
    slotCost: 4,
    strength: 270,
    defense: 0,
    levelRequired: 20,
    rpRequired: 30
  },
  
  // DEF Units
  [UnitType.T4_Stronghold]: {
    type: UnitType.T4_Stronghold,
    name: 'Stronghold',
    tier: UnitTier.Tier4,
    metalCost: 7200,
    energyCost: 3600,
    slotCost: 4,
    strength: 0,
    defense: 180,
    levelRequired: 20,
    rpRequired: 30
  },
  [UnitType.T4_Rampart]: {
    type: UnitType.T4_Rampart,
    name: 'Rampart',
    tier: UnitTier.Tier4,
    metalCost: 8400,
    energyCost: 4200,
    slotCost: 4,
    strength: 0,
    defense: 210,
    levelRequired: 20,
    rpRequired: 30
  },
  [UnitType.T4_Dreadnought]: {
    type: UnitType.T4_Dreadnought,
    name: 'Dreadnought',
    tier: UnitTier.Tier4,
    metalCost: 9600,
    energyCost: 4800,
    slotCost: 4,
    strength: 0,
    defense: 240,
    levelRequired: 20,
    rpRequired: 30
  },
  [UnitType.T4_Colossus]: {
    type: UnitType.T4_Colossus,
    name: 'Colossus',
    tier: UnitTier.Tier4,
    metalCost: 10800,
    energyCost: 5400,
    slotCost: 4,
    strength: 0,
    defense: 270,
    levelRequired: 20,
    rpRequired: 30
  },

  // ==================== TIER 5: Legendary Units ====================
  // STR Units
  [UnitType.T5_Overlord]: {
    type: UnitType.T5_Overlord,
    name: 'Overlord',
    tier: UnitTier.Tier5,
    metalCost: 14400,
    energyCost: 7200,
    slotCost: 5,
    strength: 360,
    defense: 0,
    levelRequired: 30,
    rpRequired: 50
  },
  [UnitType.T5_Conqueror]: {
    type: UnitType.T5_Conqueror,
    name: 'Conqueror',
    tier: UnitTier.Tier5,
    metalCost: 16800,
    energyCost: 8400,
    slotCost: 5,
    strength: 420,
    defense: 0,
    levelRequired: 30,
    rpRequired: 50
  },
  [UnitType.T5_Devastator]: {
    type: UnitType.T5_Devastator,
    name: 'Devastator',
    tier: UnitTier.Tier5,
    metalCost: 19200,
    energyCost: 9600,
    slotCost: 5,
    strength: 480,
    defense: 0,
    levelRequired: 30,
    rpRequired: 50
  },
  [UnitType.T5_Apocalypse]: {
    type: UnitType.T5_Apocalypse,
    name: 'Apocalypse',
    tier: UnitTier.Tier5,
    metalCost: 21600,
    energyCost: 10800,
    slotCost: 5,
    strength: 540,
    defense: 0,
    levelRequired: 30,
    rpRequired: 50
  },
  
  // DEF Units
  [UnitType.T5_Bastion]: {
    type: UnitType.T5_Bastion,
    name: 'Bastion',
    tier: UnitTier.Tier5,
    metalCost: 14400,
    energyCost: 7200,
    slotCost: 5,
    strength: 0,
    defense: 360,
    levelRequired: 30,
    rpRequired: 50
  },
  [UnitType.T5_Monolith]: {
    type: UnitType.T5_Monolith,
    name: 'Monolith',
    tier: UnitTier.Tier5,
    metalCost: 16800,
    energyCost: 8400,
    slotCost: 5,
    strength: 0,
    defense: 420,
    levelRequired: 30,
    rpRequired: 50
  },
  [UnitType.T5_Leviathan]: {
    type: UnitType.T5_Leviathan,
    name: 'Leviathan',
    tier: UnitTier.Tier5,
    metalCost: 19200,
    energyCost: 9600,
    slotCost: 5,
    strength: 0,
    defense: 480,
    levelRequired: 30,
    rpRequired: 50
  },
  [UnitType.T5_Immortal]: {
    type: UnitType.T5_Immortal,
    name: 'Immortal',
    tier: UnitTier.Tier5,
    metalCost: 21600,
    energyCost: 10800,
    slotCost: 5,
    strength: 0,
    defense: 540,
    levelRequired: 30,
    rpRequired: 50
  },

  // ==================== SPECIALIZED UNITS: Offensive Doctrine ====================
  [UnitType.SPEC_OFF_Vanguard]: {
    type: UnitType.SPEC_OFF_Vanguard,
    name: 'Vanguard',
    tier: UnitTier.Tier2, // Classified as Tier2 for balance purposes
    metalCost: 4000,
    energyCost: 2000,
    slotCost: 2,
    strength: 200,
    defense: 0,
    levelRequired: 15,
    rpRequired: 25 // Must choose Offensive specialization
  },
  [UnitType.SPEC_OFF_Berserker]: {
    type: UnitType.SPEC_OFF_Berserker,
    name: 'Berserker',
    tier: UnitTier.Tier3,
    metalCost: 6500,
    energyCost: 3250,
    slotCost: 3,
    strength: 280,
    defense: 0,
    levelRequired: 15,
    rpRequired: 25
  },
  [UnitType.SPEC_OFF_Executioner]: {
    type: UnitType.SPEC_OFF_Executioner,
    name: 'Executioner',
    tier: UnitTier.Tier3,
    metalCost: 9000,
    energyCost: 4500,
    slotCost: 3,
    strength: 360,
    defense: 0,
    levelRequired: 15,
    rpRequired: 25 // Requires 25%+ mastery
  },
  [UnitType.SPEC_OFF_Annihilator]: {
    type: UnitType.SPEC_OFF_Annihilator,
    name: 'Annihilator',
    tier: UnitTier.Tier4,
    metalCost: 12000,
    energyCost: 6000,
    slotCost: 4,
    strength: 480,
    defense: 0,
    levelRequired: 15,
    rpRequired: 25 // Requires 75%+ mastery
  },
  [UnitType.SPEC_OFF_Warmonger]: {
    type: UnitType.SPEC_OFF_Warmonger,
    name: 'Warmonger',
    tier: UnitTier.Tier5,
    metalCost: 16000,
    energyCost: 8000,
    slotCost: 5,
    strength: 620,
    defense: 0,
    levelRequired: 15,
    rpRequired: 25 // Requires 100% mastery
  },

  // ==================== SPECIALIZED UNITS: Defensive Doctrine ====================
  [UnitType.SPEC_DEF_Guardian]: {
    type: UnitType.SPEC_DEF_Guardian,
    name: 'Guardian',
    tier: UnitTier.Tier2,
    metalCost: 4000,
    energyCost: 2000,
    slotCost: 2,
    strength: 0,
    defense: 200,
    levelRequired: 15,
    rpRequired: 25 // Must choose Defensive specialization
  },
  [UnitType.SPEC_DEF_Fortress]: {
    type: UnitType.SPEC_DEF_Fortress,
    name: 'Fortress',
    tier: UnitTier.Tier3,
    metalCost: 6500,
    energyCost: 3250,
    slotCost: 3,
    strength: 0,
    defense: 280,
    levelRequired: 15,
    rpRequired: 25
  },
  [UnitType.SPEC_DEF_Citadel]: {
    type: UnitType.SPEC_DEF_Citadel,
    name: 'Citadel',
    tier: UnitTier.Tier3,
    metalCost: 9000,
    energyCost: 4500,
    slotCost: 3,
    strength: 0,
    defense: 360,
    levelRequired: 15,
    rpRequired: 25 // Requires 25%+ mastery
  },
  [UnitType.SPEC_DEF_Bulwark]: {
    type: UnitType.SPEC_DEF_Bulwark,
    name: 'Bulwark',
    tier: UnitTier.Tier4,
    metalCost: 12000,
    energyCost: 6000,
    slotCost: 4,
    strength: 0,
    defense: 480,
    levelRequired: 15,
    rpRequired: 25 // Requires 75%+ mastery
  },
  [UnitType.SPEC_DEF_Invincible]: {
    type: UnitType.SPEC_DEF_Invincible,
    name: 'Invincible',
    tier: UnitTier.Tier5,
    metalCost: 16000,
    energyCost: 8000,
    slotCost: 5,
    strength: 0,
    defense: 620,
    levelRequired: 15,
    rpRequired: 25 // Requires 100% mastery
  },

  // ==================== SPECIALIZED UNITS: Tactical Doctrine ====================
  [UnitType.SPEC_TAC_Striker]: {
    type: UnitType.SPEC_TAC_Striker,
    name: 'Striker',
    tier: UnitTier.Tier2,
    metalCost: 4500,
    energyCost: 2250,
    slotCost: 2,
    strength: 120,
    defense: 120,
    levelRequired: 15,
    rpRequired: 25 // Must choose Tactical specialization
  },
  [UnitType.SPEC_TAC_Vanguard]: {
    type: UnitType.SPEC_TAC_Vanguard,
    name: 'Tactical Vanguard',
    tier: UnitTier.Tier3,
    metalCost: 7000,
    energyCost: 3500,
    slotCost: 3,
    strength: 160,
    defense: 160,
    levelRequired: 15,
    rpRequired: 25
  },
  [UnitType.SPEC_TAC_Elite]: {
    type: UnitType.SPEC_TAC_Elite,
    name: 'Elite Operative',
    tier: UnitTier.Tier3,
    metalCost: 10000,
    energyCost: 5000,
    slotCost: 3,
    strength: 210,
    defense: 210,
    levelRequired: 15,
    rpRequired: 25 // Requires 25%+ mastery
  },
  [UnitType.SPEC_TAC_Commander]: {
    type: UnitType.SPEC_TAC_Commander,
    name: 'Commander',
    tier: UnitTier.Tier4,
    metalCost: 13000,
    energyCost: 6500,
    slotCost: 4,
    strength: 280,
    defense: 280,
    levelRequired: 15,
    rpRequired: 25 // Requires 75%+ mastery
  },
  [UnitType.SPEC_TAC_Supreme]: {
    type: UnitType.SPEC_TAC_Supreme,
    name: 'Supreme Commander',
    tier: UnitTier.Tier5,
    metalCost: 17000,
    energyCost: 8500,
    slotCost: 5,
    strength: 360,
    defense: 360,
    levelRequired: 15,
    rpRequired: 25 // Requires 100% mastery
  },

  // ==================== PRESTIGE UNITS (Achievement Unlocks) ====================
  [UnitType.PRESTIGE_TITAN]: {
    type: UnitType.PRESTIGE_TITAN,
    name: 'Prestige Titan',
    tier: UnitTier.Tier5,
    metalCost: 25000,
    energyCost: 15000,
    slotCost: 6,
    strength: 700,
    defense: 0,
    levelRequired: 1,
    rpRequired: 0 // Requires Warlord achievement
  },
  [UnitType.PRESTIGE_FABRICATOR]: {
    type: UnitType.PRESTIGE_FABRICATOR,
    name: 'Master Fabricator',
    tier: UnitTier.Tier5,
    metalCost: 20000,
    energyCost: 20000,
    slotCost: 5,
    strength: 400,
    defense: 400,
    levelRequired: 1,
    rpRequired: 0 // Requires Master Builder achievement
  },
  [UnitType.PRESTIGE_OVERLORD]: {
    type: UnitType.PRESTIGE_OVERLORD,
    name: 'Supreme Overlord',
    tier: UnitTier.Tier5,
    metalCost: 35000,
    energyCost: 25000,
    slotCost: 7,
    strength: 1000,
    defense: 0,
    levelRequired: 1,
    rpRequired: 0 // Requires Army Supreme achievement
  },
  [UnitType.PRESTIGE_HARVESTER]: {
    type: UnitType.PRESTIGE_HARVESTER,
    name: 'Mega Harvester',
    tier: UnitTier.Tier5,
    metalCost: 22000,
    energyCost: 22000,
    slotCost: 5,
    strength: 450,
    defense: 450,
    levelRequired: 1,
    rpRequired: 0 // Requires Resource Magnate achievement
  },
  [UnitType.PRESTIGE_VAULT_KEEPER]: {
    type: UnitType.PRESTIGE_VAULT_KEEPER,
    name: 'Vault Keeper',
    tier: UnitTier.Tier5,
    metalCost: 30000,
    energyCost: 18000,
    slotCost: 6,
    strength: 0,
    defense: 800,
    levelRequired: 1,
    rpRequired: 0 // Requires The Banker achievement
  },
  [UnitType.PRESTIGE_MYSTIC]: {
    type: UnitType.PRESTIGE_MYSTIC,
    name: 'Shrine Mystic',
    tier: UnitTier.Tier5,
    metalCost: 24000,
    energyCost: 24000,
    slotCost: 6,
    strength: 500,
    defense: 500,
    levelRequired: 1,
    rpRequired: 0 // Requires Shrine Devotee achievement
  },
  [UnitType.PRESTIGE_ANCIENT_SENTINEL]: {
    type: UnitType.PRESTIGE_ANCIENT_SENTINEL,
    name: 'Ancient Sentinel',
    tier: UnitTier.Tier5,
    metalCost: 26000,
    energyCost: 26000,
    slotCost: 6,
    strength: 550,
    defense: 550,
    levelRequired: 1,
    rpRequired: 0 // Requires Archaeologist achievement
  },
  [UnitType.PRESTIGE_SPELUNKER]: {
    type: UnitType.PRESTIGE_SPELUNKER,
    name: 'Master Spelunker',
    tier: UnitTier.Tier5,
    metalCost: 20000,
    energyCost: 20000,
    slotCost: 5,
    strength: 400,
    defense: 400,
    levelRequired: 1,
    rpRequired: 0 // Requires Cave Explorer achievement
  },
  [UnitType.PRESTIGE_CHAMPION]: {
    type: UnitType.PRESTIGE_CHAMPION,
    name: 'Legendary Champion',
    tier: UnitTier.Tier5,
    metalCost: 28000,
    energyCost: 28000,
    slotCost: 7,
    strength: 600,
    defense: 600,
    levelRequired: 1,
    rpRequired: 0 // Requires Legend achievement
  },
  [UnitType.PRESTIGE_APEX_PREDATOR]: {
    type: UnitType.PRESTIGE_APEX_PREDATOR,
    name: 'Apex Predator',
    tier: UnitTier.Tier5,
    metalCost: 32000,
    energyCost: 20000,
    slotCost: 7,
    strength: 900,
    defense: 0,
    levelRequired: 1,
    rpRequired: 0 // Requires Master Specialist achievement
  }
};

/**
 * Tier unlock requirements
 * Maps tier number to level and RP requirements
 */
export const TIER_UNLOCK_REQUIREMENTS = {
  [UnitTier.Tier1]: { level: 1, rp: 0 },
  [UnitTier.Tier2]: { level: 5, rp: 5 },
  [UnitTier.Tier3]: { level: 10, rp: 15 },
  [UnitTier.Tier4]: { level: 20, rp: 30 },
  [UnitTier.Tier5]: { level: 30, rp: 50 }
};

/**
 * Helper function: Check if player has unlocked a specific tier
 */
export function isTierUnlocked(tier: UnitTier, playerLevel: number, unlockedTiers: UnitTier[]): boolean {
  const requirements = TIER_UNLOCK_REQUIREMENTS[tier];
  return playerLevel >= requirements.level && unlockedTiers.includes(tier);
}

/**
 * Helper function: Get units available for a specific tier
 */
export function getUnitsForTier(tier: UnitTier): UnitConfig[] {
  return Object.values(UNIT_CONFIGS).filter(config => config.tier === tier);
}

/**
 * Helper function: Get all unlocked units for player
 */
export function getAvailableUnits(playerLevel: number, unlockedTiers: UnitTier[]): UnitConfig[] {
  return Object.values(UNIT_CONFIGS).filter(config => 
    isTierUnlocked(config.tier, playerLevel, unlockedTiers)
  );
}

/**
 * Unit instance in player's army (simplified)
 * Used for player inventory and army management
 * 
 * @property id - Unique identifier (alias for unitId for battle system compatibility)
 * @property unitId - Unit blueprint ID from UNIT_BLUEPRINTS
 * @property unitType - Unit type for combat and display
 * @property name - Unit name
 * @property category - STR or DEF category
 * @property rarity - Rarity tier
 * @property strength - STR contribution
 * @property defense - DEF contribution
 * @property quantity - Number of units of this type owned
 * @property createdAt - When unit was built
 */
export interface PlayerUnit {
  id: string; // Alias for unitId - battle system compatibility
  unitId: string;
  unitType: UnitType; // Added for combat modal and army management compatibility
  name: string;
  category: 'STR' | 'DEF';
  rarity: 'common' | 'uncommon' | 'rare' | 'epic' | 'legendary';
  strength: number;
  defense: number;
  quantity: number; // Added for tracking owned units of each type
  createdAt: Date;
}

/**
 * Unit produced by factories (full combat data)
 * Used in combat scenarios and factory production
 * 
 * @property id - Unique unit identifier
 * @property type - Unit type (40 types across 5 tiers)
 * @property strength - Offensive power (STR)
 * @property defense - Defensive power (DEF)
 * @property producedAt - Factory location where unit was produced
 * @property producedDate - When unit finished production
 * @property owner - Player who owns this unit
 */
export interface Unit {
  id: string;
  type: UnitType;
  strength: number; // STR contribution
  defense: number;  // DEF contribution
  producedAt: Position;
  producedDate: Date;
  owner: string; // Player username
}

/**
 * Attack result data
 * 
 * @property success - Whether attack succeeded
 * @property message - Result message
 * @property playerPower - Player's calculated power
 * @property factoryDefense - Factory's defense value
 * @property captured - Whether factory was captured
 * @property damageDealt - Damage dealt to factory (future PvP)
 * @property xpAwarded - XP awarded for the action
 * @property levelUp - Whether player leveled up
 * @property newLevel - New player level (if levelUp is true)
 */
export interface AttackResult {
  success: boolean;
  message: string;
  playerPower: number;
  factoryDefense: number;
  captured: boolean;
  damageDealt?: number;
  xpAwarded?: number;
  levelUp?: boolean;
  newLevel?: number;
}

/**
 * Bank transaction types
 */
export type BankTransactionType = 'deposit' | 'withdrawal' | 'exchange';

/**
 * Bank transaction record for audit trail
 * 
 * @property playerId - Player's username
 * @property type - Transaction type
 * @property resourceType - 'metal' or 'energy'
 * @property amount - Amount of resource involved
 * @property fee - Fee charged (if any)
 * @property timestamp - When transaction occurred
 * @property fromResource - For exchanges: what was given
 * @property toResource - For exchanges: what was received
 */
export interface BankTransaction {
  playerId: string;
  type: BankTransactionType;
  resourceType: 'metal' | 'energy';
  amount: number;
  fee: number;
  timestamp: Date;
  fromResource?: { type: 'metal' | 'energy'; amount: number };
  toResource?: { type: 'metal' | 'energy'; amount: number };
}

/**
 * Battle types for PVP combat system
 */
export enum BattleType {
  Infantry = 'INFANTRY',   // Player vs Player direct combat
  Base = 'BASE',           // Attack enemy home base
  Factory = 'FACTORY'      // Factory ownership battle
}

/**
 * Battle outcome for combat resolution
 */
export enum BattleOutcome {
  AttackerWin = 'ATTACKER_WIN',
  DefenderWin = 'DEFENDER_WIN',
  Draw = 'DRAW'
}

/**
 * Battle participant information
 */
export interface BattleParticipant {
  username: string;
  units: Unit[];         // Units brought to battle
  totalSTR: number;      // Total strength in battle
  totalDEF: number;      // Total defense in battle
  initialHP: number;     // Starting HP (based on units)
  finalHP: number;       // HP after battle
  unitsLost: number;     // Count of units killed
  unitsCaptured: number; // Count of enemy units captured
  
  // Aliases for convenience (match component expectations)
  startingHP: number;    // Alias for initialHP
  endingHP: number;      // Alias for finalHP
  damageDealt: number;   // Total damage dealt to opponent
  xpEarned: number;      // XP earned from battle
}

/**
 * Combat round details for battle log
 */
export interface CombatRound {
  roundNumber: number;
  attackerDamage: number;
  defenderDamage: number;
  attackerHP: number;    // HP after this round
  defenderHP: number;    // HP after this round
  attackerUnitsLost: number;
  defenderUnitsLost: number;
}

/**
 * Battle log for storing combat history
 */
export interface BattleLog {
  _id?: string;
  battleId: string;        // Unique battle identifier
  battleType: BattleType;
  timestamp: Date;
  
  // Participants
  attacker: BattleParticipant;
  defender: BattleParticipant;
  
  // Battle details
  outcome: BattleOutcome;
  rounds: CombatRound[];
  totalRounds: number;
  
  // Loot and captures
  resourcesStolen?: {
    resourceType: 'metal' | 'energy';
    amount: number;
  };
  unitsCaptured?: {
    attackerCaptured: Unit[];  // Units attacker captured from defender
    defenderCaptured: Unit[];  // Units defender captured from attacker
  };
  
  // XP awards
  attackerXP: number;
  defenderXP: number;
  
  // Location (if applicable)
  location?: Position;
  
  // Battle notes/message
  message?: string;
  notes?: string;
}

/**
 * Battle result returned from combat resolution
 */
export interface BattleResult {
  success: boolean;
  message: string;
  battleLog: BattleLog;
  
  // Flattened properties for convenience
  outcome: BattleOutcome;
  rounds: number;
  battleType: BattleType;
  attacker: BattleParticipant;
  defender: BattleParticipant;
  resourcesStolen?: {
    resourceType: 'metal' | 'energy';
    amount: number;
  };
  
  // Level up info
  attackerLevelUp?: boolean;
  defenderLevelUp?: boolean;
  attackerNewLevel?: number;
  defenderNewLevel?: number;
}

/**
 * Infantry battle request (Player vs Player direct combat)
 */
export interface InfantryAttackRequest {
  targetUsername: string;
  unitIds: string[];  // Units to bring to battle
}

/**
 * Base attack request (Attack home base)
 */
export interface BaseAttackRequest {
  targetUsername: string;
  unitIds: string[];  // Units to bring to battle
  resourceToSteal: 'metal' | 'energy'; // Which resource to steal if victorious
}

/**
 * Factory attack already exists (using factoryService)
 * But we'll enhance it to include unit battles if both players have units at factory
 */

/**
 * Harvest status response for cooldown checks
 * 
 * @property canHarvest - Whether player can harvest this tile
 * @property timeUntilReset - Milliseconds until next reset
 * @property resetPeriod - Current reset period identifier
 */
export interface HarvestStatus {
  canHarvest: boolean;
  timeUntilReset: number;
  resetPeriod: string;
}

/**
 * Factory statistics at a given level
 * 
 * @property level - Factory level (1-10)
 * @property maxSlots - Maximum unit slots
 * @property regenRate - Slot regeneration rate (hours)
 * @property strengthBonus - Strength bonus percentage
 * @property defenseBonus - Defense bonus percentage
 */
export interface FactoryStats {
  level: number;
  maxSlots: number;
  regenRate: number;
  strengthBonus: number;
  defenseBonus: number;
}

/**
 * Enhanced factory data with upgrade information
 * Extends base Factory interface with computed fields
 * 
 * @property stats - Current level statistics
 * @property timeUntilNext - Milliseconds until next slot regeneration
 * @property upgradeCost - Cost to upgrade (null if max level)
 * @property canUpgrade - Whether player can afford upgrade
 * @property totalInvested - Total resources invested in upgrades
 */
export interface EnhancedFactory extends Factory {
  stats: FactoryStats;
  timeUntilNext: number;
  upgradeCost: { metal: number; energy: number } | null;
  canUpgrade: boolean;
  totalInvested?: { metal: number; energy: number };
}

/**
 * Sort options for inventory filtering
 */
export type InventorySortOption = 'rarity' | 'type' | 'date' | 'bonus';

// ============================================================
// ADMIN TRACKING & ANTI-CHEAT SYSTEM (Phase 1)
// ============================================================

/**
 * Player action types for activity tracking
 * Captures all significant player actions for analytics and anti-cheat
 */
export type PlayerActionType = 
  | 'harvest'           // Resource gathering from tiles
  | 'attack'            // Combat against other players
  | 'build_factory'     // Factory construction
  | 'upgrade_factory'   // Factory level upgrades
  | 'trade'             // Auction house transactions
  | 'move'              // Map movement
  | 'tech_unlock'       // Tech tree research
  | 'bank_deposit'      // Banking resources
  | 'bank_withdraw'     // Withdrawing resources
  | 'shrine_boost'      // Shrine boost activation
  | 'cave_explore'      // Cave exploration
  | 'login'             // Player login event
  | 'logout';           // Player logout event

/**
 * Player activity record for comprehensive tracking
 * Used for analytics, anti-cheat detection, and admin monitoring
 * 
 * @property userId - Player's unique username
 * @property action - Type of action performed
 * @property timestamp - When the action occurred
 * @property sessionId - Session identifier for grouping actions
 * @property metadata - Action-specific data for analysis
 */
export interface PlayerActivity {
  userId: string;
  username: string;
  action: PlayerActionType;
  timestamp: Date;
  sessionId: string;
  metadata?: {
    resourcesGained?: { metal?: number; energy?: number; };
    resourcesSpent?: { metal?: number; energy?: number; };
    target?: string;              // For attacks/trades
    location?: { x: number; y: number; };
    duration?: number;            // For harvests (seconds)
    result?: 'success' | 'failure' | 'partial';
    itemsGained?: string[];       // For caves/trades
    techUnlocked?: string;        // For tech unlocks
    factoryLevel?: number;        // For factory actions
  };
}

/**
 * Player session tracking for login/logout analytics
 * Enables session time tracking and activity pattern analysis
 * 
 * @property userId - Player's unique username
 * @property sessionId - Unique session identifier
 * @property startTime - Session start timestamp
 * @property endTime - Session end timestamp (null if active)
 * @property duration - Session length in seconds
 * @property actionsCount - Number of actions in this session
 * @property resourcesGained - Total resources gained during session
 * @property ipAddress - Client IP for multi-account detection (optional)
 */
export interface PlayerSession {
  userId: string;
  username: string;
  sessionId: string;
  startTime: Date;
  endTime?: Date;
  duration?: number;              // Seconds
  actionsCount: number;
  resourcesGained: { metal: number; energy: number; };
  ipAddress?: string;
}

/**
 * Anti-cheat flag types for different violation categories
 */
export type FlagType = 
  | 'speed_hack'          // Impossible movement speeds
  | 'resource_hack'       // Impossible resource gains
  | 'cooldown_violation'  // Actions before cooldown expires
  | 'bot_behavior'        // Automated/scripted patterns
  | 'session_abuse'       // Unrealistic session durations
  | 'theoretical_max'     // Gains exceed game mechanics limits
  | 'multi_account';      // Multiple accounts from same IP

/**
 * Flag severity levels for prioritization
 */
export type FlagSeverity = 'low' | 'medium' | 'high' | 'critical';

/**
 * Player flag for anti-cheat system
 * Automatically generated when suspicious activity detected
 * 
 * @property userId - Flagged player's username
 * @property flagType - Type of violation detected
 * @property severity - How severe the violation is
 * @property timestamp - When the flag was created
 * @property evidence - Supporting data for the flag
 * @property resolved - Whether admin reviewed/cleared the flag
 * @property adminNotes - Admin comments on resolution
 * @property autoGenerated - Whether flag was automatic or manual
 */
export interface PlayerFlag {
  userId: string;
  username: string;
  flagType: FlagType;
  severity: FlagSeverity;
  timestamp: Date;
  evidence: {
    description: string;
    data: any;                    // Specific data that triggered flag
    actionId?: string;            // Reference to PlayerActivity record
  };
  resolved: boolean;
  resolvedAt?: Date;
  resolvedBy?: string;            // Admin username
  adminNotes?: string;
  autoGenerated: boolean;
}

/**
 * Aggregated player analytics for admin dashboard
 * Pre-computed metrics to reduce query load
 * 
 * @property userId - Player's username
 * @property period - Time period ('24h' | '7d' | '30d')
 * @property totalActions - Total actions in period
 * @property sessionCount - Number of sessions in period
 * @property totalSessionTime - Total time played (seconds)
 * @property resourcesGained - Total resources farmed
 * @property attacksLaunched - Attacks initiated
 * @property attacksReceived - Attacks defended
 * @property factoriesBuilt - Factories constructed
 * @property techsUnlocked - Technologies researched
 * @property flagCount - Number of anti-cheat flags
 * @property lastActive - Most recent activity timestamp
 */
export interface PlayerAnalytics {
  userId: string;
  username: string;
  period: '24h' | '7d' | '30d';
  totalActions: number;
  sessionCount: number;
  totalSessionTime: number;       // Seconds
  resourcesGained: { metal: number; energy: number; };
  attacksLaunched: number;
  attacksReceived: number;
  factoriesBuilt: number;
  techsUnlocked: number;
  flagCount: number;
  lastActive: Date;
  computedAt: Date;               // When these stats were calculated
}

// ============================================================
// IMPLEMENTATION NOTES:
// ============================================================
// - All coordinates use 1-based indexing (1-150, not 0-149)
// - TerrainType enum provides type safety for terrain values
// - Movement directions support both keyboard input and programmatic use
// - API response types ensure consistent error handling
// - GAME_CONSTANTS centralize all magic numbers
// - HarvestResult used for below-image display (not overlay)
// - Factory system supports ownership, slots, and unit production
// - Attack system uses player power calculation for success rate
// - PlayerActivity tracks ALL player actions for analytics
// - PlayerSession enables session time and pattern analysis
// - PlayerFlag system automatically detects suspicious behavior
// - PlayerAnalytics pre-computes metrics for admin dashboard
// ============================================================
// END OF FILE
// ============================================================

@@@END@@@
@@@FILE:types/index.ts@@@
/**
 * @file types/index.ts
 * @created 2025-10-16
 * @overview Barrel export file for all TypeScript type definitions
 */

// Re-export all game types
export * from './game.types';

// Re-export all auction types
export * from './auction.types';

// Re-export all map types
export * from './map.types';

// Re-export all flag types
export * from './flag.types';

@@@END@@@
@@@FILE:types/map.types.ts@@@
/**
 * @file map.types.ts
 * @created 2025-10-20
 * @overview TypeScript type definitions for the PixiJS-based interactive map system
 * 
 * OVERVIEW:
 * Defines all types related to the Flag feature map visualization including zoom levels,
 * viewport configuration, player markers, and map interaction states. These types support
 * the PixiJS rendering engine and real-time WebSocket updates for the 150x150 grid map.
 * 
 * The map system serves as the foundation for:
 * - Flag Bearer tracking and visualization
 * - Particle trail rendering (8-minute golden sparkles)
 * - Territory control displays (future: Clan Wars)
 * - Factory location visualization
 * - Player position tracking and navigation
 */

import { type Position, TerrainType } from './game.types';

/**
 * Zoom level configurations for the PixiJS map
 * 
 * Determines how much of the 150x150 map is visible at once:
 * - FullMap: See all 22,500 tiles (strategic overview)
 * - Quadrant: See ~5,625 tiles (regional planning)
 * - Zone: See ~1,369 tiles (local area tactics)
 * - Region: See ~324 tiles (detailed positioning)
 * 
 * @example
 * ```ts
 * const zoom: ZoomLevel = 'Zone'; // 4x magnification
 * ```
 */
export type ZoomLevel = 'FullMap' | 'Quadrant' | 'Zone' | 'Region';

/**
 * Zoom level scale multipliers for PixiJS camera
 * 
 * Maps ZoomLevel to actual PixiJS scale values for rendering
 */
export const ZOOM_SCALES: Record<ZoomLevel, number> = {
  FullMap: 1.0,   // 150x150 tiles visible
  Quadrant: 2.0,  // 75x75 tiles visible
  Zone: 4.0,      // 37x37 tiles visible
  Region: 8.0     // 18x18 tiles visible
};

/**
 * Visible tile counts at each zoom level (approximate)
 * 
 * Used for performance optimization (viewport culling)
 */
export const ZOOM_VISIBLE_TILES: Record<ZoomLevel, number> = {
  FullMap: 22500,  // All tiles
  Quadrant: 5625,  // 75x75
  Zone: 1369,      // 37x37
  Region: 324      // 18x18
};

/**
 * Map tile data structure for rendering
 * 
 * Extended from base Tile interface with rendering-specific properties
 * 
 * @property x - Horizontal coordinate (1-150)
 * @property y - Vertical coordinate (1-150)
 * @property terrain - Terrain type for coloring/texture
 * @property isVisible - Whether tile is currently in viewport (for culling)
 * @property hasPlayer - Whether a player is currently on this tile
 * @property hasFlagBearer - Whether the Flag Bearer is on this tile
 * @property hasParticleTrail - Whether this tile has Flag Bearer's particle trail
 * @property trailAge - Age of particle trail in minutes (0-8)
 */
export interface MapTile {
  x: number;
  y: number;
  terrain: TerrainType;
  isVisible?: boolean;
  hasPlayer?: boolean;
  hasFlagBearer?: boolean;
  hasParticleTrail?: boolean;
  trailAge?: number;
}

/**
 * Player marker configuration for map display
 * 
 * Represents a player's position on the interactive map with visual styling
 * 
 * @property playerId - Unique player identifier (username or ObjectId)
 * @property username - Display name for tooltips
 * @property position - Current map coordinates
 * @property color - Marker color (hex string, e.g., "#2196F3")
 * @property isCurrentPlayer - Whether this is the logged-in player (blue marker)
 * @property isFlagBearer - Whether this player holds the Flag (golden marker with aura)
 * @property size - Marker size in pixels (default: 16)
 * 
 * @example
 * ```ts
 * const marker: PlayerMarker = {
 *   playerId: 'user123',
 *   username: 'DarkKnight',
 *   position: { x: 47, y: 89 },
 *   color: '#2196F3',
 *   isCurrentPlayer: true,
 *   isFlagBearer: false,
 *   size: 16
 * };
 * ```
 */
export interface PlayerMarker {
  playerId: string;
  username: string;
  position: Position;
  color: string;
  isCurrentPlayer: boolean;
  isFlagBearer: boolean;
  size?: number;
}

/**
 * Map viewport configuration for camera control
 * 
 * Defines the visible portion of the map and camera positioning
 * 
 * @property x - Camera X position in world coordinates
 * @property y - Camera Y position in world coordinates
 * @property width - Viewport width in pixels
 * @property height - Viewport height in pixels
 * @property scale - Current zoom scale (from ZOOM_SCALES)
 * @property centerOn - Position to center camera on (usually player position)
 * 
 * @example
 * ```ts
 * const viewport: MapViewport = {
 *   x: 0,
 *   y: 0,
 *   width: 1200,
 *   height: 800,
 *   scale: 2.0,
 *   centerOn: { x: 47, y: 89 }
 * };
 * ```
 */
export interface MapViewport {
  x: number;
  y: number;
  width: number;
  height: number;
  scale: number;
  centerOn?: Position;
}

/**
 * Map interaction state for user controls
 * 
 * Tracks pan, zoom, and interaction states for the map interface
 * 
 * @property isPanning - Whether user is actively panning the camera
 * @property isZooming - Whether user is actively zooming (pinch gesture or wheel)
 * @property selectedTile - Currently selected/clicked tile coordinates
 * @property hoveredTile - Tile coordinates under mouse/touch pointer
 * @property panStartPosition - Starting position for pan gesture (touch or mouse)
 * @property lastPinchDistance - Previous distance between touch points (mobile pinch-zoom)
 */
export interface MapInteractionState {
  isPanning: boolean;
  isZooming: boolean;
  selectedTile: Position | null;
  hoveredTile: Position | null;
  panStartPosition: Position | null;
  lastPinchDistance: number | null;
}

/**
 * Tile color mapping for terrain visualization
 * 
 * Maps TerrainType enum values to hex colors for PixiJS rendering
 */
export const TILE_COLORS: Record<TerrainType, number> = {
  [TerrainType.Metal]: 0x4CAF50,      // Green
  [TerrainType.Energy]: 0xF44336,     // Red
  [TerrainType.Cave]: 0x795548,       // Brown
  [TerrainType.Forest]: 0x2E7D32,     // Dark Green
  [TerrainType.Factory]: 0x607D8B,    // Gray
  [TerrainType.Wasteland]: 0x424242,  // Dark Gray
  [TerrainType.Bank]: 0xFFD700,       // Gold
  [TerrainType.Shrine]: 0x9C27B0      // Purple
};

/**
 * Map configuration constants
 * 
 * Defines core map parameters for the PixiJS rendering system
 */
export const MAP_CONFIG = {
  /** Total map width in tiles */
  WIDTH: 150,
  
  /** Total map height in tiles */
  HEIGHT: 150,
  
  /** Total number of tiles on map */
  TOTAL_TILES: 22500,
  
  /** Tile size in pixels for rendering - 24px for balanced full map view (150Ã—24 = 3600px) */
  TILE_SIZE: 24,
  
  /** Map coordinate boundaries */
  MIN_COORDINATE: 1,
  MAX_COORDINATE: 150,
  
  /** Performance targets */
  TARGET_FPS_DESKTOP: 60,
  TARGET_FPS_MOBILE: 30,
  
  /** Marker sizes */
  PLAYER_MARKER_SIZE: 14, // Balanced size for 24px tiles
  FLAG_MARKER_SIZE: 20, // Balanced size for 24px tiles
  
  /** Animation durations (milliseconds) */
  ZOOM_TRANSITION_MS: 300,
  PAN_TRANSITION_MS: 200,
  MARKER_PULSE_MS: 2000
} as const;

/**
 * WebSocket event payloads for real-time map updates
 * 
 * Defines data structures for WebSocket events related to map state changes
 */

/**
 * Player moved event payload
 * 
 * Broadcast when any player changes position on the map
 */
export interface MapPlayerMovedPayload {
  playerId: string;
  username: string;
  oldPosition: Position;
  newPosition: Position;
  isFlagBearer: boolean;
  timestamp: number;
}

/**
 * Map state update event payload
 * 
 * Broadcast for general map state changes (future: Flag location, territory updates)
 */
export interface MapStateUpdatePayload {
  updatedTiles?: MapTile[];
  playerPositions?: PlayerMarker[];
  flagBearerPosition?: Position | null;
  timestamp: number;
}

/**
 * Map tile click event data
 * 
 * Emitted when user clicks a tile on the map
 */
export interface MapTileClickEvent {
  tile: MapTile;
  position: Position;
  worldPosition: { x: number; y: number }; // PixiJS world coordinates
  screenPosition: { x: number; y: number }; // Screen pixel coordinates
}

/**
 * Type guard to check if coordinates are within map bounds
 * 
 * @param x - X coordinate to validate
 * @param y - Y coordinate to validate
 * @returns True if coordinates are valid (1-150)
 * 
 * @example
 * ```ts
 * if (isValidMapCoordinate(47, 89)) {
 *   // Coordinates are within map bounds
 * }
 * ```
 */
export function isValidMapCoordinate(x: number, y: number): boolean {
  return (
    x >= MAP_CONFIG.MIN_COORDINATE &&
    x <= MAP_CONFIG.MAX_COORDINATE &&
    y >= MAP_CONFIG.MIN_COORDINATE &&
    y <= MAP_CONFIG.MAX_COORDINATE
  );
}

/**
 * Calculate Euclidean distance between two positions
 * 
 * Used for:
 * - Challenge range validation (15 tiles for Flag stealing)
 * - Distance display in UI ("45 tiles away")
 * - Pathfinding calculations (future feature)
 * 
 * @param pos1 - First position
 * @param pos2 - Second position
 * @returns Distance in tiles (float)
 * 
 * @example
 * ```ts
 * const dist = calculateDistance(
 *   { x: 10, y: 10 },
 *   { x: 20, y: 20 }
 * ); // Returns ~14.14 tiles
 * ```
 */
export function calculateDistance(pos1: Position, pos2: Position): number {
  return Math.sqrt(
    Math.pow(pos2.x - pos1.x, 2) + 
    Math.pow(pos2.y - pos1.y, 2)
  );
}

/**
 * Convert tile coordinates to PixiJS world coordinates
 * 
 * @param tileX - Tile X coordinate (1-150)
 * @param tileY - Tile Y coordinate (1-150)
 * @returns World position in pixels for PixiJS rendering
 * 
 * @example
 * ```ts
 * const worldPos = tileToWorld(47, 89);
 * // Returns { x: 1504, y: 2848 } (47 * 32, 89 * 32)
 * ```
 */
export function tileToWorld(tileX: number, tileY: number): { x: number; y: number } {
  return {
    x: tileX * MAP_CONFIG.TILE_SIZE,
    y: tileY * MAP_CONFIG.TILE_SIZE
  };
}

/**
 * Convert PixiJS world coordinates to tile coordinates
 * 
 * @param worldX - World X position in pixels
 * @param worldY - World Y position in pixels
 * @returns Tile coordinates (floored to integers)
 * 
 * @example
 * ```ts
 * const tilePos = worldToTile(1504, 2848);
 * // Returns { x: 47, y: 89 }
 * ```
 */
export function worldToTile(worldX: number, worldY: number): Position {
  return {
    x: Math.floor(worldX / MAP_CONFIG.TILE_SIZE),
    y: Math.floor(worldY / MAP_CONFIG.TILE_SIZE)
  };
}

@@@END@@@
@@@FILE:types/units.types.ts@@@
/**
 * @file types/units.types.ts
 * @created 2025-10-17
 * @overview Unit type definitions for the unit factory system
 */

/**
 * Unit rarity/tier levels
 */
export enum UnitRarity {
  Common = 1,      // â­
  Uncommon = 2,    // â­â­
  Rare = 3,        // â­â­â­
  Epic = 4,        // â­â­â­â­
  Legendary = 5    // â­â­â­â­â­
}

/**
 * Unit category (offense vs defense)
 */
export enum UnitCategory {
  Strength = 'strength',  // Offensive units
  Defense = 'defense'     // Defensive units
}

/**
 * Unit blueprint definition
 */
export interface UnitBlueprint {
  id: string;
  name: string;
  category: UnitCategory;
  rarity: UnitRarity;
  strength: number;      // STR value (0 if defensive unit)
  defense: number;       // DEF value (0 if offensive unit)
  metalCost: number;
  energyCost: number;
  description: string;
  unlockRequirement?: {
    researchPoints: number;
    level?: number;
  };
}

/**
 * Tech tree node
 */
export interface TechNode {
  id: string;
  name: string;
  description: string;
  cost: number;          // Research points required
  unlocks: string[];     // Unit IDs this unlocks
  prerequisites: string[]; // Tech node IDs required first
  isUnlocked: boolean;
}

/**
 * All available unit blueprints
 */
export const UNIT_BLUEPRINTS: Record<string, UnitBlueprint> = {
  // ========================================
  // STRENGTH UNITS (Offensive)
  // ========================================
  
  // Common STR Units (Tier 1) - 4 units
  'infantry': {
    id: 'infantry',
    name: 'Infantry',
    category: UnitCategory.Strength,
    rarity: UnitRarity.Common,
    strength: 100,
    defense: 0,
    metalCost: 200,
    energyCost: 200,
    description: 'Basic ground troops. Reliable and affordable.',
  },
  
  'scout': {
    id: 'scout',
    name: 'Scout',
    category: UnitCategory.Strength,
    rarity: UnitRarity.Common,
    strength: 80,
    defense: 0,
    metalCost: 150,
    energyCost: 250,
    description: 'Fast and agile reconnaissance unit.',
  },
  
  'militia': {
    id: 'militia',
    name: 'Militia',
    category: UnitCategory.Strength,
    rarity: UnitRarity.Common,
    strength: 90,
    defense: 0,
    metalCost: 180,
    energyCost: 180,
    description: 'Volunteer fighters. Cost-effective basic troops.',
  },
  
  'rifleman': {
    id: 'rifleman',
    name: 'Rifleman',
    category: UnitCategory.Strength,
    rarity: UnitRarity.Common,
    strength: 95,
    defense: 0,
    metalCost: 190,
    energyCost: 210,
    description: 'Standard infantry with rifles. Balanced firepower.',
  },
  
  // Uncommon STR Units (Tier 2) - 4 units
  'marksman': {
    id: 'marksman',
    name: 'Marksman',
    category: UnitCategory.Strength,
    rarity: UnitRarity.Uncommon,
    strength: 250,
    defense: 0,
    metalCost: 500,
    energyCost: 400,
    description: 'Precision ranged attacker with high damage output.',
    unlockRequirement: { researchPoints: 50 }
  },
  
  'cavalry': {
    id: 'cavalry',
    name: 'Cavalry',
    category: UnitCategory.Strength,
    rarity: UnitRarity.Uncommon,
    strength: 280,
    defense: 0,
    metalCost: 600,
    energyCost: 500,
    description: 'Mobile strike force. Fast and deadly.',
    unlockRequirement: { researchPoints: 50 }
  },
  
  'grenadier': {
    id: 'grenadier',
    name: 'Grenadier',
    category: UnitCategory.Strength,
    rarity: UnitRarity.Uncommon,
    strength: 300,
    defense: 0,
    metalCost: 550,
    energyCost: 550,
    description: 'Explosive specialist. High area damage.',
    unlockRequirement: { researchPoints: 75 }
  },
  
  'saboteur': {
    id: 'saboteur',
    name: 'Saboteur',
    category: UnitCategory.Strength,
    rarity: UnitRarity.Uncommon,
    strength: 260,
    defense: 0,
    metalCost: 480,
    energyCost: 520,
    description: 'Covert operative. Disrupts enemy infrastructure.',
    unlockRequirement: { researchPoints: 60 }
  },
  
  // Rare STR Units (Tier 3) - 4 units
  'sniper': {
    id: 'sniper',
    name: 'Sniper',
    category: UnitCategory.Strength,
    rarity: UnitRarity.Rare,
    strength: 600,
    defense: 0,
    metalCost: 1200,
    energyCost: 1000,
    description: 'Elite long-range assassin. One-shot elimination.',
    unlockRequirement: { researchPoints: 150, level: 3 }
  },
  
  'commando': {
    id: 'commando',
    name: 'Commando',
    category: UnitCategory.Strength,
    rarity: UnitRarity.Rare,
    strength: 700,
    defense: 0,
    metalCost: 1500,
    energyCost: 1200,
    description: 'Special operations unit. Versatile and lethal.',
    unlockRequirement: { researchPoints: 200, level: 4 }
  },
  
  'artillery': {
    id: 'artillery',
    name: 'Artillery',
    category: UnitCategory.Strength,
    rarity: UnitRarity.Rare,
    strength: 800,
    defense: 0,
    metalCost: 1800,
    energyCost: 1500,
    description: 'Heavy siege weapon. Devastating firepower.',
    unlockRequirement: { researchPoints: 250, level: 5 }
  },
  
  'bombardier': {
    id: 'bombardier',
    name: 'Bombardier',
    category: UnitCategory.Strength,
    rarity: UnitRarity.Rare,
    strength: 650,
    defense: 0,
    metalCost: 1300,
    energyCost: 1400,
    description: 'Aerial bomber. Rains destruction from above.',
    unlockRequirement: { researchPoints: 180, level: 4 }
  },
  
  // Epic STR Units (Tier 4) - 4 units
  'tank': {
    id: 'tank',
    name: 'Battle Tank',
    category: UnitCategory.Strength,
    rarity: UnitRarity.Epic,
    strength: 1500,
    defense: 0,
    metalCost: 3500,
    energyCost: 3000,
    description: 'Armored behemoth. Unstoppable offensive power.',
    unlockRequirement: { researchPoints: 500, level: 7 }
  },
  
  'bomber': {
    id: 'bomber',
    name: 'Bomber',
    category: UnitCategory.Strength,
    rarity: UnitRarity.Epic,
    strength: 1800,
    defense: 0,
    metalCost: 4000,
    energyCost: 3500,
    description: 'Aerial devastation. Carpet bombing specialist.',
    unlockRequirement: { researchPoints: 600, level: 8 }
  },
  
  'juggernaut': {
    id: 'juggernaut',
    name: 'Juggernaut',
    category: UnitCategory.Strength,
    rarity: UnitRarity.Epic,
    strength: 1600,
    defense: 0,
    metalCost: 3700,
    energyCost: 3200,
    description: 'Unstoppable heavy infantry. Crushes all opposition.',
    unlockRequirement: { researchPoints: 550, level: 7 }
  },
  
  'gunship': {
    id: 'gunship',
    name: 'Gunship',
    category: UnitCategory.Strength,
    rarity: UnitRarity.Epic,
    strength: 1700,
    defense: 0,
    metalCost: 3900,
    energyCost: 3300,
    description: 'Attack helicopter. Mobile firepower platform.',
    unlockRequirement: { researchPoints: 580, level: 8 }
  },
  
  // Legendary STR Units (Tier 5) - 4 units
  'titan': {
    id: 'titan',
    name: 'Titan Mech',
    category: UnitCategory.Strength,
    rarity: UnitRarity.Legendary,
    strength: 5000,
    defense: 0,
    metalCost: 10000,
    energyCost: 8000,
    description: 'Experimental war machine. Ultimate destruction.',
    unlockRequirement: { researchPoints: 1500, level: 10 }
  },
  
  'warlord': {
    id: 'warlord',
    name: 'Warlord',
    category: UnitCategory.Strength,
    rarity: UnitRarity.Legendary,
    strength: 4500,
    defense: 0,
    metalCost: 9500,
    energyCost: 7500,
    description: 'Supreme commander unit. Inspires devastating attacks.',
    unlockRequirement: { researchPoints: 1400, level: 10 }
  },
  
  'dreadnought': {
    id: 'dreadnought',
    name: 'Dreadnought',
    category: UnitCategory.Strength,
    rarity: UnitRarity.Legendary,
    strength: 5500,
    defense: 0,
    metalCost: 11000,
    energyCost: 9000,
    description: 'Legendary warship. Unmatched firepower.',
    unlockRequirement: { researchPoints: 1600, level: 11 }
  },
  
  'annihilator': {
    id: 'annihilator',
    name: 'Annihilator',
    category: UnitCategory.Strength,
    rarity: UnitRarity.Legendary,
    strength: 4800,
    defense: 0,
    metalCost: 9800,
    energyCost: 7800,
    description: 'Total warfare specialist. Leaves nothing behind.',
    unlockRequirement: { researchPoints: 1450, level: 10 }
  },
  
  // ========================================
  // DEFENSE UNITS (Defensive)
  // ========================================
  
  // Common DEF Units (Tier 1) - 4 units
  'barricade': {
    id: 'barricade',
    name: 'Barricade',
    category: UnitCategory.Defense,
    rarity: UnitRarity.Common,
    strength: 0,
    defense: 100,
    metalCost: 200,
    energyCost: 200,
    description: 'Basic defensive structure. Simple but effective.',
  },
  
  'watchman': {
    id: 'watchman',
    name: 'Watchman',
    category: UnitCategory.Defense,
    rarity: UnitRarity.Common,
    strength: 0,
    defense: 90,
    metalCost: 180,
    energyCost: 220,
    description: 'Alert sentry. Early warning system.',
  },
  
  'palisade': {
    id: 'palisade',
    name: 'Palisade',
    category: UnitCategory.Defense,
    rarity: UnitRarity.Common,
    strength: 0,
    defense: 110,
    metalCost: 220,
    energyCost: 180,
    description: 'Wooden fortification. Sturdy barrier.',
  },
  
  'trench': {
    id: 'trench',
    name: 'Trench',
    category: UnitCategory.Defense,
    rarity: UnitRarity.Common,
    strength: 0,
    defense: 95,
    metalCost: 190,
    energyCost: 210,
    description: 'Dug-in position. Protects from incoming fire.',
  },
  
  // Uncommon DEF Units (Tier 2) - 4 units
  'wall': {
    id: 'wall',
    name: 'Stone Wall',
    category: UnitCategory.Defense,
    rarity: UnitRarity.Uncommon,
    strength: 0,
    defense: 250,
    metalCost: 500,
    energyCost: 400,
    description: 'Reinforced stone barrier. Solid protection.',
    unlockRequirement: { researchPoints: 50 }
  },
  
  'guardian': {
    id: 'guardian',
    name: 'Guardian',
    category: UnitCategory.Defense,
    rarity: UnitRarity.Uncommon,
    strength: 0,
    defense: 280,
    metalCost: 550,
    energyCost: 500,
    description: 'Elite defensive unit. Protects key positions.',
    unlockRequirement: { researchPoints: 75 }
  },
  
  'turret': {
    id: 'turret',
    name: 'Auto-Turret',
    category: UnitCategory.Defense,
    rarity: UnitRarity.Uncommon,
    strength: 0,
    defense: 300,
    metalCost: 600,
    energyCost: 550,
    description: 'Automated defense system. Constant vigilance.',
    unlockRequirement: { researchPoints: 100 }
  },
  
  'rampart': {
    id: 'rampart',
    name: 'Rampart',
    category: UnitCategory.Defense,
    rarity: UnitRarity.Uncommon,
    strength: 0,
    defense: 260,
    metalCost: 480,
    energyCost: 520,
    description: 'Elevated defensive wall. Superior coverage.',
    unlockRequirement: { researchPoints: 60 }
  },
  
  // Rare DEF Units (Tier 3) - 4 units
  'bunker': {
    id: 'bunker',
    name: 'Bunker',
    category: UnitCategory.Defense,
    rarity: UnitRarity.Rare,
    strength: 0,
    defense: 700,
    metalCost: 1500,
    energyCost: 1200,
    description: 'Reinforced concrete shelter. Near impenetrable.',
    unlockRequirement: { researchPoints: 200, level: 4 }
  },
  
  'fortress': {
    id: 'fortress',
    name: 'Fortress',
    category: UnitCategory.Defense,
    rarity: UnitRarity.Rare,
    strength: 0,
    defense: 800,
    metalCost: 1800,
    energyCost: 1500,
    description: 'Massive defensive complex. Layers of protection.',
    unlockRequirement: { researchPoints: 250, level: 5 }
  },
  
  'sentinel': {
    id: 'sentinel',
    name: 'Sentinel Drone',
    category: UnitCategory.Defense,
    rarity: UnitRarity.Rare,
    strength: 0,
    defense: 650,
    metalCost: 1300,
    energyCost: 1400,
    description: 'Advanced AI defender. Adaptive countermeasures.',
    unlockRequirement: { researchPoints: 220, level: 4 }
  },
  
  'pillbox': {
    id: 'pillbox',
    name: 'Pillbox',
    category: UnitCategory.Defense,
    rarity: UnitRarity.Rare,
    strength: 0,
    defense: 600,
    metalCost: 1200,
    energyCost: 1000,
    description: 'Fortified firing position. Concentrated defensive fire.',
    unlockRequirement: { researchPoints: 180, level: 3 }
  },
  
  // Epic DEF Units (Tier 4) - 4 units
  'citadel': {
    id: 'citadel',
    name: 'Citadel',
    category: UnitCategory.Defense,
    rarity: UnitRarity.Epic,
    strength: 0,
    defense: 1800,
    metalCost: 4000,
    energyCost: 3500,
    description: 'Towering stronghold. Ultimate defensive position.',
    unlockRequirement: { researchPoints: 600, level: 8 }
  },
  
  'aegis': {
    id: 'aegis',
    name: 'Aegis Shield',
    category: UnitCategory.Defense,
    rarity: UnitRarity.Epic,
    strength: 0,
    defense: 1600,
    metalCost: 3800,
    energyCost: 3200,
    description: 'Energy shield generator. Absorbs massive damage.',
    unlockRequirement: { researchPoints: 550, level: 7 }
  },
  
  'stronghold': {
    id: 'stronghold',
    name: 'Stronghold',
    category: UnitCategory.Defense,
    rarity: UnitRarity.Epic,
    strength: 0,
    defense: 1700,
    metalCost: 3900,
    energyCost: 3300,
    description: 'Impregnable fortress. Withstands prolonged siege.',
    unlockRequirement: { researchPoints: 580, level: 8 }
  },
  
  'guardian_array': {
    id: 'guardian_array',
    name: 'Guardian Array',
    category: UnitCategory.Defense,
    rarity: UnitRarity.Epic,
    strength: 0,
    defense: 1500,
    metalCost: 3500,
    energyCost: 3000,
    description: 'Networked defense system. Coordinated protection.',
    unlockRequirement: { researchPoints: 500, level: 7 }
  },
  
  // Legendary DEF Units (Tier 5) - 4 units
  'bastion': {
    id: 'bastion',
    name: 'Bastion Core',
    category: UnitCategory.Defense,
    rarity: UnitRarity.Legendary,
    strength: 0,
    defense: 5000,
    metalCost: 10000,
    energyCost: 8000,
    description: 'Impenetrable fortress core. The last line of defense.',
    unlockRequirement: { researchPoints: 1500, level: 10 }
  },
  
  'colossus': {
    id: 'colossus',
    name: 'Colossus Wall',
    category: UnitCategory.Defense,
    rarity: UnitRarity.Legendary,
    strength: 0,
    defense: 4500,
    metalCost: 9500,
    energyCost: 7500,
    description: 'Legendary defensive structure. Unbreakable barrier.',
    unlockRequirement: { researchPoints: 1400, level: 10 }
  },
  
  'sentinel_prime': {
    id: 'sentinel_prime',
    name: 'Sentinel Prime',
    category: UnitCategory.Defense,
    rarity: UnitRarity.Legendary,
    strength: 0,
    defense: 5500,
    metalCost: 11000,
    energyCost: 9000,
    description: 'Ultimate AI defense. Perfect threat neutralization.',
    unlockRequirement: { researchPoints: 1600, level: 11 }
  },
  
  'invincible': {
    id: 'invincible',
    name: 'Invincible Fortress',
    category: UnitCategory.Defense,
    rarity: UnitRarity.Legendary,
    strength: 0,
    defense: 4800,
    metalCost: 9800,
    energyCost: 7800,
    description: 'Legendary stronghold. Absolute protection.',
    unlockRequirement: { researchPoints: 1450, level: 10 }
  },
};

/**
 * Tech tree definition
 */
export const TECH_TREE: Record<string, TechNode> = {
  'basic_training': {
    id: 'basic_training',
    name: 'Basic Training',
    description: 'Unlock Tier 2 offensive units',
    cost: 50,
    unlocks: ['marksman', 'cavalry'],
    prerequisites: [],
    isUnlocked: false
  },
  
  'advanced_weapons': {
    id: 'advanced_weapons',
    name: 'Advanced Weapons',
    description: 'Unlock explosive specialists',
    cost: 75,
    unlocks: ['grenadier'],
    prerequisites: ['basic_training'],
    isUnlocked: false
  },
  
  'elite_forces': {
    id: 'elite_forces',
    name: 'Elite Forces',
    description: 'Unlock Tier 3 special operations',
    cost: 150,
    unlocks: ['sniper', 'commando'],
    prerequisites: ['advanced_weapons'],
    isUnlocked: false
  },
  
  'heavy_artillery': {
    id: 'heavy_artillery',
    name: 'Heavy Artillery',
    description: 'Unlock siege weapons',
    cost: 250,
    unlocks: ['artillery'],
    prerequisites: ['elite_forces'],
    isUnlocked: false
  },
  
  'mechanized_warfare': {
    id: 'mechanized_warfare',
    name: 'Mechanized Warfare',
    description: 'Unlock Tier 4 vehicles',
    cost: 500,
    unlocks: ['tank', 'bomber'],
    prerequisites: ['heavy_artillery'],
    isUnlocked: false
  },
  
  'titan_project': {
    id: 'titan_project',
    name: 'Project Titan',
    description: 'Unlock ultimate weapon',
    cost: 1500,
    unlocks: ['titan'],
    prerequisites: ['mechanized_warfare'],
    isUnlocked: false
  },
  
  // Defense Tech Tree
  'fortification': {
    id: 'fortification',
    name: 'Fortification',
    description: 'Unlock Tier 2 defensive structures',
    cost: 50,
    unlocks: ['wall'],
    prerequisites: [],
    isUnlocked: false
  },
  
  'defensive_positions': {
    id: 'defensive_positions',
    name: 'Defensive Positions',
    description: 'Unlock advanced defenses',
    cost: 75,
    unlocks: ['guardian'],
    prerequisites: ['fortification'],
    isUnlocked: false
  },
  
  'automated_defense': {
    id: 'automated_defense',
    name: 'Automated Defense',
    description: 'Unlock AI-controlled turrets',
    cost: 100,
    unlocks: ['turret'],
    prerequisites: ['defensive_positions'],
    isUnlocked: false
  },
  
  'hardened_structures': {
    id: 'hardened_structures',
    name: 'Hardened Structures',
    description: 'Unlock Tier 3 fortifications',
    cost: 200,
    unlocks: ['bunker', 'sentinel'],
    prerequisites: ['automated_defense'],
    isUnlocked: false
  },
  
  'fortress_engineering': {
    id: 'fortress_engineering',
    name: 'Fortress Engineering',
    description: 'Unlock massive defensive complexes',
    cost: 250,
    unlocks: ['fortress'],
    prerequisites: ['hardened_structures'],
    isUnlocked: false
  },
  
  'advanced_defense': {
    id: 'advanced_defense',
    name: 'Advanced Defense Systems',
    description: 'Unlock Tier 4 defensive technology',
    cost: 550,
    unlocks: ['aegis', 'citadel'],
    prerequisites: ['fortress_engineering'],
    isUnlocked: false
  },
  
  'bastion_protocol': {
    id: 'bastion_protocol',
    name: 'Bastion Protocol',
    description: 'Unlock ultimate defense',
    cost: 1500,
    unlocks: ['bastion'],
    prerequisites: ['advanced_defense'],
    isUnlocked: false
  },
};

@@@END@@@
@@@FILE:types/websocket.ts@@@
/**
 * WebSocket Event Types and Payload Schemas
 * Created: 2025-10-19
 * 
 * OVERVIEW:
 * Comprehensive type-safe WebSocket event definitions for real-time communication.
 * Covers all event categories: game, clan, chat, combat, and system notifications.
 * 
 * Architecture:
 * - Server-to-Client events (broadcasts, notifications)
 * - Client-to-Server events (actions, requests)
 * - Bidirectional events (acknowledgments, responses)
 * 
 * Event Categories:
 * 1. Game Events: Position updates, resource changes, level-ups
 * 2. Clan Events: Member actions, territory changes, warfare
 * 3. Chat Events: Messages, typing indicators, presence
 * 4. Combat Events: Battle notifications, unit updates
 * 5. System Events: Achievements, maintenance, global notifications
 */

// ============================================================================
// BASE TYPES
// ============================================================================

export interface WebSocketUser {
  userId: string;
  username: string;
  level?: number;
  clanId?: string;
  clanName?: string;
}

export interface WebSocketError {
  code: string;
  message: string;
  details?: unknown;
}

// ============================================================================
// GAME EVENTS
// ============================================================================

export interface GamePositionUpdatePayload {
  userId: string;
  username: string;
  x: number;
  y: number;
  timestamp: number;
}

export interface GameResourceChangePayload {
  userId: string;
  resourceType: 'wood' | 'stone' | 'iron' | 'gold' | 'food' | 'energy';
  previousAmount: number;
  newAmount: number;
  change: number;
  reason: string;
}

export interface GameLevelUpPayload {
  userId: string;
  username: string;
  previousLevel: number;
  newLevel: number;
  unlockedFeatures?: string[];
}

export interface GameTileUpdatePayload {
  x: number;
  y: number;
  tileType: string;
  ownerId?: string;
  ownerName?: string;
  clanId?: string;
  clanName?: string;
}

export interface GamePlayerOnlinePayload {
  userId: string;
  username: string;
  level: number;
  x: number;
  y: number;
}

export interface GamePlayerOfflinePayload {
  userId: string;
  username: string;
}

// ============================================================================
// CLAN EVENTS
// ============================================================================

export interface ClanMemberJoinedPayload {
  clanId: string;
  clanName: string;
  userId: string;
  username: string;
  joinedAt: number;
  memberCount: number;
}

export interface ClanMemberLeftPayload {
  clanId: string;
  clanName: string;
  userId: string;
  username: string;
  reason: 'left' | 'kicked' | 'disbanded';
  leftAt: number;
  memberCount: number;
}

export interface ClanMemberRoleChangedPayload {
  clanId: string;
  userId: string;
  username: string;
  previousRole: string;
  newRole: string;
  changedBy: string;
}

export interface ClanTerritoryUpdatePayload {
  clanId: string;
  clanName: string;
  action: 'captured' | 'lost' | 'defended';
  x: number;
  y: number;
  previousOwner?: string;
  newOwner?: string;
  timestamp: number;
}

export interface ClanWarDeclaredPayload {
  warId: string;
  attackerClanId: string;
  attackerClanName: string;
  defenderClanId: string;
  defenderClanName: string;
  warType: 'territory' | 'resource' | 'honor';
  declaredAt: number;
  declaredBy: string;
}

export interface ClanWarEndedPayload {
  warId: string;
  attackerClanId: string;
  attackerClanName: string;
  defenderClanId: string;
  defenderClanName: string;
  winner: 'attacker' | 'defender' | 'draw';
  endedAt: number;
  casualties: {
    attacker: number;
    defender: number;
  };
  territoriesChanged?: number;
}

export interface ClanTreasuryUpdatePayload {
  clanId: string;
  resourceType: 'wood' | 'stone' | 'iron' | 'gold' | 'food';
  previousAmount: number;
  newAmount: number;
  change: number;
  actionType: 'deposit' | 'withdrawal' | 'war_cost' | 'building';
  performedBy: string;
  timestamp: number;
}

export interface ClanActivityPayload {
  clanId: string;
  activityType: 'member_joined' | 'member_left' | 'territory_captured' | 
                 'territory_lost' | 'war_declared' | 'war_won' | 'war_lost' |
                 'treasury_deposit' | 'treasury_withdrawal' | 'member_promoted' |
                 'member_demoted' | 'building_constructed';
  description: string;
  actorUserId?: string;
  actorUsername?: string;
  timestamp: number;
  metadata?: Record<string, unknown>;
}

export interface ClanLeaderboardUpdatePayload {
  clanId: string;
  clanName: string;
  category: 'power' | 'territory' | 'combat' | 'economic' | 'members';
  previousRank: number;
  newRank: number;
  rankChange: number;
  score: number;
}

// ============================================================================
// CHAT EVENTS
// ============================================================================

export interface ChatMessagePayload {
  messageId: string;
  clanId: string;
  userId: string;
  username: string;
  content: string;
  timestamp: number;
  mentions?: string[];
  isPinned?: boolean;
}

export interface ChatTypingPayload {
  clanId: string;
  userId: string;
  username: string;
  isTyping: boolean;
}

export interface ChatMemberOnlinePayload {
  clanId: string;
  userId: string;
  username: string;
  status: 'online' | 'away' | 'offline';
}

export interface ChatMessageEditedPayload {
  messageId: string;
  clanId: string;
  newContent: string;
  editedAt: number;
}

export interface ChatMessageDeletedPayload {
  messageId: string;
  clanId: string;
  deletedBy: string;
  deletedAt: number;
}

// ============================================================================
// COMBAT EVENTS
// ============================================================================

export interface CombatAttackStartedPayload {
  battleId: string;
  attackerId: string;
  attackerName: string;
  defenderId: string;
  defenderName: string;
  attackerClanId?: string;
  defenderClanId?: string;
  location: { x: number; y: number };
  startedAt: number;
}

export interface CombatBattleResultPayload {
  battleId: string;
  winner: string;
  loser: string;
  winnerClanId?: string;
  loserClanId?: string;
  casualties: {
    winner: number;
    loser: number;
  };
  resourcesLost: {
    winner: Record<string, number>;
    loser: Record<string, number>;
  };
  experienceGained: {
    winner: number;
    loser: number;
  };
  completedAt: number;
}

export interface CombatUnitDestroyedPayload {
  battleId: string;
  unitId: string;
  unitType: string;
  ownerId: string;
  ownerName: string;
  destroyedBy: string;
  timestamp: number;
}

export interface CombatDefenseAlertPayload {
  defenderId: string;
  defenderName: string;
  attackerId: string;
  attackerName: string;
  location: { x: number; y: number };
  estimatedArrival: number;
  threatLevel: 'low' | 'medium' | 'high' | 'critical';
}

// ============================================================================
// SYSTEM EVENTS
// ============================================================================

export interface SystemNotificationPayload {
  notificationId: string;
  type: 'info' | 'warning' | 'success' | 'error';
  title: string;
  message: string;
  userId?: string;
  clanId?: string;
  actionUrl?: string;
  timestamp: number;
  expiresAt?: number;
}

export interface SystemAchievementUnlockedPayload {
  userId: string;
  username: string;
  achievementId: string;
  achievementName: string;
  achievementDescription: string;
  rewards?: {
    experience?: number;
    gold?: number;
    items?: string[];
  };
  unlockedAt: number;
}

export interface SystemMaintenanceAlertPayload {
  maintenanceId: string;
  type: 'scheduled' | 'emergency';
  message: string;
  startTime: number;
  estimatedDuration: number;
  affectedSystems?: string[];
}

export interface SystemServerStatsPayload {
  onlinePlayers: number;
  activeClans: number;
  ongoingBattles: number;
  serverLoad: number;
  timestamp: number;
}

// ============================================================================
// WMD EVENTS
// ============================================================================

export interface WMDMissileLaunchedPayload {
  missileId: string;
  targetName: string;
  warheadType: string;
  impactAt: string;
  message: string;
}

export interface WMDIncomingMissilePayload {
  missileId: string;
  launcherName: string;
  warheadType: string;
  impactAt: string;
  message: string;
}

export interface WMDMissileInterceptedPayload {
  missileId: string;
  targetName?: string;
  launcherName?: string;
  interceptedBy: string;
  message: string;
}

export interface WMDInterceptionSuccessPayload {
  missileId: string;
  launcherName: string;
  message: string;
}

export interface WMDMissileImpactPayload {
  missileId: string;
  targetName?: string;
  launcherName?: string;
  warheadType: string;
  damageDealt: number;
  message: string;
}

export interface WMDResearchCompletePayload {
  techId: string;
  techName: string;
  category: string;
  message: string;
}

export interface WMDSpyMissionCompletePayload {
  missionId: string;
  spyName: string;
  targetName: string;
  missionType: string;
  success: boolean;
  intelligence?: string;
  message: string;
}

export interface WMDVoteUpdatePayload {
  voteId: string;
  voteType: string;
  proposer: string;
  targetName?: string;
  status: string;
  votesFor: number;
  votesAgainst: number;
  requiredVotes: number;
  message: string;
}

export interface WMDBatteryDeployedPayload {
  batteryId: string;
  batteryType: string;
  interceptChance: number;
  message: string;
}

export interface WMDSpyRecruitedPayload {
  spyId: string;
  spyName: string;
  specialization: string;
  message: string;
}

export interface WMDCounterIntelAlertPayload {
  spiesDetected: Array<{ codename: string; specialization: string }>;
  message: string;
}

// ============================================================================
// SERVER-TO-CLIENT EVENT MAP
// ============================================================================

export interface ServerToClientEvents {
  // Game Events
  'game:position_update': (payload: GamePositionUpdatePayload) => void;
  'game:resource_change': (payload: GameResourceChangePayload) => void;
  'game:level_up': (payload: GameLevelUpPayload) => void;
  'game:tile_update': (payload: GameTileUpdatePayload) => void;
  'game:player_online': (payload: GamePlayerOnlinePayload) => void;
  'game:player_offline': (payload: GamePlayerOfflinePayload) => void;

  // Clan Events
  'clan:member_joined': (payload: ClanMemberJoinedPayload) => void;
  'clan:member_left': (payload: ClanMemberLeftPayload) => void;
  'clan:member_role_changed': (payload: ClanMemberRoleChangedPayload) => void;
  'clan:territory_update': (payload: ClanTerritoryUpdatePayload) => void;
  'clan:war_declared': (payload: ClanWarDeclaredPayload) => void;
  'clan:war_ended': (payload: ClanWarEndedPayload) => void;
  'clan:treasury_update': (payload: ClanTreasuryUpdatePayload) => void;
  'clan:activity': (payload: ClanActivityPayload) => void;
  'clan:leaderboard_update': (payload: ClanLeaderboardUpdatePayload) => void;

  // Chat Events
  'chat:message': (payload: ChatMessagePayload) => void;
  'chat:typing': (payload: ChatTypingPayload) => void;
  'chat:member_online': (payload: ChatMemberOnlinePayload) => void;
  'chat:message_edited': (payload: ChatMessageEditedPayload) => void;
  'chat:message_deleted': (payload: ChatMessageDeletedPayload) => void;

  // Combat Events
  'combat:attack_started': (payload: CombatAttackStartedPayload) => void;
  'combat:battle_result': (payload: CombatBattleResultPayload) => void;
  'combat:unit_destroyed': (payload: CombatUnitDestroyedPayload) => void;
  'combat:defense_alert': (payload: CombatDefenseAlertPayload) => void;

  // System Events
  'system:notification': (payload: SystemNotificationPayload) => void;
  'system:achievement_unlocked': (payload: SystemAchievementUnlockedPayload) => void;
  'system:maintenance_alert': (payload: SystemMaintenanceAlertPayload) => void;
  'system:server_stats': (payload: SystemServerStatsPayload) => void;

  // WMD Events
  'wmd:missile_launched': (payload: WMDMissileLaunchedPayload) => void;
  'wmd:incoming_missile': (payload: WMDIncomingMissilePayload) => void;
  'wmd:missile_intercepted': (payload: WMDMissileInterceptedPayload) => void;
  'wmd:interception_success': (payload: WMDInterceptionSuccessPayload) => void;
  'wmd:missile_impact': (payload: WMDMissileImpactPayload) => void;
  'wmd:research_complete': (payload: WMDResearchCompletePayload) => void;
  'wmd:spy_mission_complete': (payload: WMDSpyMissionCompletePayload) => void;
  'wmd:vote_update': (payload: WMDVoteUpdatePayload) => void;
  'wmd:battery_deployed': (payload: WMDBatteryDeployedPayload) => void;
  'wmd:spy_recruited': (payload: WMDSpyRecruitedPayload) => void;
  'wmd:counter_intel_alert': (payload: WMDCounterIntelAlertPayload) => void;

  // Connection Events
  'connect': () => void;
  'disconnect': () => void;
  'error': (error: WebSocketError) => void;
}

// ============================================================================
// CLIENT-TO-SERVER EVENT MAP
// ============================================================================

export interface ClientToServerEvents {
  // Game Actions
  'game:update_position': (data: { x: number; y: number }) => void;
  'game:request_tile_info': (data: { x: number; y: number }) => void;

  // Clan Actions
  'clan:join_room': (data: { clanId: string }) => void;
  'clan:leave_room': (data: { clanId: string }) => void;
  'clan:declare_war': (data: {
    targetClanId: string;
    warType: 'territory' | 'resource' | 'honor';
    unitsCommitted: number;
  }) => void;

  // Chat Actions
  'chat:send_message': (data: {
    clanId: string;
    content: string;
    mentions?: string[];
  }, callback?: (response: { success: boolean; messageId?: string; error?: string }) => void) => void;
  'chat:start_typing': (data: { clanId: string }) => void;
  'chat:stop_typing': (data: { clanId: string }) => void;
  'chat:edit_message': (data: {
    messageId: string;
    clanId: string;
    newContent: string;
  }) => void;
  'chat:delete_message': (data: {
    messageId: string;
    clanId: string;
  }) => void;

  // Combat Actions
  'combat:request_battle_update': (data: { battleId: string }) => void;

  // System Actions
  'system:ping': (callback: (latency: number) => void) => void;
}

// ============================================================================
// ROOM NAMING CONVENTIONS
// ============================================================================

export const WebSocketRooms = {
  global: () => 'global',
  user: (userId: string) => `user:${userId}`,
  clan: (clanId: string) => `clan:${clanId}`,
  clanChat: (clanId: string) => `clan:${clanId}:chat`,
  battle: (battleId: string) => `battle:${battleId}`,
  location: (x: number, y: number) => `location:${x}:${y}`,
} as const;

// ============================================================================
// CONNECTION STATE
// ============================================================================

export type ConnectionState = 'connected' | 'connecting' | 'disconnected' | 'reconnecting' | 'error';

export interface WebSocketConnectionInfo {
  state: ConnectionState;
  connectedAt?: number;
  disconnectedAt?: number;
  reconnectAttempts: number;
  latency?: number;
  userId?: string;
  rooms: string[];
}

/**
 * IMPLEMENTATION NOTES:
 * 
 * 1. Event Naming Convention:
 *    - Format: `category:action` (e.g., 'clan:war_declared')
 *    - Categories: game, clan, chat, combat, system
 *    - Actions: past tense for notifications, present for requests
 * 
 * 2. Payload Design:
 *    - Always include timestamp for event ordering
 *    - Include user context (userId, username) for attribution
 *    - Use optional fields with `?` for conditional data
 *    - Provide metadata object for extensibility
 * 
 * 3. Type Safety:
 *    - All events strongly typed via ServerToClientEvents interface
 *    - Payloads validated on both client and server
 *    - Use discriminated unions for action types
 * 
 * 4. Room Management:
 *    - Use WebSocketRooms helper for consistent naming
 *    - Auto-join user-specific room on connection
 *    - Join/leave clan rooms on membership changes
 *    - Location-based rooms for proximity events
 * 
 * 5. Performance Considerations:
 *    - Keep payloads small (< 1KB typical)
 *    - Batch similar events when possible
 *    - Use throttling for high-frequency events (position updates)
 *    - Implement selective room subscriptions
 * 
 * 6. Security:
 *    - Validate user permissions before emitting to rooms
 *    - Never expose sensitive data in payloads
 *    - Rate-limit client-to-server events
 *    - Authenticate socket connections via JWT
 * 
 * FUTURE ENHANCEMENTS:
 * - Add event versioning for backward compatibility
 * - Implement event compression for large payloads
 * - Add replay/history functionality
 * - Support for custom user-defined events
 */

@@@END@@@
@@@FILE:types/wmd/defense.types.ts@@@
/**
 * @file types/wmd/defense.types.ts
 * @created 2025-10-22
 * @overview WMD Defense System Type Definitions
 * 
 * OVERVIEW:
 * Complete type system for missile defense networks including battery types,
 * interception mechanics, clan defense pooling, and radar surveillance.
 * 
 * Features:
 * - 5 defense battery tiers
 * - Interception probability calculations
 * - Clan-wide defense grid pooling
 * - Radar surveillance system
 * - Defense resource management
 * 
 * Dependencies:
 * - missile.types.ts for warhead type references
 * - MongoDB for data persistence
 */

import { ObjectId } from 'mongodb';
import { WarheadType } from './missile.types';

// ============================================================================
// ENUMS
// ============================================================================

/**
 * Defense battery types
 */
export enum BatteryType {
  BASIC = 'BASIC',                 // Tier 1, 10% intercept chance
  ADVANCED = 'ADVANCED',           // Tier 3, 25% intercept chance
  ELITE = 'ELITE',                 // Tier 5, 40% intercept chance
  FORTRESS = 'FORTRESS',           // Tier 7, 60% intercept chance
  AEGIS = 'AEGIS',                 // Tier 10, 80% intercept chance
}

/**
 * Battery operational status
 */
export enum BatteryStatus {
  IDLE = 'IDLE',                   // Ready to intercept
  ACTIVE = 'ACTIVE',               // Currently tracking threat
  COOLDOWN = 'COOLDOWN',           // Recharging after intercept attempt
  DAMAGED = 'DAMAGED',             // Sabotaged or destroyed
  UPGRADING = 'UPGRADING',         // Being upgraded to next tier
}

/**
 * Interception attempt results
 */
export enum InterceptionResult {
  SUCCESS = 'SUCCESS',             // Missile destroyed
  FAILURE = 'FAILURE',             // Missile continues
  PARTIAL = 'PARTIAL',             // Damage reduced (AEGIS only)
  MALFUNCTION = 'MALFUNCTION',     // Battery failure
}

/**
 * Radar coverage levels
 */
export enum RadarLevel {
  NONE = 'NONE',                   // No early warning
  LOCAL = 'LOCAL',                 // Detects incoming to you (30s warning)
  REGIONAL = 'REGIONAL',           // Detects nearby launches (60s warning)
  GLOBAL = 'GLOBAL',               // Detects all launches (90s warning)
}

// ============================================================================
// INTERFACES
// ============================================================================

/**
 * Main defense battery document
 */
export interface DefenseBattery {
  _id?: ObjectId;
  ownerId: string;                 // Player username
  ownerClanId: string;             // Owner's clan ID
  batteryType: BatteryType;
  tier: number;                    // 1-10
  status: BatteryStatus;
  
  // Interception stats
  interceptChance: number;         // Base probability (0-1)
  successfulIntercepts: number;
  failedIntercepts: number;
  totalAttempts: number;
  
  // Cooldown tracking
  lastFired?: Date;
  cooldownUntil?: Date;
  cooldownDuration: number;        // Milliseconds
  
  // Damage tracking
  health: number;                  // 0-100%
  repairing: boolean;
  repairCompletesAt?: Date;
  
  // Upgrade tracking
  upgrading: boolean;
  upgradeCompletesAt?: Date;
  upgradeToTier?: number;
  
  // Timestamps
  createdAt: Date;
  updatedAt: Date;
}

/**
 * Clan defense grid (pooled batteries)
 */
export interface ClanDefenseGrid {
  clanId: string;
  clanName: string;
  
  // Pooled batteries from all members
  batteries: Array<{
    batteryId: string;
    ownerId: string;
    ownerUsername: string;
    batteryType: BatteryType;
    interceptChance: number;
    status: BatteryStatus;
    available: boolean;            // Can participate in intercepts
  }>;
  
  // Grid stats
  totalBatteries: number;
  availableBatteries: number;
  combinedInterceptChance: number; // Pooled probability
  
  // Recent activity
  recentIntercepts: InterceptionAttempt[];
  
  updatedAt: Date;
}

/**
 * Interception attempt record
 */
export interface InterceptionAttempt {
  _id?: ObjectId;
  missileId: string;
  targetId: string;                // Player/clan being defended
  defenderIds: string[];           // Players who contributed batteries
  
  // Battery usage
  batteriesUsed: Array<{
    batteryId: string;
    ownerId: string;
    batteryType: BatteryType;
    interceptChance: number;
  }>;
  
  // Calculation
  combinedChance: number;          // Total intercept probability
  roll: number;                    // Random roll (0-1)
  result: InterceptionResult;
  
  // Outcome
  missileDestroyed: boolean;
  damageReduced?: number;          // Percentage (PARTIAL only)
  batteryFailures: number;         // How many malfunctioned
  
  // Timestamps
  attemptedAt: Date;
}

/**
 * Interception request
 */
export interface InterceptionRequest {
  missileId: string;
  targetId: string;
  defenderIds: string[];           // Players pooling defense
  warheadType: WarheadType;
  launchedAt: Date;
}

/**
 * Interception calculation result
 */
export interface InterceptionCalculation {
  success: boolean;
  missileDestroyed: boolean;
  result: InterceptionResult;
  
  // Probability breakdown
  baseChance: number;
  bonusChance: number;
  finalChance: number;
  roll: number;
  
  // Battery details
  batteriesUsed: number;
  batteryTypes: BatteryType[];
  
  // Damage mitigation
  damageReduced?: number;
  
  message: string;
}

/**
 * Radar installation
 */
export interface RadarInstallation {
  _id?: ObjectId;
  ownerId: string;
  ownerClanId: string;
  level: RadarLevel;
  tier: number;                    // 1-10
  
  // Coverage area
  range: number;                   // Tiles radius
  coverageRadius: number;          // Calculated coverage
  
  // Detection capabilities
  warningTime: number;             // Milliseconds advance warning
  canDetectStealth: boolean;       // Can see stealth missiles
  accuracy: number;                // Detection accuracy (0-1)
  
  // Recent detections
  detectionsToday: number;
  lastDetection?: Date;
  
  createdAt: Date;
  updatedAt: Date;
}

/**
 * Missile detection alert
 */
export interface MissileDetection {
  _id?: ObjectId;
  radarId: string;
  detectorId: string;              // Player who owns radar
  missileId: string;
  launcherId: string;              // Who launched
  
  // Detection details
  detectedAt: Date;
  estimatedImpact: Date;
  warningTime: number;             // Milliseconds until impact
  
  // Target information
  targetId: string;
  targetUsername: string;
  targetLocation?: {
    x: number;
    y: number;
  };
  
  // Intelligence
  warheadType?: WarheadType;       // May be unknown
  confidence: number;              // Detection accuracy (0-1)
  
  // Notification
  alertSent: boolean;
  alertSentAt?: Date;
}

/**
 * Defense battery configuration
 */
export interface BatteryConfig {
  type: BatteryType;
  tier: number;
  name: string;
  description: string;
  interceptChance: number;         // Base probability (0-1)
  cooldownDuration: number;        // Milliseconds
  cost: {
    metal: number;
    energy: number;
  };
  maintenanceCost: {
    metal: number;
    energy: number;
  };
  requiredTech: string;            // Tech tree prerequisite
}

/**
 * Radar configuration
 */
export interface RadarConfig {
  level: RadarLevel;
  tier: number;
  name: string;
  description: string;
  range: number;                   // Tiles
  warningTime: number;             // Milliseconds
  canDetectStealth: boolean;
  accuracy: number;                // 0-1
  cost: {
    metal: number;
    energy: number;
  };
  requiredTech: string;
}

/**
 * Battery inventory summary
 */
export interface BatteryInventory {
  ownerId: string;
  batteries: Array<{
    batteryId: string;
    batteryType: BatteryType;
    tier: number;
    status: BatteryStatus;
    interceptChance: number;
    available: boolean;
  }>;
  totalBatteries: number;
  availableBatteries: number;
  combinedInterceptChance: number;
  onCooldown: number;
  damaged: number;
}

/**
 * Clan defense summary
 */
export interface ClanDefenseSummary {
  clanId: string;
  clanName: string;
  memberCount: number;
  
  // Defense capabilities
  totalBatteries: number;
  availableBatteries: number;
  gridInterceptChance: number;
  
  // Radar coverage
  radarInstallations: number;
  bestRadarLevel: RadarLevel;
  globalCoverage: boolean;
  
  // Performance
  successfulIntercepts: number;
  failedIntercepts: number;
  successRate: number;             // Percentage
  
  // Recent activity
  lastInterception?: Date;
  interceptionsToday: number;
}

/**
 * Defense upgrade request
 */
export interface DefenseUpgradeRequest {
  batteryId: string;
  ownerId: string;
  currentTier: number;
  targetTier: number;
}

/**
 * Defense upgrade result
 */
export interface DefenseUpgradeResult {
  success: boolean;
  batteryId: string;
  upgradedTo: BatteryType;
  newTier: number;
  costPaid: {
    metal: number;
    energy: number;
  };
  completesAt: Date;
  message: string;
}

/**
 * Battery repair request
 */
export interface RepairRequest {
  batteryId: string;
  ownerId: string;
  currentHealth: number;
}

/**
 * Battery repair result
 */
export interface RepairResult {
  success: boolean;
  batteryId: string;
  repairedFrom: number;
  repairedTo: number;
  costPaid: {
    metal: number;
    energy: number;
  };
  completesAt: Date;
  message: string;
}

// ============================================================================
// CONSTANTS
// ============================================================================

/**
 * Battery configurations by type
 */
export const BATTERY_CONFIGS: Record<BatteryType, BatteryConfig> = {
  [BatteryType.BASIC]: {
    type: BatteryType.BASIC,
    tier: 1,
    name: 'Basic Defense Battery',
    description: 'Entry-level missile defense',
    interceptChance: 0.10,
    cooldownDuration: 3600000,       // 1 hour
    cost: {
      metal: 250000,
      energy: 500000,
    },
    maintenanceCost: {
      metal: 10000,
      energy: 20000,
    },
    requiredTech: 'defense_tier_1',
  },
  [BatteryType.ADVANCED]: {
    type: BatteryType.ADVANCED,
    tier: 3,
    name: 'Advanced Defense Battery',
    description: 'Improved interception capability',
    interceptChance: 0.25,
    cooldownDuration: 2700000,       // 45 minutes
    cost: {
      metal: 500000,
      energy: 1000000,
    },
    maintenanceCost: {
      metal: 25000,
      energy: 50000,
    },
    requiredTech: 'defense_tier_3',
  },
  [BatteryType.ELITE]: {
    type: BatteryType.ELITE,
    tier: 5,
    name: 'Elite Defense Battery',
    description: 'High-accuracy interception system',
    interceptChance: 0.40,
    cooldownDuration: 1800000,       // 30 minutes
    cost: {
      metal: 1000000,
      energy: 2000000,
    },
    maintenanceCost: {
      metal: 50000,
      energy: 100000,
    },
    requiredTech: 'defense_tier_5',
  },
  [BatteryType.FORTRESS]: {
    type: BatteryType.FORTRESS,
    tier: 7,
    name: 'Fortress Defense Battery',
    description: 'Near-total protection',
    interceptChance: 0.60,
    cooldownDuration: 900000,        // 15 minutes
    cost: {
      metal: 2000000,
      energy: 4000000,
    },
    maintenanceCost: {
      metal: 100000,
      energy: 200000,
    },
    requiredTech: 'defense_tier_7',
  },
  [BatteryType.AEGIS]: {
    type: BatteryType.AEGIS,
    tier: 10,
    name: 'AEGIS Defense System',
    description: 'Ultimate defensive capability',
    interceptChance: 0.80,
    cooldownDuration: 600000,        // 10 minutes
    cost: {
      metal: 5000000,
      energy: 10000000,
    },
    maintenanceCost: {
      metal: 250000,
      energy: 500000,
    },
    requiredTech: 'defense_tier_10',
  },
};

/**
 * Radar configurations by level
 */
export const RADAR_CONFIGS: Record<RadarLevel, RadarConfig> = {
  [RadarLevel.NONE]: {
    level: RadarLevel.NONE,
    tier: 0,
    name: 'No Radar',
    description: 'No early warning system',
    range: 0,
    warningTime: 0,
    canDetectStealth: false,
    accuracy: 0,
    cost: {
      metal: 0,
      energy: 0,
    },
    requiredTech: '',
  },
  [RadarLevel.LOCAL]: {
    level: RadarLevel.LOCAL,
    tier: 2,
    name: 'Local Radar',
    description: 'Detects incoming missiles targeting you',
    range: 50,
    warningTime: 30000,              // 30 seconds
    canDetectStealth: false,
    accuracy: 0.7,
    cost: {
      metal: 100000,
      energy: 200000,
    },
    requiredTech: 'radar_tier_2',
  },
  [RadarLevel.REGIONAL]: {
    level: RadarLevel.REGIONAL,
    tier: 5,
    name: 'Regional Radar',
    description: 'Detects nearby missile launches',
    range: 200,
    warningTime: 60000,              // 60 seconds
    canDetectStealth: false,
    accuracy: 0.85,
    cost: {
      metal: 500000,
      energy: 1000000,
    },
    requiredTech: 'radar_tier_5',
  },
  [RadarLevel.GLOBAL]: {
    level: RadarLevel.GLOBAL,
    tier: 8,
    name: 'Global Radar Network',
    description: 'Detects all missile launches worldwide',
    range: 9999,
    warningTime: 90000,              // 90 seconds
    canDetectStealth: true,
    accuracy: 0.95,
    cost: {
      metal: 2000000,
      energy: 5000000,
    },
    requiredTech: 'radar_tier_8',
  },
};

/**
 * Defense pooling mechanics
 */
export const DEFENSE_POOLING = {
  maxBatteriesPerIntercept: 10,    // Max batteries in one intercept
  pooledBonusPerBattery: 0.05,     // +5% per additional battery
  maxPooledBonus: 0.5,             // Cap at +50%
  clanGridEnabled: true,           // Allow clan defense pooling
  autoDefendClanmates: true,       // Automatic defense for clan
} as const;

/**
 * Interception rules
 */
export const INTERCEPTION_RULES = {
  warheadDifficultyModifier: {     // Harder to intercept higher tiers
    TACTICAL: 1.0,                 // No modifier
    STRATEGIC: 0.9,                // -10% intercept chance
    NEUTRON: 0.85,                 // -15%
    CLUSTER: 0.8,                  // -20%
    CLAN_BUSTER: 0.7,              // -30%
  },
  partialSuccessThreshold: 0.5,    // Within 50% of target = partial
  malfunctionChance: 0.05,         // 5% chance battery malfunctions
  damageReductionPartial: 0.5,     // 50% damage reduction on partial
} as const;

// ============================================================================
// TYPE GUARDS
// ============================================================================

/**
 * Check if battery type is valid
 */
export function isValidBatteryType(type: string): type is BatteryType {
  return Object.values(BatteryType).includes(type as BatteryType);
}

/**
 * Check if battery status is valid
 */
export function isValidBatteryStatus(status: string): status is BatteryStatus {
  return Object.values(BatteryStatus).includes(status as BatteryStatus);
}

/**
 * Check if radar level is valid
 */
export function isValidRadarLevel(level: string): level is RadarLevel {
  return Object.values(RadarLevel).includes(level as RadarLevel);
}

/**
 * Check if battery is available for interception
 */
export function isBatteryAvailable(battery: DefenseBattery): boolean {
  return (
    battery.status === BatteryStatus.IDLE &&
    battery.health > 50 &&
    (!battery.cooldownUntil || battery.cooldownUntil < new Date())
  );
}

/**
 * Calculate combined intercept chance
 */
export function calculateCombinedChance(
  batteries: Array<{ interceptChance: number }>,
  warheadType: WarheadType
): number {
  if (batteries.length === 0) return 0;
  
  // Get warhead difficulty modifier
  const difficulty = INTERCEPTION_RULES.warheadDifficultyModifier[warheadType];
  
  // Start with first battery's chance
  let combined = batteries[0].interceptChance * difficulty;
  
  // Add bonus for additional batteries (diminishing returns)
  const bonusBatteries = batteries.length - 1;
  const bonus = Math.min(
    bonusBatteries * DEFENSE_POOLING.pooledBonusPerBattery,
    DEFENSE_POOLING.maxPooledBonus
  );
  
  combined += bonus;
  
  // Cap at 95% max intercept chance
  return Math.min(combined, 0.95);
}

// ============================================================================
// IMPLEMENTATION NOTES
// ============================================================================
/**
 * 1. Battery Types:
 *    - BASIC: 10% intercept, 1h cooldown, Tier 1
 *    - ADVANCED: 25% intercept, 45min cooldown, Tier 3
 *    - ELITE: 40% intercept, 30min cooldown, Tier 5
 *    - FORTRESS: 60% intercept, 15min cooldown, Tier 7
 *    - AEGIS: 80% intercept, 10min cooldown, Tier 10
 * 
 * 2. Clan Defense Grid:
 *    - Pools all available batteries from clan members
 *    - +5% intercept chance per additional battery
 *    - Max +50% bonus (10 batteries total)
 *    - Automatic defense for clan members
 * 
 * 3. Radar System:
 *    - LOCAL: 30s warning, 50 tile range
 *    - REGIONAL: 60s warning, 200 tile range
 *    - GLOBAL: 90s warning, unlimited range, detects stealth
 * 
 * 4. Interception Mechanics:
 *    - Roll vs combined intercept chance
 *    - Warhead difficulty reduces chance (Clan Buster -30%)
 *    - Partial success reduces damage by 50%
 *    - 5% chance battery malfunctions
 * 
 * 5. Cost Balance:
 *    - BASIC Battery: 250k Metal + 500k Energy
 *    - AEGIS Battery: 5M Metal + 10M Energy
 *    - Global Radar: 2M Metal + 5M Energy
 *    - Maintenance costs scale with tier
 * 
 * 6. Strategic Considerations:
 *    - Defense is cheaper than offense (battery < missile)
 *    - Clan coordination multiplies effectiveness
 *    - Radar provides advance warning for defense preparation
 *    - Higher tier warheads harder to intercept
 */

// ============================================================================
// END OF FILE
// ============================================================================

@@@END@@@
@@@FILE:types/wmd/index.ts@@@
/**
 * @file types/wmd/index.ts
 * @created 2025-10-22
 * @overview WMD System Types Export Index
 * 
 * OVERVIEW:
 * Central export point for all WMD-related type definitions including missiles,
 * defense systems, intelligence operations, research progression, and notifications.
 * 
 * Usage:
 * ```typescript
 * import { Missile, WarheadType, DefenseBattery, SpyMission } from '@/types/wmd';
 * ```
 */

// ============================================================================
// MISSILE SYSTEM TYPES
// ============================================================================

export {
  // Enums
  WarheadType,
  MissileStatus,
  MissileComponent,
  
  // Interfaces
  type Missile,
  type ComponentProgress,
  type ComponentStatus,
  type DamageDistribution,
  type LaunchRequest,
  type LaunchResult,
  type MissileInventory,
  type TargetValidation,
  type WarheadConfig,
  type ComponentCost,
  type AssemblyRequest,
  type AssemblyResult,
  type ComponentAcquisitionRequest,
  type ComponentAcquisitionResult,
  
  // Constants
  WARHEAD_CONFIGS,
  COMPONENT_COSTS,
  TARGETING_RULES,
  
  // Type Guards
  isValidWarheadType,
  isValidMissileStatus,
  isValidComponent,
  isMissileReady,
  calculateProgress,
} from './missile.types';

// ============================================================================
// DEFENSE SYSTEM TYPES
// ============================================================================

export {
  // Enums
  BatteryType,
  BatteryStatus,
  InterceptionResult,
  RadarLevel,
  
  // Interfaces
  type DefenseBattery,
  type ClanDefenseGrid,
  type InterceptionAttempt,
  type InterceptionRequest,
  type InterceptionCalculation,
  type RadarInstallation,
  type MissileDetection,
  type BatteryConfig,
  type RadarConfig,
  type BatteryInventory,
  type ClanDefenseSummary,
  type DefenseUpgradeRequest,
  type DefenseUpgradeResult,
  type RepairRequest,
  type RepairResult,
  
  // Constants
  BATTERY_CONFIGS,
  RADAR_CONFIGS,
  DEFENSE_POOLING,
  INTERCEPTION_RULES,
  
  // Type Guards
  isValidBatteryType,
  isValidBatteryStatus,
  isValidRadarLevel,
  isBatteryAvailable,
  calculateCombinedChance,
} from './defense.types';

// ============================================================================
// INTELLIGENCE SYSTEM TYPES
// ============================================================================

export {
  // Enums
  MissionType,
  MissionStatus,
  SpyRank,
  IntelLevel,
  
  // Interfaces
  type SpyMission,
  type MissionResult,
  type IntelligenceReport,
  type SabotageDamage,
  type IntelligenceLeak,
  type SpyAgent,
  type CounterIntelligence,
  type MissionConfig,
  type SpyNetworkSummary,
  type MissionPlanRequest,
  type MissionPlanResult,
  type MissionExecuteRequest,
  type MissionExecuteResult,
  
  // Constants
  MISSION_CONFIGS,
  SPY_RANK_THRESHOLDS,
  INTEL_LEAK_PROBABILITY,
  SABOTAGE_IMPACT,
  
  // Type Guards
  isValidMissionType,
  isValidSpyRank,
  calculateSuccessChance,
} from './intelligence.types';

// ============================================================================
// RESEARCH SYSTEM TYPES
// ============================================================================

export {
  // Enums
  ResearchCategory,
  ResearchStatus,
  
  // Interfaces
  type ResearchTech,
  type PlayerResearch,
  type ResearchUnlockRequest,
  type ResearchUnlockResult,
  type TechTreeSummary,
  type ResearchValidation,
  
  // Constants
  MISSILE_RESEARCH_TRACK,
  DEFENSE_RESEARCH_TRACK,
  INTELLIGENCE_RESEARCH_TRACK,
  ALL_RESEARCH_TECHS,
  RESEARCH_BY_CATEGORY,
  TOTAL_RP_REQUIRED,
  RP_BY_CATEGORY,
  
  // Type Guards
  isValidTechId,
  getTechById,
  getTechsByCategory,
  getPrerequisiteChain,
  hasPrerequisites,
  getAvailableTechs,
} from './research.types';

// ============================================================================
// NOTIFICATION SYSTEM TYPES
// ============================================================================

export {
  // Enums
  WMDEventType,
  NotificationPriority,
  NotificationScope,
  
  // Interfaces
  type WMDNotification,
  type NotificationPreferences,
  type NotificationRequest,
  type NotificationBroadcastResult,
  type WMDWebSocketEvent,
  type MissileLaunchBroadcast,
  type IntelligenceLeakBroadcast,
  type NotificationHistory,
  
  // Constants
  DEFAULT_NOTIFICATION_PREFERENCES,
  NOTIFICATION_TEMPLATES,
  NOTIFICATION_EXPIRATION,
  
  // Type Guards
  isValidEventType,
  isValidPriority,
  getNotificationTemplate,
  generateNotificationMessage,
  calculateExpiration,
  shouldReceiveNotification,
} from './notification.types';

// ============================================================================
// AGGREGATE TYPES
// ============================================================================

import type { Missile, MissileInventory } from './missile.types';
import type { DefenseBattery, BatteryInventory, RadarInstallation } from './defense.types';
import type { SpyMission, SpyNetworkSummary, CounterIntelligence } from './intelligence.types';
import type { PlayerResearch, TechTreeSummary } from './research.types';
import type { WMDNotification, NotificationPreferences } from './notification.types';

/**
 * Complete WMD system state
 */
export interface WMDSystemState {
  // Missile state
  missiles: Missile[];
  missileInventory: MissileInventory;
  
  // Defense state
  batteries: DefenseBattery[];
  batteryInventory: BatteryInventory;
  radarInstallations: RadarInstallation[];
  
  // Intelligence state
  spyMissions: SpyMission[];
  spyNetwork: SpyNetworkSummary;
  counterIntel: CounterIntelligence;
  
  // Research state
  research: PlayerResearch;
  techTree: TechTreeSummary;
  
  // Notification state
  notifications: WMDNotification[];
  notificationPrefs: NotificationPreferences;
  unreadCount: number;
}

/**
 * WMD action payload for state updates
 */
export interface WMDAction {
  type: 'missile' | 'defense' | 'intelligence' | 'research' | 'notification';
  action: string;
  payload: any;
  timestamp: Date;
}

/**
 * WMD statistics for analytics
 */
export interface WMDStatistics {
  // Missile stats
  totalMissilesBuilt: number;
  totalMissilesLaunched: number;
  totalMissilesIntercepted: number;
  totalMissilesImpacted: number;
  
  // Defense stats
  totalBatteriesDeployed: number;
  totalInterceptions: number;
  interceptionSuccessRate: number;
  
  // Intelligence stats
  totalMissionsCompleted: number;
  totalSabotages: number;
  totalLeaks: number;
  
  // Research stats
  totalRPSpent: number;
  totalTechsUnlocked: number;
  highestTier: number;
  
  // Economic impact
  totalResourcesSpent: {
    metal: number;
    energy: number;
  };
  totalResourcesDestroyed: {
    metal: number;
    energy: number;
  };
}

// ============================================================================
// IMPLEMENTATION NOTES
// ============================================================================
/**
 * 1. Import Strategy:
 *    - Named exports for all types, enums, and functions
 *    - Central import point: `import { X } from '@/types/wmd'`
 *    - Tree-shakable: only import what you use
 * 
 * 2. Type Organization:
 *    - missile.types.ts: Offensive systems (warheads, components, targeting)
 *    - defense.types.ts: Defensive systems (batteries, radar, interception)
 *    - intelligence.types.ts: Spy operations (missions, sabotage, leaks)
 *    - research.types.ts: Tech tree (3 tracks, prerequisites, unlocks)
 *    - notification.types.ts: Event system (broadcasts, preferences)
 * 
 * 3. Usage Examples:
 *    ```typescript
 *    // Import specific types
 *    import { Missile, WarheadType, LaunchRequest } from '@/types/wmd';
 *    
 *    // Import all from category
 *    import * as WMDTypes from '@/types/wmd';
 *    
 *    // Import constants
 *    import { WARHEAD_CONFIGS, BATTERY_CONFIGS } from '@/types/wmd';
 *    
 *    // Import type guards
 *    import { isValidWarheadType, isMissileReady } from '@/types/wmd';
 *    ```
 * 
 * 4. Aggregate Types:
 *    - WMDSystemState: Complete system state for Redux/Context
 *    - WMDAction: Action payload for state updates
 *    - WMDStatistics: Analytics and metrics
 * 
 * 5. Type Safety:
 *    - All enums are strongly typed
 *    - Type guards for runtime validation
 *    - Strict null checks enabled
 *    - No 'any' types except in flexible event data
 * 
 * 6. Documentation:
 *    - All types have JSDoc comments
 *    - Usage examples in type definitions
 *    - Implementation notes in each file
 *    - Cross-references between related types
 */

// ============================================================================
// END OF FILE
// ============================================================================

@@@END@@@
@@@FILE:types/wmd/intelligence.types.ts@@@
/**
 * @file types/wmd/intelligence.types.ts
 * @created 2025-10-22
 * @overview WMD Intelligence Operations Type Definitions
 * 
 * OVERVIEW:
 * Complete type system for spy operations including mission types, sabotage
 * mechanics, intelligence gathering, and counter-intelligence measures.
 * 
 * Features:
 * - 10 mission types (reconnaissance to assassination)
 * - Sabotage engine with component destruction
 * - Intelligence leak probability system
 * - Counter-intelligence operations
 * - Spy network management
 * 
 * Dependencies:
 * - missile.types.ts for target references
 * - MongoDB for data persistence
 */

import { ObjectId } from 'mongodb';
import { MissileComponent, WarheadType } from './missile.types';

// ============================================================================
// ENUMS
// ============================================================================

/**
 * Spy mission types
 */
export enum MissionType {
  RECONNAISSANCE = 'RECONNAISSANCE',           // Gather basic target info
  SURVEILLANCE = 'SURVEILLANCE',               // Monitor target activity
  INFILTRATION = 'INFILTRATION',               // Gain access to target systems
  SABOTAGE_LIGHT = 'SABOTAGE_LIGHT',           // Delay 1 component
  SABOTAGE_HEAVY = 'SABOTAGE_HEAVY',           // Destroy 1 component
  SABOTAGE_NUCLEAR = 'SABOTAGE_NUCLEAR',       // Destroy all components
  INTELLIGENCE_LEAK = 'INTELLIGENCE_LEAK',     // Reveal missile details to public
  COUNTER_INTELLIGENCE = 'COUNTER_INTELLIGENCE', // Protect against spies
  ASSASSINATION = 'ASSASSINATION',             // Kill enemy spy
  THEFT = 'THEFT',                             // Steal research data
}

/**
 * Mission status lifecycle
 */
export enum MissionStatus {
  PLANNING = 'PLANNING',           // Being prepared
  ACTIVE = 'ACTIVE',               // In progress
  COMPLETED = 'COMPLETED',         // Successfully finished
  FAILED = 'FAILED',               // Mission failed
  COMPROMISED = 'COMPROMISED',     // Discovered and stopped
  CANCELLED = 'CANCELLED',         // Manually aborted
}

/**
 * Spy agent ranks
 */
export enum SpyRank {
  ROOKIE = 'ROOKIE',               // 30% success rate
  OPERATIVE = 'OPERATIVE',         // 50% success rate
  AGENT = 'AGENT',                 // 70% success rate
  VETERAN = 'VETERAN',             // 85% success rate
  ELITE = 'ELITE',                 // 95% success rate
}

/**
 * Intelligence classification levels
 */
export enum IntelLevel {
  UNCLASSIFIED = 'UNCLASSIFIED',   // Public information
  CONFIDENTIAL = 'CONFIDENTIAL',   // Restricted access
  SECRET = 'SECRET',               // Highly restricted
  TOP_SECRET = 'TOP_SECRET',       // Maximum security
}

// ============================================================================
// INTERFACES
// ============================================================================

/**
 * Main spy mission document
 */
export interface SpyMission {
  _id?: ObjectId;
  missionId: string;               // Unique identifier
  ownerId: string;                 // Player who ordered mission
  ownerClanId: string;             // Owner's clan ID
  
  // Mission details
  missionType: MissionType;
  status: MissionStatus;
  priority: 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL';
  
  // Target information
  targetId: string;                // Player or clan being spied on
  targetType: 'player' | 'clan';
  targetName: string;
  
  // Spy agent
  spyId: string;
  spyName: string;
  spyRank: SpyRank;
  
  // Mission execution
  startTime: Date;
  estimatedCompletion: Date;
  actualCompletion?: Date;
  duration: number;                // Milliseconds
  
  // Success calculation
  baseSuccessChance: number;       // From spy rank
  modifiers: {
    targetSecurity: number;        // Target's counter-intel strength
    clanBonus: number;             // Clan intel support
    equipmentBonus: number;        // Spy equipment quality
  };
  finalSuccessChance: number;
  roll?: number;                   // Random roll (0-1)
  successful?: boolean;
  
  // Mission outcome
  result?: MissionResult;
  intelligenceGathered?: IntelligenceReport;
  sabotageDamage?: SabotageDamage;
  
  // Detection risk
  detectionRisk: number;           // Probability (0-1)
  detected: boolean;
  detectedBy?: string;
  detectedAt?: Date;
  
  // Cost
  cost: {
    metal: number;
    energy: number;
  };
  
  // Timestamps
  createdAt: Date;
  updatedAt: Date;
}

/**
 * Mission result summary
 */
export interface MissionResult {
  success: boolean;
  missionType: MissionType;
  outcome: string;                 // Human-readable description
  
  // Specific results based on mission type
  reconnaissance?: {
    targetLevel: number;
    targetPower: number;
    missileCount: number;
    defenseStrength: number;
  };
  
  surveillance?: {
    recentActivity: string[];
    missileProgress: number;       // Percentage
    vulnerabilities: string[];
  };
  
  sabotage?: {
    componentsDestroyed: MissileComponent[];
    missileDelayed: boolean;
    delayDuration?: number;        // Milliseconds
  };
  
  intelligenceLeak?: {
    missileId: string;
    warheadType: WarheadType;
    publicNotificationId: string;
    leakedData: string[];
  };
  
  counterIntel?: {
    enemySpiesDetected: number;
    enemyMissionsThwarted: number;
    securityStrength: number;
  };
  
  theft?: {
    researchStolen: number;        // RP stolen
    techsRevealed: string[];
  };
  
  assassination?: {
    spyKilled: string;
    spyRank: SpyRank;
    retaliation: boolean;
  };
}

/**
 * Intelligence report from reconnaissance
 */
export interface IntelligenceReport {
  _id?: ObjectId;
  reportId: string;
  classification: IntelLevel;
  
  // Source
  gatheredBy: string;              // Spy who gathered intel
  gatheredFrom: string;            // Target
  gatheredAt: Date;
  missionId: string;
  
  // Target intelligence
  target: {
    id: string;
    username: string;
    level: number;
    power: number;
    clanId?: string;
    clanName?: string;
  };
  
  // WMD intelligence
  wmdCapabilities: {
    missiles: Array<{
      missileId: string;
      warheadType: WarheadType;
      progress: number;            // Percentage
      estimatedCompletion?: Date;
    }>;
    defenseBatteries: number;
    radarLevel: string;
    combinedDefenseStrength: number;
  };
  
  // Strategic intelligence
  vulnerabilities: string[];
  threats: string[];
  recommendations: string[];
  
  // Expiration
  expiresAt: Date;                 // Intel goes stale
  
  createdAt: Date;
}

/**
 * Sabotage damage record
 */
export interface SabotageDamage {
  _id?: ObjectId;
  sabotageId: string;
  missionId: string;
  saboteurId: string;              // Spy who executed
  saboteurName: string;
  
  // Target
  targetId: string;
  targetUsername: string;
  missileId: string;
  
  // Damage dealt
  componentsDestroyed: MissileComponent[];
  componentsDelayed: MissileComponent[];
  delayDuration: number;           // Milliseconds
  
  // Impact
  progressLost: number;            // Percentage
  resourcesWasted: {
    metal: number;
    energy: number;
  };
  
  // Detection
  detected: boolean;
  detectedAt?: Date;
  detectedBy?: string;
  
  executedAt: Date;
}

/**
 * Intelligence leak notification
 */
export interface IntelligenceLeak {
  _id?: ObjectId;
  leakId: string;
  leakedBy: string;                // Spy who leaked
  leakedFrom: string;              // Target whose intel leaked
  
  // Leaked information
  missileId: string;
  warheadType: WarheadType;
  progress: number;
  estimatedCompletion?: Date;
  targetId?: string;               // Missile's intended target
  
  // Public exposure
  globalNotificationSent: boolean;
  notificationId?: string;
  
  // Consequences
  publicPressure: number;          // 0-100 (higher = more pressure)
  diplomaticIncident: boolean;
  
  leakedAt: Date;
}

/**
 * Spy agent profile
 */
export interface SpyAgent {
  _id?: ObjectId;
  spyId: string;
  spyName: string;                 // Code name
  ownerId: string;                 // Player who owns spy
  ownerClanId: string;
  
  // Rank and experience
  rank: SpyRank;
  experience: number;              // XP for promotions
  nextRankAt: number;              // XP needed for next rank
  
  // Success stats
  missionsCompleted: number;
  missionsSuccessful: number;
  missionsFailed: number;
  successRate: number;             // Percentage
  
  // Specialization
  specialty?: MissionType;         // +20% success for this mission type
  
  // Status
  available: boolean;
  currentMission?: string;         // Mission ID if on assignment
  cooldownUntil?: Date;
  
  // Equipment
  equipment: {
    disguise: number;              // 0-10 (reduces detection)
    tools: number;                 // 0-10 (increases success)
    communication: number;         // 0-10 (faster missions)
  };
  
  createdAt: Date;
  updatedAt: Date;
}

/**
 * Counter-intelligence installation
 */
export interface CounterIntelligence {
  _id?: ObjectId;
  ownerId: string;
  ownerClanId: string;
  
  // Security level
  securityRating: number;          // 0-100
  tier: number;                    // 1-10
  
  // Detection capabilities
  detectionChance: number;         // Probability (0-1)
  surveillanceRange: number;       // Tiles
  
  // Active measures
  activeScans: number;             // Counter-intel operations running
  enemySpiesDetected: number;
  enemyMissionsPrevented: number;
  
  // Recent activity
  lastDetection?: Date;
  detectionsToday: number;
  
  createdAt: Date;
  updatedAt: Date;
}

/**
 * Mission configuration
 */
export interface MissionConfig {
  type: MissionType;
  name: string;
  description: string;
  tier: number;                    // Minimum tier required
  
  // Success rates by rank
  successRates: Record<SpyRank, number>;
  
  // Execution
  duration: number;                // Milliseconds
  detectionRisk: number;           // Base probability (0-1)
  
  // Cost
  cost: {
    metal: number;
    energy: number;
  };
  
  // Requirements
  requiredTech: string;
  minimumSpyRank: SpyRank;
}

/**
 * Spy network summary
 */
export interface SpyNetworkSummary {
  ownerId: string;
  
  // Agents
  totalSpies: number;
  availableSpies: number;
  onMission: number;
  spyRanks: Record<SpyRank, number>;
  
  // Mission stats
  activeMissions: number;
  completedMissions: number;
  successRate: number;
  
  // Counter-intelligence
  securityRating: number;
  enemySpiesDetected: number;
  
  updatedAt: Date;
}

/**
 * Mission planning request
 */
export interface MissionPlanRequest {
  ownerId: string;
  missionType: MissionType;
  targetId: string;
  spyId: string;
}

/**
 * Mission planning result
 */
export interface MissionPlanResult {
  success: boolean;
  missionId: string;
  missionType: MissionType;
  estimatedDuration: number;
  successChance: number;
  detectionRisk: number;
  cost: {
    metal: number;
    energy: number;
  };
  message: string;
}

/**
 * Mission execution request
 */
export interface MissionExecuteRequest {
  missionId: string;
  ownerId: string;
}

/**
 * Mission execution result
 */
export interface MissionExecuteResult {
  success: boolean;
  missionId: string;
  completed: boolean;
  result?: MissionResult;
  detected: boolean;
  message: string;
}

// ============================================================================
// CONSTANTS
// ============================================================================

/**
 * Mission configurations
 */
export const MISSION_CONFIGS: Record<MissionType, MissionConfig> = {
  [MissionType.RECONNAISSANCE]: {
    type: MissionType.RECONNAISSANCE,
    name: 'Reconnaissance',
    description: 'Gather basic intelligence on target',
    tier: 1,
    successRates: {
      [SpyRank.ROOKIE]: 0.30,
      [SpyRank.OPERATIVE]: 0.50,
      [SpyRank.AGENT]: 0.70,
      [SpyRank.VETERAN]: 0.85,
      [SpyRank.ELITE]: 0.95,
    },
    duration: 1800000,             // 30 minutes
    detectionRisk: 0.10,
    cost: {
      metal: 50000,
      energy: 100000,
    },
    requiredTech: 'spy_tier_1',
    minimumSpyRank: SpyRank.ROOKIE,
  },
  
  [MissionType.SURVEILLANCE]: {
    type: MissionType.SURVEILLANCE,
    name: 'Surveillance',
    description: 'Monitor target activity over time',
    tier: 2,
    successRates: {
      [SpyRank.ROOKIE]: 0.25,
      [SpyRank.OPERATIVE]: 0.45,
      [SpyRank.AGENT]: 0.65,
      [SpyRank.VETERAN]: 0.80,
      [SpyRank.ELITE]: 0.90,
    },
    duration: 3600000,             // 1 hour
    detectionRisk: 0.15,
    cost: {
      metal: 100000,
      energy: 200000,
    },
    requiredTech: 'spy_tier_2',
    minimumSpyRank: SpyRank.ROOKIE,
  },
  
  [MissionType.INFILTRATION]: {
    type: MissionType.INFILTRATION,
    name: 'Infiltration',
    description: 'Gain deep access to target systems',
    tier: 4,
    successRates: {
      [SpyRank.ROOKIE]: 0.15,
      [SpyRank.OPERATIVE]: 0.35,
      [SpyRank.AGENT]: 0.55,
      [SpyRank.VETERAN]: 0.70,
      [SpyRank.ELITE]: 0.85,
    },
    duration: 5400000,             // 1.5 hours
    detectionRisk: 0.25,
    cost: {
      metal: 200000,
      energy: 400000,
    },
    requiredTech: 'spy_tier_4',
    minimumSpyRank: SpyRank.OPERATIVE,
  },
  
  [MissionType.SABOTAGE_LIGHT]: {
    type: MissionType.SABOTAGE_LIGHT,
    name: 'Light Sabotage',
    description: 'Delay one missile component',
    tier: 5,
    successRates: {
      [SpyRank.ROOKIE]: 0.20,
      [SpyRank.OPERATIVE]: 0.40,
      [SpyRank.AGENT]: 0.60,
      [SpyRank.VETERAN]: 0.75,
      [SpyRank.ELITE]: 0.90,
    },
    duration: 7200000,             // 2 hours
    detectionRisk: 0.30,
    cost: {
      metal: 300000,
      energy: 600000,
    },
    requiredTech: 'spy_tier_5',
    minimumSpyRank: SpyRank.OPERATIVE,
  },
  
  [MissionType.SABOTAGE_HEAVY]: {
    type: MissionType.SABOTAGE_HEAVY,
    name: 'Heavy Sabotage',
    description: 'Destroy one missile component',
    tier: 7,
    successRates: {
      [SpyRank.ROOKIE]: 0.10,
      [SpyRank.OPERATIVE]: 0.30,
      [SpyRank.AGENT]: 0.50,
      [SpyRank.VETERAN]: 0.65,
      [SpyRank.ELITE]: 0.80,
    },
    duration: 10800000,            // 3 hours
    detectionRisk: 0.40,
    cost: {
      metal: 500000,
      energy: 1000000,
    },
    requiredTech: 'spy_tier_7',
    minimumSpyRank: SpyRank.AGENT,
  },
  
  [MissionType.SABOTAGE_NUCLEAR]: {
    type: MissionType.SABOTAGE_NUCLEAR,
    name: 'Nuclear Sabotage',
    description: 'Destroy ALL missile components',
    tier: 10,
    successRates: {
      [SpyRank.ROOKIE]: 0.05,
      [SpyRank.OPERATIVE]: 0.15,
      [SpyRank.AGENT]: 0.30,
      [SpyRank.VETERAN]: 0.50,
      [SpyRank.ELITE]: 0.70,
    },
    duration: 14400000,            // 4 hours
    detectionRisk: 0.60,
    cost: {
      metal: 1000000,
      energy: 2000000,
    },
    requiredTech: 'spy_tier_10',
    minimumSpyRank: SpyRank.VETERAN,
  },
  
  [MissionType.INTELLIGENCE_LEAK]: {
    type: MissionType.INTELLIGENCE_LEAK,
    name: 'Intelligence Leak',
    description: 'Expose missile details to public',
    tier: 6,
    successRates: {
      [SpyRank.ROOKIE]: 0.25,
      [SpyRank.OPERATIVE]: 0.45,
      [SpyRank.AGENT]: 0.65,
      [SpyRank.VETERAN]: 0.80,
      [SpyRank.ELITE]: 0.95,
    },
    duration: 3600000,             // 1 hour
    detectionRisk: 0.20,
    cost: {
      metal: 150000,
      energy: 300000,
    },
    requiredTech: 'spy_tier_6',
    minimumSpyRank: SpyRank.AGENT,
  },
  
  [MissionType.COUNTER_INTELLIGENCE]: {
    type: MissionType.COUNTER_INTELLIGENCE,
    name: 'Counter-Intelligence',
    description: 'Protect against enemy spies',
    tier: 3,
    successRates: {
      [SpyRank.ROOKIE]: 0.30,
      [SpyRank.OPERATIVE]: 0.50,
      [SpyRank.AGENT]: 0.70,
      [SpyRank.VETERAN]: 0.85,
      [SpyRank.ELITE]: 0.95,
    },
    duration: 7200000,             // 2 hours
    detectionRisk: 0.05,
    cost: {
      metal: 100000,
      energy: 200000,
    },
    requiredTech: 'spy_tier_3',
    minimumSpyRank: SpyRank.OPERATIVE,
  },
  
  [MissionType.ASSASSINATION]: {
    type: MissionType.ASSASSINATION,
    name: 'Assassination',
    description: 'Eliminate enemy spy',
    tier: 9,
    successRates: {
      [SpyRank.ROOKIE]: 0.05,
      [SpyRank.OPERATIVE]: 0.20,
      [SpyRank.AGENT]: 0.40,
      [SpyRank.VETERAN]: 0.60,
      [SpyRank.ELITE]: 0.80,
    },
    duration: 10800000,            // 3 hours
    detectionRisk: 0.50,
    cost: {
      metal: 750000,
      energy: 1500000,
    },
    requiredTech: 'spy_tier_9',
    minimumSpyRank: SpyRank.VETERAN,
  },
  
  [MissionType.THEFT]: {
    type: MissionType.THEFT,
    name: 'Research Theft',
    description: 'Steal research data',
    tier: 8,
    successRates: {
      [SpyRank.ROOKIE]: 0.10,
      [SpyRank.OPERATIVE]: 0.25,
      [SpyRank.AGENT]: 0.45,
      [SpyRank.VETERAN]: 0.65,
      [SpyRank.ELITE]: 0.85,
    },
    duration: 7200000,             // 2 hours
    detectionRisk: 0.35,
    cost: {
      metal: 400000,
      energy: 800000,
    },
    requiredTech: 'spy_tier_8',
    minimumSpyRank: SpyRank.AGENT,
  },
};

/**
 * Spy rank experience thresholds
 */
export const SPY_RANK_THRESHOLDS = {
  [SpyRank.ROOKIE]: 0,
  [SpyRank.OPERATIVE]: 10,         // 10 successful missions
  [SpyRank.AGENT]: 30,             // 30 successful missions
  [SpyRank.VETERAN]: 60,           // 60 successful missions
  [SpyRank.ELITE]: 100,            // 100 successful missions
} as const;

/**
 * Intelligence leak probability
 */
export const INTEL_LEAK_PROBABILITY = {
  baseChance: 0.05,                // 5% base chance on any mission
  perMissionIncrease: 0.02,        // +2% per additional mission
  maxChance: 0.30,                 // Cap at 30%
  leakCooldown: 86400000,          // 24h cooldown after leak
} as const;

/**
 * Sabotage impact
 */
export const SABOTAGE_IMPACT = {
  lightDelay: 7200000,             // 2 hour delay
  heavyDelay: 14400000,            // 4 hour delay
  nuclearDestruction: true,        // Destroys all components
  resourceRefund: 0.25,            // 25% refund on destroyed components
} as const;

// ============================================================================
// TYPE GUARDS
// ============================================================================

/**
 * Check if mission type is valid
 */
export function isValidMissionType(type: string): type is MissionType {
  return Object.values(MissionType).includes(type as MissionType);
}

/**
 * Check if spy rank is valid
 */
export function isValidSpyRank(rank: string): rank is SpyRank {
  return Object.values(SpyRank).includes(rank as SpyRank);
}

/**
 * Calculate mission success chance
 */
export function calculateSuccessChance(
  spyRank: SpyRank,
  missionType: MissionType,
  targetSecurity: number,
  clanBonus: number,
  equipmentBonus: number
): number {
  const baseChance = MISSION_CONFIGS[missionType].successRates[spyRank];
  const securityPenalty = targetSecurity * 0.5; // Security reduces success
  const totalBonus = clanBonus + equipmentBonus;
  
  const finalChance = baseChance - securityPenalty + totalBonus;
  
  // Clamp between 5% and 95%
  return Math.max(0.05, Math.min(0.95, finalChance));
}

// ============================================================================
// IMPLEMENTATION NOTES
// ============================================================================
/**
 * 1. Mission Types:
 *    - RECONNAISSANCE: Basic intel gathering (30-95% success)
 *    - SURVEILLANCE: Activity monitoring (25-90% success)
 *    - INFILTRATION: Deep system access (15-85% success)
 *    - SABOTAGE_LIGHT: 2h delay (20-90% success)
 *    - SABOTAGE_HEAVY: Destroy 1 component (10-80% success)
 *    - SABOTAGE_NUCLEAR: Destroy ALL components (5-70% success)
 *    - INTELLIGENCE_LEAK: Public exposure (25-95% success)
 *    - COUNTER_INTELLIGENCE: Protection (30-95% success)
 *    - ASSASSINATION: Kill enemy spy (5-80% success)
 *    - THEFT: Steal RP (10-85% success)
 * 
 * 2. Spy Ranks:
 *    - ROOKIE: 30% success (0 missions)
 *    - OPERATIVE: 50% success (10 missions)
 *    - AGENT: 70% success (30 missions)
 *    - VETERAN: 85% success (60 missions)
 *    - ELITE: 95% success (100 missions)
 * 
 * 3. Nuclear Sabotage (Game-Changer):
 *    - Destroys ALL 5 components instantly
 *    - 4-hour mission duration
 *    - 60% detection risk (very risky)
 *    - Costs 1M Metal + 2M Energy
 *    - Requires Tier 10 + Veteran spy minimum
 *    - Only 70% max success rate (even for Elite)
 * 
 * 4. Intelligence Leaks:
 *    - 5% base chance on any mission
 *    - +2% per additional mission on same target
 *    - Max 30% leak chance
 *    - Global broadcast reveals missile details
 *    - Creates diplomatic pressure
 *    - 24h cooldown after leak
 * 
 * 5. Counter-Intelligence:
 *    - Security rating 0-100
 *    - Reduces enemy spy success rates
 *    - Can detect and prevent missions
 *    - Assassination available for caught spies
 * 
 * 6. Cost Balance:
 *    - Reconnaissance: 50k Metal + 100k Energy
 *    - Nuclear Sabotage: 1M Metal + 2M Energy
 *    - Assassination: 750k Metal + 1.5M Energy
 *    - Spying cheaper than building (defensive meta)
 */

// ============================================================================
// END OF FILE
// ============================================================================

@@@END@@@
@@@FILE:types/wmd/missile.types.ts@@@
/**
 * @file types/wmd/missile.types.ts
 * @created 2025-10-22
 * @overview WMD Missile System Type Definitions
 * 
 * OVERVIEW:
 * Complete type system for strategic missile program including warhead types,
 * missile assembly, component tracking, targeting, and damage distribution.
 * 
 * Features:
 * - 5 warhead types (Tactical â†’ Clan Buster)
 * - 5-component assembly system
 * - Multi-target damage distribution
 * - Launch authorization workflow
 * - Interception tracking
 * 
 * Dependencies:
 * - MongoDB for data persistence
 * - Clan system for authorization
 */

import { ObjectId } from 'mongodb';

// ============================================================================
// ENUMS
// ============================================================================

/**
 * Warhead types with increasing destructive capability
 */
export enum WarheadType {
  TACTICAL = 'TACTICAL',           // Single target, moderate damage
  STRATEGIC = 'STRATEGIC',         // Single target, heavy damage
  NEUTRON = 'NEUTRON',             // Anti-personnel, preserves resources
  CLUSTER = 'CLUSTER',             // Multiple targets, distributed damage
  CLAN_BUSTER = 'CLAN_BUSTER',     // Entire clan damage (T10 only)
}

/**
 * Missile lifecycle states
 */
export enum MissileStatus {
  ASSEMBLING = 'ASSEMBLING',       // Components being gathered
  READY = 'READY',                 // All 5 components complete
  LAUNCHED = 'LAUNCHED',           // In flight
  INTERCEPTED = 'INTERCEPTED',     // Destroyed by defense
  DETONATED = 'DETONATED',         // Successfully impacted
  DISMANTLED = 'DISMANTLED',       // Manually destroyed
}

/**
 * Missile components required for assembly
 */
export enum MissileComponent {
  WARHEAD = 'WARHEAD',             // Explosive payload
  PROPULSION = 'PROPULSION',       // Rocket engines
  GUIDANCE = 'GUIDANCE',           // Targeting system
  PAYLOAD = 'PAYLOAD',             // Delivery mechanism
  STEALTH = 'STEALTH',             // Counter-detection tech
}

// ============================================================================
// INTERFACES
// ============================================================================

/**
 * Main missile document
 */
export interface Missile {
  _id?: ObjectId;
  ownerId: string;                 // Player username
  ownerClanId: string;             // Owner's clan ID
  warheadType: WarheadType;
  status: MissileStatus;
  
  // Component assembly tracking
  components: {
    warhead: boolean;
    propulsion: boolean;
    guidance: boolean;
    payload: boolean;
    stealth: boolean;
  };
  
  // Targeting data
  targetId?: string;               // Primary target player/clan
  targetType?: 'player' | 'clan'; // Target entity type
  secondaryTargets?: string[];     // Additional targets (CLUSTER/CLAN_BUSTER)
  
  // Launch metadata
  launchedAt?: Date;
  launchedBy?: string;             // Player who authorized launch
  impactAt?: Date;                 // Calculated impact time
  flightTime?: number;             // Milliseconds in flight
  
  // Interception tracking
  interceptAttempts?: number;      // How many intercept attempts
  interceptedBy?: string;          // Player/clan who intercepted
  interceptedAt?: Date;
  
  // Damage tracking
  damageDealt?: DamageDistribution;
  
  // Timestamps
  createdAt: Date;
  completedAt?: Date;              // When all components assembled
  updatedAt: Date;
}

/**
 * Component assembly progress
 */
export interface ComponentProgress {
  missileId: string;
  ownerId: string;
  warhead: ComponentStatus;
  propulsion: ComponentStatus;
  guidance: ComponentStatus;
  payload: ComponentStatus;
  stealth: ComponentStatus;
  overallProgress: number;         // Percentage (0-100)
  estimatedCompletion?: Date;
}

/**
 * Individual component status
 */
export interface ComponentStatus {
  acquired: boolean;
  acquiredAt?: Date;
  cost: {
    metal: number;
    energy: number;
  };
  source?: string;                 // 'purchased' | 'captured' | 'gifted'
}

/**
 * Damage distribution for multi-target warheads
 */
export interface DamageDistribution {
  primaryTarget: {
    targetId: string;
    targetUsername: string;
    damagePercent: number;
    unitsDestroyed: number;
    resourcesLost: {
      metal: number;
      energy: number;
    };
  };
  secondaryTargets?: Array<{
    targetId: string;
    targetUsername: string;
    damagePercent: number;
    unitsDestroyed: number;
    resourcesLost: {
      metal: number;
      energy: number;
    };
  }>;
  totalUnitsDestroyed: number;
  totalResourcesDestroyed: {
    metal: number;
    energy: number;
  };
  calculatedAt: Date;
}

/**
 * Launch authorization request
 */
export interface LaunchRequest {
  missileId: string;
  requestedBy: string;
  targetId: string;
  targetType: 'player' | 'clan';
  authorization: {
    clanApproved: boolean;
    approvedBy?: string[];         // List of approving members
    voteId?: string;               // Reference to clan vote
  };
  launchTime: Date;
}

/**
 * Launch authorization result
 */
export interface LaunchResult {
  success: boolean;
  missileId: string;
  launchedAt: Date;
  impactAt: Date;
  flightTime: number;
  targetId: string;
  targetUsername: string;
  message: string;
  globalNotificationId?: string;   // Reference to broadcast
}

/**
 * Missile inventory summary
 */
export interface MissileInventory {
  ownerId: string;
  missiles: Array<{
    missileId: string;
    warheadType: WarheadType;
    status: MissileStatus;
    progress: number;              // 0-100%
    readyToLaunch: boolean;
  }>;
  totalMissiles: number;
  readyMissiles: number;
  assemblingMissiles: number;
  launchedMissiles: number;
}

/**
 * Targeting validation result
 */
export interface TargetValidation {
  valid: boolean;
  targetId: string;
  targetUsername: string;
  targetLevel: number;
  targetClanId?: string;
  targetClanName?: string;
  canTarget: boolean;
  reason?: string;                 // Rejection reason
  missChance?: number;             // Probability of missing
}

/**
 * Warhead configuration
 */
export interface WarheadConfig {
  type: WarheadType;
  tier: number;                    // 1-10 research tier
  name: string;
  description: string;
  damage: {
    primaryPercent: number;        // % of target's units destroyed
    secondaryPercent?: number;     // For multi-target
    tertiaryPercent?: number;      // For clan-wide
  };
  maxTargets: number;              // 1 for single, 5+ for cluster
  requiredTech: string;            // Tech tree prerequisite
  cost: {
    metal: number;
    energy: number;
  };
  flightTime: number;              // Milliseconds to impact
  interceptDifficulty: number;     // 0-1 (higher = harder to intercept)
}

/**
 * Component cost configuration
 */
export interface ComponentCost {
  component: MissileComponent;
  baseCost: {
    metal: number;
    energy: number;
  };
  tierMultiplier: number;          // Scales with warhead tier
  productionTime: number;          // Milliseconds to acquire
}

/**
 * Missile assembly request
 */
export interface AssemblyRequest {
  ownerId: string;
  warheadType: WarheadType;
  tier: number;
}

/**
 * Missile assembly result
 */
export interface AssemblyResult {
  success: boolean;
  missileId: string;
  warheadType: WarheadType;
  components: {
    warhead: boolean;
    propulsion: boolean;
    guidance: boolean;
    payload: boolean;
    stealth: boolean;
  };
  totalCost: {
    metal: number;
    energy: number;
  };
  message: string;
}

/**
 * Component acquisition request
 */
export interface ComponentAcquisitionRequest {
  missileId: string;
  component: MissileComponent;
  ownerId: string;
}

/**
 * Component acquisition result
 */
export interface ComponentAcquisitionResult {
  success: boolean;
  component: MissileComponent;
  acquired: boolean;
  costPaid: {
    metal: number;
    energy: number;
  };
  progress: number;                // Overall missile progress %
  allComponentsAcquired: boolean;
  message: string;
}

// ============================================================================
// CONSTANTS
// ============================================================================

/**
 * Warhead configurations by type
 */
export const WARHEAD_CONFIGS: Record<WarheadType, WarheadConfig> = {
  [WarheadType.TACTICAL]: {
    type: WarheadType.TACTICAL,
    tier: 1,
    name: 'Tactical Warhead',
    description: 'Single target, moderate damage',
    damage: {
      primaryPercent: 25,
    },
    maxTargets: 1,
    requiredTech: 'missile_tier_1',
    cost: {
      metal: 500000,
      energy: 1000000,
    },
    flightTime: 300000,              // 5 minutes
    interceptDifficulty: 0.2,
  },
  [WarheadType.STRATEGIC]: {
    type: WarheadType.STRATEGIC,
    tier: 5,
    name: 'Strategic Warhead',
    description: 'Single target, heavy damage',
    damage: {
      primaryPercent: 50,
    },
    maxTargets: 1,
    requiredTech: 'missile_tier_5',
    cost: {
      metal: 500000,
      energy: 1000000,
    },
    flightTime: 240000,              // 4 minutes
    interceptDifficulty: 0.4,
  },
  [WarheadType.NEUTRON]: {
    type: WarheadType.NEUTRON,
    tier: 7,
    name: 'Neutron Warhead',
    description: 'Anti-personnel, preserves resources',
    damage: {
      primaryPercent: 60,
    },
    maxTargets: 1,
    requiredTech: 'missile_tier_7',
    cost: {
      metal: 500000,
      energy: 1000000,
    },
    flightTime: 180000,              // 3 minutes
    interceptDifficulty: 0.5,
  },
  [WarheadType.CLUSTER]: {
    type: WarheadType.CLUSTER,
    tier: 8,
    name: 'Cluster Warhead',
    description: 'Multiple targets, distributed damage',
    damage: {
      primaryPercent: 40,
      secondaryPercent: 20,
    },
    maxTargets: 5,
    requiredTech: 'missile_tier_8',
    cost: {
      metal: 500000,
      energy: 1000000,
    },
    flightTime: 300000,              // 5 minutes
    interceptDifficulty: 0.6,
  },
  [WarheadType.CLAN_BUSTER]: {
    type: WarheadType.CLAN_BUSTER,
    tier: 10,
    name: 'Clan Buster Warhead',
    description: 'Entire clan damage (ultimate weapon)',
    damage: {
      primaryPercent: 50,
      secondaryPercent: 30,
      tertiaryPercent: 20,
    },
    maxTargets: 100,                 // Entire clan
    requiredTech: 'missile_tier_10',
    cost: {
      metal: 500000,
      energy: 1000000,
    },
    flightTime: 600000,              // 10 minutes (advance warning)
    interceptDifficulty: 0.8,
  },
};

/**
 * Component costs by type
 */
export const COMPONENT_COSTS: Record<MissileComponent, ComponentCost> = {
  [MissileComponent.WARHEAD]: {
    component: MissileComponent.WARHEAD,
    baseCost: {
      metal: 500000,
      energy: 1000000,
    },
    tierMultiplier: 1.2,
    productionTime: 3600000,         // 1 hour
  },
  [MissileComponent.PROPULSION]: {
    component: MissileComponent.PROPULSION,
    baseCost: {
      metal: 750000,
      energy: 500000,
    },
    tierMultiplier: 1.15,
    productionTime: 2700000,         // 45 minutes
  },
  [MissileComponent.GUIDANCE]: {
    component: MissileComponent.GUIDANCE,
    baseCost: {
      metal: 250000,
      energy: 750000,
    },
    tierMultiplier: 1.25,
    productionTime: 1800000,         // 30 minutes
  },
  [MissileComponent.PAYLOAD]: {
    component: MissileComponent.PAYLOAD,
    baseCost: {
      metal: 1000000,
      energy: 500000,
    },
    tierMultiplier: 1.1,
    productionTime: 3600000,         // 1 hour
  },
  [MissileComponent.STEALTH]: {
    component: MissileComponent.STEALTH,
    baseCost: {
      metal: 500000,
      energy: 1000000,
    },
    tierMultiplier: 1.3,
    productionTime: 5400000,         // 1.5 hours
  },
};

/**
 * Targeting validation rules
 */
export const TARGETING_RULES = {
  minTargetLevel: 40,                // Can only target Level 40+ players
  minTargetPower: 10000,             // Or players with 10k+ power
  clanProtectionDays: 3,             // New clan members protected for 3 days
  recentAttackCooldown: 86400000,   // 24h cooldown after being hit
  maxMissChance: 0.85,               // 85% max miss rate vs weak targets
  baseHitChance: 0.15,               // 15% min hit chance vs anyone
} as const;

// ============================================================================
// TYPE GUARDS
// ============================================================================

/**
 * Check if warhead type is valid
 */
export function isValidWarheadType(type: string): type is WarheadType {
  return Object.values(WarheadType).includes(type as WarheadType);
}

/**
 * Check if missile status is valid
 */
export function isValidMissileStatus(status: string): status is MissileStatus {
  return Object.values(MissileStatus).includes(status as MissileStatus);
}

/**
 * Check if component type is valid
 */
export function isValidComponent(component: string): component is MissileComponent {
  return Object.values(MissileComponent).includes(component as MissileComponent);
}

/**
 * Check if missile is ready to launch
 */
export function isMissileReady(missile: Missile): boolean {
  return (
    missile.status === MissileStatus.READY &&
    missile.components.warhead &&
    missile.components.propulsion &&
    missile.components.guidance &&
    missile.components.payload &&
    missile.components.stealth
  );
}

/**
 * Calculate missile assembly progress
 */
export function calculateProgress(missile: Missile): number {
  const components = Object.values(missile.components);
  const completed = components.filter(c => c === true).length;
  return Math.round((completed / components.length) * 100);
}

// ============================================================================
// IMPLEMENTATION NOTES
// ============================================================================
/**
 * 1. Warhead Types:
 *    - TACTICAL: Tier 1, 25% damage, single target
 *    - STRATEGIC: Tier 5, 50% damage, single target
 *    - NEUTRON: Tier 7, 60% damage, preserves resources
 *    - CLUSTER: Tier 8, 40%+20% damage, 5 targets
 *    - CLAN_BUSTER: Tier 10, 50%+30%+20% damage, entire clan
 * 
 * 2. Component System:
 *    - All 5 components required for launch
 *    - Each component has unique cost and production time
 *    - Costs scale with warhead tier (tierMultiplier)
 *    - Total missile cost: 3M Metal + 3.75M Energy
 * 
 * 3. Launch Authorization:
 *    - Clan vote required for launch (60% approval)
 *    - Leader/Co-Leader can authorize without vote
 *    - Global notification on launch
 *    - Flight time provides advance warning (3-10 min)
 * 
 * 4. Targeting Rules:
 *    - Can only target Level 40+ or 10k+ power players
 *    - New clan members protected for 3 days
 *    - 24h cooldown after being hit
 *    - Miss chance scales with power difference (85% max)
 * 
 * 5. Clan Buster Mechanics:
 *    - 50% damage to primary target
 *    - 30% damage to top 3 players
 *    - 20% damage to 5 random members
 *    - Requires Tier 10 research (300k RP)
 *    - 10-minute flight time (maximum warning)
 * 
 * 6. Interception:
 *    - Defense batteries can intercept (see defense.types.ts)
 *    - Intercept difficulty scales with warhead tier
 *    - Clan Buster: 80% difficulty (hardest to stop)
 *    - Failed intercepts waste defense resources
 */

// ============================================================================
// END OF FILE
// ============================================================================

@@@END@@@
@@@FILE:types/wmd/notification.types.ts@@@
/**
 * @file types/wmd/notification.types.ts
 * @created 2025-10-22
 * @overview WMD Notification System Type Definitions
 * 
 * OVERVIEW:
 * Complete type system for WMD global notifications including event types,
 * broadcast priorities, user notification preferences, and WebSocket integration.
 * 
 * Features:
 * - Global event broadcasting
 * - Targeted clan notifications
 * - Personal alerts
 * - Notification preferences
 * - Real-time WebSocket events
 * 
 * Dependencies:
 * - /lib/websocket/broadcast.ts for broadcasting (REUSE EXISTING)
 * - MongoDB for notification storage
 */

import { ObjectId } from 'mongodb';
import { WarheadType } from './missile.types';
import { MissionType } from './intelligence.types';

// ============================================================================
// ENUMS
// ============================================================================

/**
 * WMD notification event types
 */
export enum WMDEventType {
  // Missile events
  MISSILE_ASSEMBLED = 'MISSILE_ASSEMBLED',         // All 5 components complete
  MISSILE_LAUNCHED = 'MISSILE_LAUNCHED',           // Launch initiated
  MISSILE_DETECTED = 'MISSILE_DETECTED',           // Radar detection
  MISSILE_INTERCEPTED = 'MISSILE_INTERCEPTED',     // Defense success
  MISSILE_IMPACTED = 'MISSILE_IMPACTED',           // Detonation
  MISSILE_DISMANTLED = 'MISSILE_DISMANTLED',       // Manually destroyed
  
  // Intelligence events
  INTELLIGENCE_LEAK = 'INTELLIGENCE_LEAK',         // Missile details exposed
  SPY_MISSION_COMPLETED = 'SPY_MISSION_COMPLETED', // Mission finished
  SPY_MISSION_FAILED = 'SPY_MISSION_FAILED',       // Mission failed
  SPY_DETECTED = 'SPY_DETECTED',                   // Spy caught
  SABOTAGE_SUCCESSFUL = 'SABOTAGE_SUCCESSFUL',     // Component destroyed
  ASSASSINATION = 'ASSASSINATION',                 // Spy killed
  
  // Defense events
  BATTERY_DEPLOYED = 'BATTERY_DEPLOYED',           // New battery online
  RADAR_ONLINE = 'RADAR_ONLINE',                   // Radar activated
  DEFENSE_GRID_ACTIVATED = 'DEFENSE_GRID_ACTIVATED', // Clan pooling enabled
  
  // Research events
  RESEARCH_COMPLETED = 'RESEARCH_COMPLETED',       // Tech unlocked
  TIER_10_UNLOCKED = 'TIER_10_UNLOCKED',           // Ultimate tech (global)
  
  // Clan events
  CLAN_VOTE_STARTED = 'CLAN_VOTE_STARTED',         // Vote initiated
  CLAN_VOTE_PASSED = 'CLAN_VOTE_PASSED',           // Vote approved
  CLAN_AUTHORIZATION = 'CLAN_AUTHORIZATION',       // Launch authorized
}

/**
 * Notification priority levels
 */
export enum NotificationPriority {
  INFO = 'INFO',                   // General information
  WARNING = 'WARNING',             // Important notice
  ALERT = 'ALERT',                 // Urgent action required
  CRITICAL = 'CRITICAL',           // Maximum priority (missile launch)
}

/**
 * Notification scopes
 */
export enum NotificationScope {
  GLOBAL = 'GLOBAL',               // Everyone sees it
  CLAN = 'CLAN',                   // Clan members only
  PERSONAL = 'PERSONAL',           // Individual player only
  TARGETED = 'TARGETED',           // Specific player/clan
}

// ============================================================================
// INTERFACES
// ============================================================================

/**
 * Main WMD notification document
 */
export interface WMDNotification {
  _id?: ObjectId;
  notificationId: string;          // Unique identifier
  eventType: WMDEventType;
  priority: NotificationPriority;
  scope: NotificationScope;
  
  // Source information
  sourceId: string;                // Player/clan who triggered event
  sourceName: string;
  sourceClanId?: string;
  sourceClanName?: string;
  
  // Target information (if applicable)
  targetId?: string;               // Affected player/clan
  targetName?: string;
  targetClanId?: string;
  targetClanName?: string;
  
  // Event details
  details: {
    missileId?: string;
    warheadType?: WarheadType;
    missionType?: MissionType;
    techId?: string;
    techTier?: number;
    damageDealt?: number;
    unitsDestroyed?: number;
    [key: string]: any;            // Flexible for event-specific data
  };
  
  // Message content
  title: string;
  message: string;
  icon?: string;                   // Icon/emoji
  color?: string;                  // Hex color code
  
  // Broadcast tracking
  broadcastAt: Date;
  expiresAt?: Date;                // When notification should be removed
  
  // Engagement
  viewCount: number;
  viewedBy: string[];              // Players who viewed
  
  createdAt: Date;
}

/**
 * Notification preference settings
 */
export interface NotificationPreferences {
  _id?: ObjectId;
  playerId: string;
  playerUsername: string;
  
  // Global notifications
  receiveGlobalNotifications: boolean;
  
  // Event type preferences
  preferences: Record<WMDEventType, boolean>;
  
  // Priority thresholds
  minPriority: NotificationPriority; // Minimum priority to receive
  
  // Clan notifications
  receiveClanNotifications: boolean;
  
  // Personal notifications
  receivePersonalNotifications: boolean;
  
  updatedAt: Date;
}

/**
 * Notification creation request
 */
export interface NotificationRequest {
  eventType: WMDEventType;
  priority: NotificationPriority;
  scope: NotificationScope;
  sourceId: string;
  sourceName: string;
  targetId?: string;
  targetName?: string;
  details: Record<string, any>;
  customMessage?: string;          // Override default message
}

/**
 * Notification broadcast result
 */
export interface NotificationBroadcastResult {
  success: boolean;
  notificationId: string;
  scope: NotificationScope;
  recipientCount: number;
  broadcastAt: Date;
  message: string;
}

/**
 * WebSocket WMD event payload
 */
export interface WMDWebSocketEvent {
  type: 'wmd_notification';
  eventType: WMDEventType;
  priority: NotificationPriority;
  notificationId: string;
  
  // Display data
  title: string;
  message: string;
  icon?: string;
  color?: string;
  
  // Event data
  sourceId: string;
  sourceName: string;
  targetId?: string;
  targetName?: string;
  details: Record<string, any>;
  
  timestamp: Date;
}

/**
 * Missile launch broadcast payload
 */
export interface MissileLaunchBroadcast {
  missileId: string;
  launchedBy: string;
  launchedByClan?: string;
  warheadType: WarheadType;
  targetId: string;
  targetName: string;
  impactAt: Date;
  flightTime: number;
  canIntercept: boolean;
}

/**
 * Intelligence leak broadcast payload
 */
export interface IntelligenceLeakBroadcast {
  leakedBy: string;
  leakedFrom: string;
  missileId: string;
  warheadType: WarheadType;
  progress: number;
  estimatedCompletion?: Date;
  targetId?: string;
}

/**
 * Notification history summary
 */
export interface NotificationHistory {
  playerId: string;
  
  // Recent notifications
  recentNotifications: WMDNotification[];
  
  // Stats
  totalReceived: number;
  totalViewed: number;
  unreadCount: number;
  
  // By priority
  criticalUnread: number;
  alertUnread: number;
  warningUnread: number;
  
  updatedAt: Date;
}

// ============================================================================
// CONSTANTS
// ============================================================================

/**
 * Default notification preferences
 */
export const DEFAULT_NOTIFICATION_PREFERENCES: Partial<NotificationPreferences> = {
  receiveGlobalNotifications: true,
  receiveClanNotifications: true,
  receivePersonalNotifications: true,
  minPriority: NotificationPriority.INFO,
  preferences: {
    [WMDEventType.MISSILE_ASSEMBLED]: true,
    [WMDEventType.MISSILE_LAUNCHED]: true,
    [WMDEventType.MISSILE_DETECTED]: true,
    [WMDEventType.MISSILE_INTERCEPTED]: true,
    [WMDEventType.MISSILE_IMPACTED]: true,
    [WMDEventType.MISSILE_DISMANTLED]: false,
    [WMDEventType.INTELLIGENCE_LEAK]: true,
    [WMDEventType.SPY_MISSION_COMPLETED]: false,
    [WMDEventType.SPY_MISSION_FAILED]: false,
    [WMDEventType.SPY_DETECTED]: true,
    [WMDEventType.SABOTAGE_SUCCESSFUL]: true,
    [WMDEventType.ASSASSINATION]: true,
    [WMDEventType.BATTERY_DEPLOYED]: false,
    [WMDEventType.RADAR_ONLINE]: false,
    [WMDEventType.DEFENSE_GRID_ACTIVATED]: true,
    [WMDEventType.RESEARCH_COMPLETED]: false,
    [WMDEventType.TIER_10_UNLOCKED]: true,
    [WMDEventType.CLAN_VOTE_STARTED]: true,
    [WMDEventType.CLAN_VOTE_PASSED]: true,
    [WMDEventType.CLAN_AUTHORIZATION]: true,
  },
};

/**
 * Notification message templates
 */
export const NOTIFICATION_TEMPLATES: Record<WMDEventType, {
  title: string;
  message: (data: any) => string;
  icon: string;
  color: string;
  priority: NotificationPriority;
}> = {
  [WMDEventType.MISSILE_ASSEMBLED]: {
    title: 'ðŸš€ Missile Assembled',
    message: (data) => `${data.sourceName} has completed assembly of a ${data.warheadType} missile!`,
    icon: 'ðŸš€',
    color: '#FF6B35',
    priority: NotificationPriority.WARNING,
  },
  [WMDEventType.MISSILE_LAUNCHED]: {
    title: 'âš ï¸ MISSILE LAUNCH DETECTED',
    message: (data) => `${data.sourceName} has launched a ${data.warheadType} missile targeting ${data.targetName}! Impact in ${Math.floor(data.flightTime / 60000)} minutes.`,
    icon: 'âš ï¸',
    color: '#FF0000',
    priority: NotificationPriority.CRITICAL,
  },
  [WMDEventType.MISSILE_DETECTED]: {
    title: 'ðŸ“¡ Missile Detected',
    message: (data) => `Radar has detected a ${data.warheadType} missile targeting ${data.targetName}.`,
    icon: 'ðŸ“¡',
    color: '#FFA500',
    priority: NotificationPriority.ALERT,
  },
  [WMDEventType.MISSILE_INTERCEPTED]: {
    title: 'ðŸ›¡ï¸ Interception Successful',
    message: (data) => `${data.sourceName}'s defense batteries intercepted a ${data.warheadType} missile!`,
    icon: 'ðŸ›¡ï¸',
    color: '#00FF00',
    priority: NotificationPriority.INFO,
  },
  [WMDEventType.MISSILE_IMPACTED]: {
    title: 'ðŸ’¥ MISSILE IMPACT',
    message: (data) => `${data.targetName} has been hit by a ${data.warheadType} missile! ${data.unitsDestroyed} units destroyed.`,
    icon: 'ðŸ’¥',
    color: '#8B0000',
    priority: NotificationPriority.CRITICAL,
  },
  [WMDEventType.INTELLIGENCE_LEAK]: {
    title: 'ðŸ“° Intelligence Leak',
    message: (data) => `BREAKING: ${data.leakedFrom} is developing a ${data.warheadType} missile (${data.progress}% complete)!`,
    icon: 'ðŸ“°',
    color: '#4169E1',
    priority: NotificationPriority.WARNING,
  },
  [WMDEventType.SABOTAGE_SUCCESSFUL]: {
    title: 'ðŸŽ¯ Sabotage Success',
    message: (data) => `Enemy spies have sabotaged ${data.targetName}'s missile program!`,
    icon: 'ðŸŽ¯',
    color: '#9932CC',
    priority: NotificationPriority.ALERT,
  },
  [WMDEventType.TIER_10_UNLOCKED]: {
    title: 'ðŸ† Ultimate Technology Unlocked',
    message: (data) => `${data.sourceName} has unlocked ${data.techName}! The balance of power has shifted.`,
    icon: 'ðŸ†',
    color: '#FFD700',
    priority: NotificationPriority.CRITICAL,
  },
  // ... (additional templates for other event types)
  [WMDEventType.MISSILE_DISMANTLED]: {
    title: 'ðŸ”§ Missile Dismantled',
    message: (data) => `${data.sourceName} has dismantled a ${data.warheadType} missile.`,
    icon: 'ðŸ”§',
    color: '#808080',
    priority: NotificationPriority.INFO,
  },
  [WMDEventType.SPY_MISSION_COMPLETED]: {
    title: 'ðŸ•µï¸ Mission Complete',
    message: (data) => `Your spy has completed a ${data.missionType} mission against ${data.targetName}.`,
    icon: 'ðŸ•µï¸',
    color: '#006400',
    priority: NotificationPriority.INFO,
  },
  [WMDEventType.SPY_MISSION_FAILED]: {
    title: 'âŒ Mission Failed',
    message: (data) => `Your spy failed a ${data.missionType} mission against ${data.targetName}.`,
    icon: 'âŒ',
    color: '#8B0000',
    priority: NotificationPriority.WARNING,
  },
  [WMDEventType.SPY_DETECTED]: {
    title: 'ðŸš¨ Spy Detected',
    message: (data) => `Counter-intelligence detected a ${data.sourceName} spy attempting ${data.missionType}!`,
    icon: 'ðŸš¨',
    color: '#FF4500',
    priority: NotificationPriority.ALERT,
  },
  [WMDEventType.ASSASSINATION]: {
    title: 'âš°ï¸ Spy Eliminated',
    message: (data) => `${data.sourceName}'s ${data.spyRank} spy has been assassinated!`,
    icon: 'âš°ï¸',
    color: '#000000',
    priority: NotificationPriority.CRITICAL,
  },
  [WMDEventType.BATTERY_DEPLOYED]: {
    title: 'ðŸ›¡ï¸ Battery Deployed',
    message: (data) => `${data.sourceName} has deployed a ${data.batteryType} defense battery.`,
    icon: 'ðŸ›¡ï¸',
    color: '#4682B4',
    priority: NotificationPriority.INFO,
  },
  [WMDEventType.RADAR_ONLINE]: {
    title: 'ðŸ“¡ Radar Online',
    message: (data) => `${data.sourceName} has activated ${data.radarLevel} radar coverage.`,
    icon: 'ðŸ“¡',
    color: '#1E90FF',
    priority: NotificationPriority.INFO,
  },
  [WMDEventType.DEFENSE_GRID_ACTIVATED]: {
    title: 'ðŸŒ Defense Grid Active',
    message: (data) => `${data.clanName} has activated their clan defense grid!`,
    icon: 'ðŸŒ',
    color: '#20B2AA',
    priority: NotificationPriority.WARNING,
  },
  [WMDEventType.RESEARCH_COMPLETED]: {
    title: 'ðŸ”¬ Research Complete',
    message: (data) => `You have unlocked ${data.techName}!`,
    icon: 'ðŸ”¬',
    color: '#32CD32',
    priority: NotificationPriority.INFO,
  },
  [WMDEventType.CLAN_VOTE_STARTED]: {
    title: 'ðŸ—³ï¸ Vote Started',
    message: (data) => `${data.sourceName} initiated a vote to ${data.voteType}.`,
    icon: 'ðŸ—³ï¸',
    color: '#4169E1',
    priority: NotificationPriority.WARNING,
  },
  [WMDEventType.CLAN_VOTE_PASSED]: {
    title: 'âœ… Vote Passed',
    message: (data) => `Clan vote to ${data.voteType} has passed!`,
    icon: 'âœ…',
    color: '#228B22',
    priority: NotificationPriority.ALERT,
  },
  [WMDEventType.CLAN_AUTHORIZATION]: {
    title: 'ðŸ”“ Launch Authorized',
    message: (data) => `${data.clanName} has authorized a ${data.warheadType} missile launch!`,
    icon: 'ðŸ”“',
    color: '#FF4500',
    priority: NotificationPriority.CRITICAL,
  },
};

/**
 * Notification expiration times (milliseconds)
 */
export const NOTIFICATION_EXPIRATION = {
  [NotificationPriority.INFO]: 86400000,      // 24 hours
  [NotificationPriority.WARNING]: 172800000,  // 48 hours
  [NotificationPriority.ALERT]: 259200000,    // 72 hours
  [NotificationPriority.CRITICAL]: 604800000, // 7 days
} as const;

// ============================================================================
// TYPE GUARDS & UTILITIES
// ============================================================================

/**
 * Check if event type is valid
 */
export function isValidEventType(type: string): type is WMDEventType {
  return Object.values(WMDEventType).includes(type as WMDEventType);
}

/**
 * Check if priority is valid
 */
export function isValidPriority(priority: string): priority is NotificationPriority {
  return Object.values(NotificationPriority).includes(priority as NotificationPriority);
}

/**
 * Get notification template
 */
export function getNotificationTemplate(eventType: WMDEventType) {
  return NOTIFICATION_TEMPLATES[eventType];
}

/**
 * Generate notification message
 */
export function generateNotificationMessage(
  eventType: WMDEventType,
  data: any
): { title: string; message: string; icon: string; color: string } {
  const template = NOTIFICATION_TEMPLATES[eventType];
  return {
    title: template.title,
    message: template.message(data),
    icon: template.icon,
    color: template.color,
  };
}

/**
 * Calculate notification expiration
 */
export function calculateExpiration(priority: NotificationPriority): Date {
  const now = new Date();
  const expirationMs = NOTIFICATION_EXPIRATION[priority];
  return new Date(now.getTime() + expirationMs);
}

/**
 * Should player receive notification?
 */
export function shouldReceiveNotification(
  prefs: NotificationPreferences,
  notification: WMDNotification
): boolean {
  // Check global setting
  if (!prefs.receiveGlobalNotifications && notification.scope === NotificationScope.GLOBAL) {
    return false;
  }
  
  // Check clan setting
  if (!prefs.receiveClanNotifications && notification.scope === NotificationScope.CLAN) {
    return false;
  }
  
  // Check personal setting
  if (!prefs.receivePersonalNotifications && notification.scope === NotificationScope.PERSONAL) {
    return false;
  }
  
  // Check priority threshold
  const priorityOrder = [
    NotificationPriority.INFO,
    NotificationPriority.WARNING,
    NotificationPriority.ALERT,
    NotificationPriority.CRITICAL,
  ];
  const notificationLevel = priorityOrder.indexOf(notification.priority);
  const minLevel = priorityOrder.indexOf(prefs.minPriority);
  if (notificationLevel < minLevel) {
    return false;
  }
  
  // Check event type preference
  if (prefs.preferences[notification.eventType] === false) {
    return false;
  }
  
  return true;
}

// ============================================================================
// IMPLEMENTATION NOTES
// ============================================================================
/**
 * 1. Notification Scopes:
 *    - GLOBAL: All players (missile launches, Tier 10 unlocks)
 *    - CLAN: Clan members only (votes, authorizations)
 *    - PERSONAL: Individual player (research complete, spy results)
 *    - TARGETED: Specific player/clan (missile impact, sabotage)
 * 
 * 2. Priority Levels:
 *    - INFO: General information, low urgency
 *    - WARNING: Important events, moderate urgency
 *    - ALERT: Urgent events requiring attention
 *    - CRITICAL: Maximum priority (missile launches, impacts)
 * 
 * 3. WebSocket Integration:
 *    - Reuses /lib/websocket/broadcast.ts functions
 *    - broadcastToAll() for GLOBAL scope
 *    - broadcastToClan() for CLAN scope
 *    - broadcastToUser() for PERSONAL/TARGETED scope
 *    - Event type: 'wmd_notification'
 * 
 * 4. Notification Preferences:
 *    - Players can opt out of specific event types
 *    - Minimum priority threshold filtering
 *    - Separate controls for global/clan/personal
 *    - Default: receive all notifications
 * 
 * 5. Message Templates:
 *    - Predefined templates for each event type
 *    - Dynamic data injection (player names, warhead types, etc.)
 *    - Consistent formatting with icons and colors
 *    - Customizable per notification if needed
 * 
 * 6. Expiration Strategy:
 *    - INFO: 24 hours
 *    - WARNING: 48 hours
 *    - ALERT: 72 hours
 *    - CRITICAL: 7 days
 *    (Prevents notification spam accumulation)
 * 
 * 7. Critical Events (Global Broadcast):
 *    - Missile launches (all warhead types)
 *    - Tier 10 tech unlocks (game-changing)
 *    - Intelligence leaks (public exposure)
 *    - Clan Buster detonations (affects many players)
 * 
 * 8. Real-Time Updates:
 *    - WebSocket for instant delivery
 *    - Database persistence for history
 *    - View tracking (who saw what)
 *    - Unread count management
 */

// ============================================================================
// END OF FILE
// ============================================================================

@@@END@@@
@@@FILE:types/wmd/research.types.ts@@@
/**
 * @file types/wmd/research.types.ts
 * @created 2025-10-22
 * @overview WMD Research System Type Definitions
 * 
 * OVERVIEW:
 * Complete type system for WMD research tech tree including missile tiers,
 * defense tiers, spy tiers, and research progression tracking.
 * 
 * Features:
 * - 10-tier research progression (3 parallel tracks)
 * - RP cost scaling and prerequisites
 * - Tech unlock validation
 * - Research progress tracking
 * - Clan research bonuses
 * 
 * Dependencies:
 * - /lib/xpService.ts for RP spending (REUSE EXISTING)
 * - MongoDB for data persistence
 */

import { ObjectId } from 'mongodb';
import { WarheadType } from './missile.types';
import { BatteryType, RadarLevel } from './defense.types';
import { MissionType, SpyRank } from './intelligence.types';

// ============================================================================
// ENUMS
// ============================================================================

/**
 * Research categories
 */
export enum ResearchCategory {
  MISSILE = 'MISSILE',             // Offensive capabilities
  DEFENSE = 'DEFENSE',             // Defensive systems
  INTELLIGENCE = 'INTELLIGENCE',   // Spy operations
}

/**
 * Research status
 */
export enum ResearchStatus {
  LOCKED = 'LOCKED',               // Prerequisites not met
  AVAILABLE = 'AVAILABLE',         // Can be researched
  RESEARCHING = 'RESEARCHING',     // Currently being researched
  COMPLETED = 'COMPLETED',         // Unlocked
}

// ============================================================================
// INTERFACES
// ============================================================================

/**
 * Main research tech document
 */
export interface ResearchTech {
  techId: string;                  // Unique identifier (e.g., 'missile_tier_1')
  name: string;
  description: string;
  category: ResearchCategory;
  tier: number;                    // 1-10
  
  // Prerequisites
  prerequisites: string[];         // Tech IDs that must be completed first
  requiredLevel?: number;          // Player level requirement
  requiredClanLevel?: number;      // Clan level requirement
  
  // Cost
  rpCost: number;                  // Research Points required
  
  // Unlocks
  unlocks: {
    warheadTypes?: WarheadType[];
    batteryTypes?: BatteryType[];
    radarLevels?: RadarLevel[];
    missionTypes?: MissionType[];
    spyRanks?: SpyRank[];
  };
  
  // Metadata
  estimatedTime: string;           // Human-readable (e.g., "2 days")
}

/**
 * Player research progress
 */
export interface PlayerResearch {
  _id?: ObjectId;
  playerId: string;
  playerUsername: string;
  clanId?: string;
  
  // Research tracking
  completedTechs: string[];        // Array of techId
  availableTechs: string[];        // Techs that can be researched now
  lockedTechs: string[];           // Techs with unmet prerequisites
  
  // Current research
  currentResearch?: {
    techId: string;
    startedAt: Date;
    rpSpent: number;
    rpRequired: number;
    progress: number;              // Percentage (0-100)
  };
  
  // Stats by category
  missileTier: number;             // Highest missile tier unlocked (0-10)
  defenseTier: number;             // Highest defense tier unlocked (0-10)
  intelligenceTier: number;        // Highest spy tier unlocked (0-10)
  
  // Total investment
  totalRPSpent: number;
  totalTechsUnlocked: number;
  
  // Bonuses
  clanResearchBonus: number;       // Percentage bonus from clan
  
  updatedAt: Date;
}

/**
 * Research unlock request
 */
export interface ResearchUnlockRequest {
  playerId: string;
  techId: string;
}

/**
 * Research unlock result
 */
export interface ResearchUnlockResult {
  success: boolean;
  techId: string;
  techName: string;
  rpSpent: number;
  unlocked: {
    warheadTypes?: WarheadType[];
    batteryTypes?: BatteryType[];
    radarLevels?: RadarLevel[];
    missionTypes?: MissionType[];
    spyRanks?: SpyRank[];
  };
  newAvailableTechs: string[];
  message: string;
}

/**
 * Tech tree summary
 */
export interface TechTreeSummary {
  playerId: string;
  
  // Missile track (10 tiers)
  missileProgress: {
    tier: number;
    nextTier?: ResearchTech;
    unlocked: WarheadType[];
    locked: WarheadType[];
  };
  
  // Defense track (10 tiers)
  defenseProgress: {
    tier: number;
    nextTier?: ResearchTech;
    unlocked: BatteryType[];
    locked: BatteryType[];
  };
  
  // Intelligence track (10 tiers)
  intelligenceProgress: {
    tier: number;
    nextTier?: ResearchTech;
    unlocked: MissionType[];
    locked: MissionType[];
  };
  
  // Overall
  totalTechs: number;
  completedTechs: number;
  availableTechs: number;
  totalRPSpent: number;
  totalRPNeeded: number;           // To unlock everything
}

/**
 * Research validation result
 */
export interface ResearchValidation {
  canResearch: boolean;
  techId: string;
  techName: string;
  
  // Validation checks
  hasPrerequisites: boolean;
  meetsLevelRequirement: boolean;
  hasEnoughRP: boolean;
  
  // Details
  missingPrerequisites: string[];
  currentLevel: number;
  requiredLevel: number;
  currentRP: number;
  requiredRP: number;
  
  message: string;
}

// ============================================================================
// CONSTANTS - MISSILE RESEARCH TRACK (10 TIERS)
// ============================================================================

export const MISSILE_RESEARCH_TRACK: ResearchTech[] = [
  {
    techId: 'missile_tier_1',
    name: 'Tactical Missile Technology',
    description: 'Unlock Tactical Warheads (25% damage, single target)',
    category: ResearchCategory.MISSILE,
    tier: 1,
    prerequisites: [],
    requiredLevel: 40,
    rpCost: 10000,
    unlocks: {
      warheadTypes: [WarheadType.TACTICAL],
    },
    estimatedTime: '1 day',
  },
  {
    techId: 'missile_tier_2',
    name: 'Improved Propulsion',
    description: 'Reduce missile flight time by 15%',
    category: ResearchCategory.MISSILE,
    tier: 2,
    prerequisites: ['missile_tier_1'],
    rpCost: 15000,
    unlocks: {},
    estimatedTime: '1.5 days',
  },
  {
    techId: 'missile_tier_3',
    name: 'Advanced Guidance Systems',
    description: 'Increase targeting accuracy by 20%',
    category: ResearchCategory.MISSILE,
    tier: 3,
    prerequisites: ['missile_tier_2'],
    rpCost: 20000,
    unlocks: {},
    estimatedTime: '2 days',
  },
  {
    techId: 'missile_tier_4',
    name: 'Hardened Warheads',
    description: 'Missiles gain +10% intercept resistance',
    category: ResearchCategory.MISSILE,
    tier: 4,
    prerequisites: ['missile_tier_3'],
    rpCost: 30000,
    unlocks: {},
    estimatedTime: '3 days',
  },
  {
    techId: 'missile_tier_5',
    name: 'Strategic Missile Technology',
    description: 'Unlock Strategic Warheads (50% damage, single target)',
    category: ResearchCategory.MISSILE,
    tier: 5,
    prerequisites: ['missile_tier_4'],
    rpCost: 50000,
    unlocks: {
      warheadTypes: [WarheadType.STRATEGIC],
    },
    estimatedTime: '5 days',
  },
  {
    techId: 'missile_tier_6',
    name: 'Miniaturization Technology',
    description: 'Reduce component costs by 15%',
    category: ResearchCategory.MISSILE,
    tier: 6,
    prerequisites: ['missile_tier_5'],
    rpCost: 75000,
    unlocks: {},
    estimatedTime: '7 days',
  },
  {
    techId: 'missile_tier_7',
    name: 'Neutron Bomb Technology',
    description: 'Unlock Neutron Warheads (60% damage, preserves resources)',
    category: ResearchCategory.MISSILE,
    tier: 7,
    prerequisites: ['missile_tier_6'],
    rpCost: 100000,
    unlocks: {
      warheadTypes: [WarheadType.NEUTRON],
    },
    estimatedTime: '10 days',
  },
  {
    techId: 'missile_tier_8',
    name: 'MIRV Technology',
    description: 'Unlock Cluster Warheads (40%+20% damage, 5 targets)',
    category: ResearchCategory.MISSILE,
    tier: 8,
    prerequisites: ['missile_tier_7'],
    rpCost: 150000,
    unlocks: {
      warheadTypes: [WarheadType.CLUSTER],
    },
    estimatedTime: '15 days',
  },
  {
    techId: 'missile_tier_9',
    name: 'Advanced MIRV Systems',
    description: 'Cluster warheads can hit 10 targets (was 5)',
    category: ResearchCategory.MISSILE,
    tier: 9,
    prerequisites: ['missile_tier_8'],
    rpCost: 200000,
    unlocks: {},
    estimatedTime: '20 days',
  },
  {
    techId: 'missile_tier_10',
    name: 'Clan Buster Technology',
    description: 'Unlock Clan Buster Warheads (50%+30%+20% damage, entire clan)',
    category: ResearchCategory.MISSILE,
    tier: 10,
    prerequisites: ['missile_tier_9'],
    requiredClanLevel: 5,
    rpCost: 300000,
    unlocks: {
      warheadTypes: [WarheadType.CLAN_BUSTER],
    },
    estimatedTime: '30 days',
  },
];

// ============================================================================
// CONSTANTS - DEFENSE RESEARCH TRACK (10 TIERS)
// ============================================================================

export const DEFENSE_RESEARCH_TRACK: ResearchTech[] = [
  {
    techId: 'defense_tier_1',
    name: 'Basic Defense Systems',
    description: 'Unlock Basic Batteries (10% intercept chance)',
    category: ResearchCategory.DEFENSE,
    tier: 1,
    prerequisites: [],
    requiredLevel: 40,
    rpCost: 10000,
    unlocks: {
      batteryTypes: [BatteryType.BASIC],
    },
    estimatedTime: '1 day',
  },
  {
    techId: 'defense_tier_2',
    name: 'Local Radar Systems',
    description: 'Unlock Local Radar (30s warning, 50 tile range)',
    category: ResearchCategory.DEFENSE,
    tier: 2,
    prerequisites: ['defense_tier_1'],
    rpCost: 15000,
    unlocks: {
      radarLevels: [RadarLevel.LOCAL],
    },
    estimatedTime: '1.5 days',
  },
  {
    techId: 'defense_tier_3',
    name: 'Advanced Defense Systems',
    description: 'Unlock Advanced Batteries (25% intercept chance)',
    category: ResearchCategory.DEFENSE,
    tier: 3,
    prerequisites: ['defense_tier_2'],
    rpCost: 20000,
    unlocks: {
      batteryTypes: [BatteryType.ADVANCED],
    },
    estimatedTime: '2 days',
  },
  {
    techId: 'defense_tier_4',
    name: 'Battery Automation',
    description: 'Reduce battery cooldown by 20%',
    category: ResearchCategory.DEFENSE,
    tier: 4,
    prerequisites: ['defense_tier_3'],
    rpCost: 30000,
    unlocks: {},
    estimatedTime: '3 days',
  },
  {
    techId: 'defense_tier_5',
    name: 'Elite Defense Systems',
    description: 'Unlock Elite Batteries (40% intercept chance) + Regional Radar',
    category: ResearchCategory.DEFENSE,
    tier: 5,
    prerequisites: ['defense_tier_4'],
    rpCost: 50000,
    unlocks: {
      batteryTypes: [BatteryType.ELITE],
      radarLevels: [RadarLevel.REGIONAL],
    },
    estimatedTime: '5 days',
  },
  {
    techId: 'defense_tier_6',
    name: 'Hardened Installations',
    description: 'Batteries resist sabotage (50% damage reduction)',
    category: ResearchCategory.DEFENSE,
    tier: 6,
    prerequisites: ['defense_tier_5'],
    rpCost: 75000,
    unlocks: {},
    estimatedTime: '7 days',
  },
  {
    techId: 'defense_tier_7',
    name: 'Fortress Defense Systems',
    description: 'Unlock Fortress Batteries (60% intercept chance)',
    category: ResearchCategory.DEFENSE,
    tier: 7,
    prerequisites: ['defense_tier_6'],
    rpCost: 100000,
    unlocks: {
      batteryTypes: [BatteryType.FORTRESS],
    },
    estimatedTime: '10 days',
  },
  {
    techId: 'defense_tier_8',
    name: 'Global Surveillance Network',
    description: 'Unlock Global Radar (90s warning, unlimited range, sees stealth)',
    category: ResearchCategory.DEFENSE,
    tier: 8,
    prerequisites: ['defense_tier_7'],
    rpCost: 150000,
    unlocks: {
      radarLevels: [RadarLevel.GLOBAL],
    },
    estimatedTime: '15 days',
  },
  {
    techId: 'defense_tier_9',
    name: 'Directed Energy Weapons',
    description: 'Batteries gain +15% intercept chance',
    category: ResearchCategory.DEFENSE,
    tier: 9,
    prerequisites: ['defense_tier_8'],
    rpCost: 200000,
    unlocks: {},
    estimatedTime: '20 days',
  },
  {
    techId: 'defense_tier_10',
    name: 'AEGIS Defense System',
    description: 'Unlock AEGIS Batteries (80% intercept, partial damage reduction)',
    category: ResearchCategory.DEFENSE,
    tier: 10,
    prerequisites: ['defense_tier_9'],
    requiredClanLevel: 5,
    rpCost: 300000,
    unlocks: {
      batteryTypes: [BatteryType.AEGIS],
    },
    estimatedTime: '30 days',
  },
];

// ============================================================================
// CONSTANTS - INTELLIGENCE RESEARCH TRACK (10 TIERS)
// ============================================================================

export const INTELLIGENCE_RESEARCH_TRACK: ResearchTech[] = [
  {
    techId: 'spy_tier_1',
    name: 'Basic Espionage',
    description: 'Unlock Reconnaissance missions',
    category: ResearchCategory.INTELLIGENCE,
    tier: 1,
    prerequisites: [],
    requiredLevel: 40,
    rpCost: 10000,
    unlocks: {
      missionTypes: [MissionType.RECONNAISSANCE],
    },
    estimatedTime: '1 day',
  },
  {
    techId: 'spy_tier_2',
    name: 'Surveillance Techniques',
    description: 'Unlock Surveillance missions',
    category: ResearchCategory.INTELLIGENCE,
    tier: 2,
    prerequisites: ['spy_tier_1'],
    rpCost: 15000,
    unlocks: {
      missionTypes: [MissionType.SURVEILLANCE],
    },
    estimatedTime: '1.5 days',
  },
  {
    techId: 'spy_tier_3',
    name: 'Counter-Intelligence Operations',
    description: 'Unlock Counter-Intelligence missions',
    category: ResearchCategory.INTELLIGENCE,
    tier: 3,
    prerequisites: ['spy_tier_2'],
    rpCost: 20000,
    unlocks: {
      missionTypes: [MissionType.COUNTER_INTELLIGENCE],
      spyRanks: [SpyRank.OPERATIVE],
    },
    estimatedTime: '2 days',
  },
  {
    techId: 'spy_tier_4',
    name: 'Infiltration Training',
    description: 'Unlock Infiltration missions',
    category: ResearchCategory.INTELLIGENCE,
    tier: 4,
    prerequisites: ['spy_tier_3'],
    rpCost: 30000,
    unlocks: {
      missionTypes: [MissionType.INFILTRATION],
    },
    estimatedTime: '3 days',
  },
  {
    techId: 'spy_tier_5',
    name: 'Sabotage Techniques',
    description: 'Unlock Light Sabotage missions',
    category: ResearchCategory.INTELLIGENCE,
    tier: 5,
    prerequisites: ['spy_tier_4'],
    rpCost: 50000,
    unlocks: {
      missionTypes: [MissionType.SABOTAGE_LIGHT],
      spyRanks: [SpyRank.AGENT],
    },
    estimatedTime: '5 days',
  },
  {
    techId: 'spy_tier_6',
    name: 'Information Warfare',
    description: 'Unlock Intelligence Leak missions',
    category: ResearchCategory.INTELLIGENCE,
    tier: 6,
    prerequisites: ['spy_tier_5'],
    rpCost: 75000,
    unlocks: {
      missionTypes: [MissionType.INTELLIGENCE_LEAK],
    },
    estimatedTime: '7 days',
  },
  {
    techId: 'spy_tier_7',
    name: 'Advanced Sabotage',
    description: 'Unlock Heavy Sabotage missions',
    category: ResearchCategory.INTELLIGENCE,
    tier: 7,
    prerequisites: ['spy_tier_6'],
    rpCost: 100000,
    unlocks: {
      missionTypes: [MissionType.SABOTAGE_HEAVY],
    },
    estimatedTime: '10 days',
  },
  {
    techId: 'spy_tier_8',
    name: 'Corporate Espionage',
    description: 'Unlock Research Theft missions',
    category: ResearchCategory.INTELLIGENCE,
    tier: 8,
    prerequisites: ['spy_tier_7'],
    rpCost: 150000,
    unlocks: {
      missionTypes: [MissionType.THEFT],
      spyRanks: [SpyRank.VETERAN],
    },
    estimatedTime: '15 days',
  },
  {
    techId: 'spy_tier_9',
    name: 'Wetwork Operations',
    description: 'Unlock Assassination missions',
    category: ResearchCategory.INTELLIGENCE,
    tier: 9,
    prerequisites: ['spy_tier_8'],
    rpCost: 200000,
    unlocks: {
      missionTypes: [MissionType.ASSASSINATION],
    },
    estimatedTime: '20 days',
  },
  {
    techId: 'spy_tier_10',
    name: 'Total Warfare',
    description: 'Unlock Nuclear Sabotage missions (destroy ALL components)',
    category: ResearchCategory.INTELLIGENCE,
    tier: 10,
    prerequisites: ['spy_tier_9'],
    requiredClanLevel: 5,
    rpCost: 300000,
    unlocks: {
      missionTypes: [MissionType.SABOTAGE_NUCLEAR],
      spyRanks: [SpyRank.ELITE],
    },
    estimatedTime: '30 days',
  },
];

// ============================================================================
// AGGREGATED CONSTANTS
// ============================================================================

/**
 * All research techs combined
 */
export const ALL_RESEARCH_TECHS: ResearchTech[] = [
  ...MISSILE_RESEARCH_TRACK,
  ...DEFENSE_RESEARCH_TRACK,
  ...INTELLIGENCE_RESEARCH_TRACK,
];

/**
 * Research techs by category
 */
export const RESEARCH_BY_CATEGORY: Record<ResearchCategory, ResearchTech[]> = {
  [ResearchCategory.MISSILE]: MISSILE_RESEARCH_TRACK,
  [ResearchCategory.DEFENSE]: DEFENSE_RESEARCH_TRACK,
  [ResearchCategory.INTELLIGENCE]: INTELLIGENCE_RESEARCH_TRACK,
};

/**
 * Total RP required to unlock everything
 */
export const TOTAL_RP_REQUIRED = ALL_RESEARCH_TECHS.reduce(
  (sum, tech) => sum + tech.rpCost,
  0
); // 2,700,000 RP total (900k per track)

/**
 * RP required per category
 */
export const RP_BY_CATEGORY = {
  [ResearchCategory.MISSILE]: 900000,
  [ResearchCategory.DEFENSE]: 900000,
  [ResearchCategory.INTELLIGENCE]: 900000,
} as const;

// ============================================================================
// TYPE GUARDS & UTILITIES
// ============================================================================

/**
 * Check if tech ID is valid
 */
export function isValidTechId(techId: string): boolean {
  return ALL_RESEARCH_TECHS.some(tech => tech.techId === techId);
}

/**
 * Get tech by ID
 */
export function getTechById(techId: string): ResearchTech | undefined {
  return ALL_RESEARCH_TECHS.find(tech => tech.techId === techId);
}

/**
 * Get techs by category
 */
export function getTechsByCategory(category: ResearchCategory): ResearchTech[] {
  return RESEARCH_BY_CATEGORY[category];
}

/**
 * Get prerequisite chain for a tech
 */
export function getPrerequisiteChain(techId: string): string[] {
  const tech = getTechById(techId);
  if (!tech || tech.prerequisites.length === 0) return [];
  
  const chain: string[] = [];
  for (const prereq of tech.prerequisites) {
    chain.push(prereq);
    chain.push(...getPrerequisiteChain(prereq));
  }
  
  return Array.from(new Set(chain)); // Remove duplicates
}

/**
 * Check if player has prerequisites for a tech
 */
export function hasPrerequisites(
  techId: string,
  completedTechs: string[]
): boolean {
  const tech = getTechById(techId);
  if (!tech) return false;
  
  return tech.prerequisites.every(prereq => completedTechs.includes(prereq));
}

/**
 * Get next available techs for a player
 */
export function getAvailableTechs(completedTechs: string[]): ResearchTech[] {
  return ALL_RESEARCH_TECHS.filter(tech => {
    // Skip already completed
    if (completedTechs.includes(tech.techId)) return false;
    
    // Check prerequisites
    return hasPrerequisites(tech.techId, completedTechs);
  });
}

// ============================================================================
// IMPLEMENTATION NOTES
// ============================================================================
/**
 * 1. Research Tracks:
 *    - MISSILE: 10 tiers, 900k RP total
 *    - DEFENSE: 10 tiers, 900k RP total
 *    - INTELLIGENCE: 10 tiers, 900k RP total
 *    - TOTAL: 2.7M RP to unlock everything
 * 
 * 2. Tier 10 Requirements:
 *    - Clan Buster: 300k RP + Clan Level 5
 *    - AEGIS: 300k RP + Clan Level 5
 *    - Nuclear Sabotage: 300k RP + Clan Level 5
 *    (High-end content requires clan membership)
 * 
 * 3. RP Cost Progression:
 *    - Tier 1: 10k RP (1 day with full auto-farm)
 *    - Tier 5: 50k RP (5 days)
 *    - Tier 10: 300k RP (30 days)
 *    - Total: 2.7M RP (270 days to unlock everything)
 * 
 * 4. Integration with Existing System:
 *    - Reuses /lib/xpService.ts spendResearchPoints() function
 *    - Pattern: await spendResearchPoints(userId, tech.rpCost, 'WMD Research: ${tech.name}')
 *    - No changes to existing RP system needed
 * 
 * 5. Parallel Progression:
 *    - Players can research all 3 tracks simultaneously
 *    - No cross-track dependencies (missile â‰  defense â‰  intel)
 *    - Encourages specialization or balanced approach
 * 
 * 6. Clan Research Bonuses:
 *    - Clan perks can reduce RP costs by 10-20%
 *    - Clan research can unlock shared techs
 *    - High-tier techs require clan membership
 */

// ============================================================================
// END OF FILE
// ============================================================================


@@@END@@@
